<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>C5X Pro Terminal</title>
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon.png">
    <meta name="theme-color" content="#050708">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700&family=Roboto+Mono:wght@500;700&family=Inter:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --bg: #050708; --card: #12151a; --border: #2d3339;
            --accent: #3498db; --green: #0ecb81; --red: #f6465d;
            --text: #eaecef; --text-dim: #848e9c;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
        body { background: var(--bg); color: var(--text); height: 100vh; display: flex; flex-direction: column; overflow: hidden; }

        /* HEADER */
        header { 
            padding: 12px 16px; border-bottom: 1px solid var(--border); 
            display: flex; justify-content: space-between; align-items: center; background: var(--card);
        }
        .logo { font-family: 'Orbitron', sans-serif; color: var(--accent); font-size: 18px; letter-spacing: 1px; }
        #btcPrice { font-family: 'Roboto Mono', monospace; font-weight: 700; color: var(--green); }

        /* SLOTS */
        .slots-container { 
            display: flex; overflow-x: auto; padding: 10px; gap: 8px; 
            background: var(--bg); border-bottom: 1px solid var(--border);
        }
        .slot-pill {
            padding: 6px 14px; border-radius: 6px; background: var(--card);
            border: 1px solid var(--border); font-size: 11px; font-weight: 700;
            color: var(--text-dim); cursor: pointer; white-space: nowrap;
        }
        .slot-pill.active { border-color: var(--accent); color: var(--accent); background: rgba(52, 152, 219, 0.1); }

        /* CHART AREA */
        #chart-wrapper { position: relative; height: 35vh; width: 100%; background: #000; border-bottom: 1px solid var(--border); }
        .tf-bar { 
            position: absolute; top: 10px; left: 10px; z-index: 10; 
            display: flex; gap: 5px; background: rgba(0,0,0,0.6); padding: 4px; border-radius: 4px;
        }
        .tf-btn { border: none; background: transparent; color: #fff; font-size: 10px; padding: 4px 8px; cursor: pointer; border-radius: 3px; }
        .tf-btn.active { background: var(--accent); }

        /* INPUTS AREA */
        main { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 12px; }
        .input-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }
        .field { background: var(--card); padding: 8px 12px; border-radius: 8px; border: 1px solid var(--border); }
        .field label { display: block; font-size: 9px; color: var(--text-dim); text-transform: uppercase; margin-bottom: 4px; font-weight: 700; }
        .field input { width: 100%; background: transparent; border: none; color: #fff; font-family: 'Roboto Mono'; font-size: 15px; outline: none; }

        /* LEVELS */
        .level-row { 
            display: flex; justify-content: space-between; align-items: center; 
            padding: 10px; background: var(--card); border-radius: 8px; margin-bottom: 6px;
            border-left: 3px solid transparent; transition: 0.2s;
        }
        .level-row.active { border-left-color: var(--green); background: rgba(14, 203, 129, 0.05); }
        .lvl-info .name { font-size: 10px; color: var(--text-dim); display: block; }
        .lvl-info .price { font-family: 'Roboto Mono'; font-size: 14px; font-weight: 700; }
        .lvl-cap { font-family: 'Roboto Mono'; font-size: 12px; color: var(--text-dim); }
        
        /* CHECKBOX */
        .check-box { width: 22px; height: 22px; border-radius: 4px; border: 2px solid var(--border); display: flex; align-items: center; justify-content: center; cursor: pointer; }
        .check-box.on { background: var(--green); border-color: var(--green); color: #000; font-weight: bold; }

        /* FOOTER SUMMARY */
        .summary-bar { 
            background: var(--card); border-top: 1px solid var(--border); 
            padding: 15px; display: grid; grid-template-columns: 1fr 1fr; gap: 15px;
        }
        .sum-block .lab { font-size: 10px; color: var(--text-dim); margin-bottom: 2px; }
        .sum-block .val { font-family: 'Roboto Mono'; font-size: 18px; font-weight: 700; color: var(--accent); }

        .btn-group { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; padding: 0 15px 15px; }
        .btn { padding: 12px; border-radius: 8px; border: none; font-weight: 700; font-size: 11px; cursor: pointer; text-transform: uppercase; }
        .btn-blue { background: var(--accent); color: white; }
        .btn-red { background: var(--red); color: white; }
        .btn-outline { background: transparent; border: 1px solid var(--border); color: var(--text-dim); }

        #toast { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: var(--accent); padding: 8px 20px; border-radius: 20px; font-size: 12px; z-index: 1000; opacity: 0; transition: 0.3s; pointer-events: none; }
    </style>
</head>
<body>

    <header>
        <div class="logo">C5X PRO</div>
        <div id="btcPrice">--.--</div>
    </header>

    <div class="slots-container" id="slotsBar"></div>

    <div id="chart-wrapper">
        <div class="tf-bar">
            <button class="tf-btn" onclick="setTF('1')">1m</button>
            <button class="tf-btn active" onclick="setTF('15')">15m</button>
            <button class="tf-btn" onclick="setTF('60')">1h</button>
            <button class="tf-btn" onclick="setTF('D')">1D</button>
        </div>
        <div id="tv_chart" style="height: 100%;"></div>
    </div>

    <main>
        <div class="input-grid">
            <div class="field">
                <label>Activo / Par</label>
                <input type="text" id="coinName" placeholder="BTC3L" oninput="handleCoinChange(this.value)">
            </div>
            <div class="field">
                <label>Precio Entrada</label>
                <input type="number" id="basePrice" inputmode="decimal" placeholder="0.00" oninput="calc()">
            </div>
            <div class="field">
                <label>Capital Base ($)</label>
                <input type="number" id="baseCap" inputmode="decimal" placeholder="10.00" oninput="calc()">
            </div>
            <div class="field">
                <label>% Caída</label>
                <input type="number" id="dropPct" inputmode="decimal" placeholder="5.0" oninput="calc()">
            </div>
        </div>

        <div id="levelsList"></div>
    </main>

    <div class="summary-bar">
        <div class="sum-block">
            <div class="lab">TOTAL INVERTIDO</div>
            <div class="val" id="totalInv">$0.00</div>
        </div>
        <div class="sum-block">
            <div class="lab">PRECIO PROMEDIO</div>
            <div class="val" id="avgPrice" style="color:var(--green)">$0.00</div>
        </div>
    </div>

    <div class="btn-group">
        <button class="btn btn-outline" onclick="exportData()">Backup</button>
        <button class="btn btn-red" onclick="closeOperation()">Cerrar Operación</button>
    </div>

    <div id="toast">Copiado</div>

    <script src="https://s3.tradingview.com/tv.js"></script>
    <script>
        let slots = JSON.parse(localStorage.getItem('c5x_v18_slots')) || Array.from({length:8}, () => ({
            name: 'BTC3L', basePrice: '', baseCap: '10', dropPct: '5', buys: []
        }));
        let activeIdx = 0;
        let activeTF = '15';

        function init() {
            renderSlots();
            loadSlot(0);
            connectBinance();
        }

        function loadSlot(idx) {
            activeIdx = idx;
            const s = slots[idx];
            document.getElementById('coinName').value = s.name;
            document.getElementById('basePrice').value = s.basePrice;
            document.getElementById('baseCap').value = s.baseCap;
            document.getElementById('dropPct').value = s.dropPct;
            
            updateChart(s.name);
            renderSlots();
            calc();
        }

        function handleCoinChange(val) {
            slots[activeIdx].name = val.toUpperCase();
            renderSlots();
            updateChart(val);
            save();
        }

        function updateChart(coin) {
            const symbol = coin.includes('USDT') ? coin : `GATEIO:${coin.replace('3L','').replace('3S','')}USDT`;
            new TradingView.widget({
                "autosize": true,
                "symbol": symbol,
                "interval": activeTF,
                "timezone": "Etc/UTC",
                "theme": "dark",
                "style": "1",
                "locale": "es",
                "toolbar_bg": "#050708",
                "enable_publishing": false,
                "hide_top_toolbar": true,
                "hide_legend": true,
                "save_image": false,
                "container_id": "tv_chart",
                "backgroundColor": "#050708",
                "gridColor": "rgba(42, 46, 57, 0.1)"
            });
        }

        function setTF(tf) {
            activeTF = tf;
            document.querySelectorAll('.tf-btn').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');
            updateChart(slots[activeIdx].name);
        }

        function calc() {
            const s = slots[activeIdx];
            s.basePrice = document.getElementById('basePrice').value;
            s.baseCap = document.getElementById('baseCap').value;
            s.dropPct = document.getElementById('dropPct').value;

            const bp = parseFloat(s.basePrice) || 0;
            const bc = parseFloat(s.baseCap) || 0;
            const dp = parseFloat(s.dropPct) || 0;

            const list = document.getElementById('levelsList');
            list.innerHTML = '';

            let tInv = 0, tTokens = 0;

            for(let i=0; i<6; i++) {
                const p = i === 0 ? bp : bp * (1 - (dp * i / 100));
                const c = bc * Math.pow(2, i);
                const isOn = s.buys.includes(i);

                if(isOn && bp > 0) { tInv += c; tTokens += (c/p); }

                if(bp > 0) {
                    const div = document.createElement('div');
                    div.className = `level-row ${isOn ? 'active' : ''}`;
                    div.innerHTML = `
                        <div class="lvl-info" onclick="copy('${p.toFixed(4)}')">
                            <span class="name">${i === 0 ? 'ENTRY' : 'DCA '+i}</span>
                            <span class="price">${p.toFixed(4)}</span>
                        </div>
                        <div class="lvl-cap">$${c.toFixed(2)}</div>
                        <div class="check-box ${isOn ? 'on' : ''}" onclick="toggleLvl(${i})">${isOn ? '✓' : ''}</div>
                    `;
                    list.appendChild(div);
                }
            }

            const avg = tTokens > 0 ? tInv / tTokens : 0;
            document.getElementById('totalInv').textContent = `$${tInv.toFixed(2)}`;
            document.getElementById('avgPrice').textContent = `$${avg.toFixed(4)}`;
            save();
        }

        function toggleLvl(i) {
            const buys = slots[activeIdx].buys;
            slots[activeIdx].buys = buys.includes(i) ? buys.filter(x => x !== i) : [...buys, i];
            calc();
        }

        function renderSlots() {
            const bar = document.getElementById('slotsBar');
            bar.innerHTML = slots.map((s, i) => `
                <div class="slot-pill ${i === activeIdx ? 'active' : ''}" onclick="loadSlot(${i})">
                    ${s.name || 'Slot '+(i+1)}
                </div>
            `).join('');
        }

        function connectBinance() {
            const ws = new WebSocket('wss://stream.binance.com:9443/ws/btcusdt@ticker');
            ws.onmessage = (e) => {
                const data = JSON.parse(e.data);
                const p = parseFloat(data.c);
                const el = document.getElementById('btcPrice');
                el.textContent = `BTC $${p.toLocaleString()}`;
                el.style.color = data.P.startsWith('-') ? 'var(--red)' : 'var(--green)';
            };
        }

        function copy(val) {
            navigator.clipboard.writeText(val);
            const t = document.getElementById('toast');
            t.textContent = "Copiado: " + val;
            t.style.opacity = 1;
            setTimeout(() => t.style.opacity = 0, 1500);
        }

        function save() { localStorage.setItem('c5x_v18_slots', JSON.stringify(slots)); }

        function exportData() {
            const blob = new Blob([JSON.stringify(slots)], {type: 'application/json'});
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = 'C5X_Backup.json';
            a.click();
        }

        function closeOperation() {
            if(confirm('¿Cerrar y limpiar slot?')) {
                slots[activeIdx].buys = [];
                slots[activeIdx].basePrice = '';
                loadSlot(activeIdx);
            }
        }

        window.onload = init;
    </script>
</body>
</html>
