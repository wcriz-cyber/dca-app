<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>C5X - V19.4 DIAGNOSTIC</title>
    <meta name="theme-color" content="#0b0e11">
    
    <link rel="manifest" href="manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="icon" type="image/png" href="icon.png">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Chakra+Petch:wght@500;700&family=Inter:wght@500;700;800&family=JetBrains+Mono:wght@500;700;800&family=Orbitron:wght@600;900&family=Rajdhani:wght@500;600;700;800&display=swap" rel="stylesheet">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <script src="https://s3.tradingview.com/tv.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>

    <style>
        /* --- ESTILOS (V19 ORIGINAL) --- */
        :root {
            --bg: #0b0e11; --surface: #151a21; --surface-glass: rgba(21, 26, 33, 0.98);
            --card-bg: rgba(255, 255, 255, 0.03); --text-primary: #eaecef; --text-secondary: #848e9c;
            --text-tertiary: #5e6673; --brand: #3b82f6; --long: #0ecb81; --short: #f6465d;
            --warning: #f0b90b; --danger: #cf304a; --border: #2b3139; --radius-m: 16px;
            --gold-fixed: #f0b90b; --chart-bg: #000000; 
            --safe-top: env(safe-area-inset-top, 20px); --safe-bottom: env(safe-area-inset-bottom, 20px);
            --skeleton: rgba(255,255,255,0.05);
            --font-main: 'Rajdhani', sans-serif; --font-num: 'JetBrains Mono', monospace; --font-head: 'Orbitron', sans-serif;
        }

        /* TEMAS PRESERVADOS */
        body.theme-nature { --bg: #021208; --surface: #0a1f12; --brand: #2ecc71; --border: #143822; }
        body.theme-ocean { --bg: #030712; --surface: #0f172a; --brand: #3b82f6; --border: #1e293b; }
        body.theme-sunset { --bg: #1c0802; --surface: #2b1106; --brand: #f97316; --border: #52200b; }
        body.theme-cyber { --bg: #000000; --surface: #111111; --brand: #fbbf24; --border: #333333; }
        body.theme-amethyst { --bg: #10041c; --surface: #1e0b33; --brand: #d946ef; --border: #4c1d6e; }
        body.light-mode { --bg: #f8fafc !important; --surface: #ffffff !important; --card-bg: #f1f5f9 !important; --text-primary: #0f172a !important; --border: #e2e8f0 !important; }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        body { font-family: var(--font-main); font-weight: 600; background: var(--bg); color: var(--text-primary); padding-top: var(--safe-top); padding-bottom: calc(20px + var(--safe-bottom)); overflow-x: hidden; user-select: none; font-size: 16px; overscroll-behavior-y: none; transition: background 0.3s ease; }

        .anim-click:active { transform: scale(0.95); }
        .anim-pulse { animation: pulse-ring 2s infinite; }
        @keyframes pulse-ring { 0% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.4); } 70% { box-shadow: 0 0 0 6px rgba(59, 130, 246, 0); } 100% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0); } }
        @keyframes shimmer { 0% { background-position: -200% 0; } 100% { background-position: 200% 0; } }
        
        .skeleton-box { background: linear-gradient(90deg, var(--skeleton) 25%, var(--card-bg) 50%, var(--skeleton) 75%); background-size: 200% 100%; animation: shimmer 1.5s infinite; border-radius: 4px; color: transparent !important; }
        
        .fixed-header { position: fixed; top: 0; left: 0; width: 100%; z-index: 1000; background: var(--surface-glass); backdrop-filter: blur(12px); border-bottom: 1px solid var(--border); padding-top: var(--safe-top); }
        .app-header { display: flex; justify-content: space-between; align-items: center; height: 50px; padding: 0 16px; max-width: 800px; margin: 0 auto; }
        .brand-text { font-family: var(--font-head); font-weight: 900; font-size: 24px; color: var(--brand); }
        
        .ticker-container { position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%); display: flex; align-items: center; gap: 8px; }
        .ticker-pill { display: flex; align-items: center; gap: 10px; background: rgba(255,255,255,0.03); border: 1px solid var(--border); padding: 4px 12px; border-radius: 24px; height: 32px; }
        .ticker-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--text-secondary); }
        .ticker-dot.pulse { animation: pulse-ring 1.5s infinite; }
        .ticker-price { font-family: var(--font-num); font-weight: 800; font-size: 16px; }

        .pin-btn { width: 30px; height: 30px; border-radius: 50%; background: transparent; display: flex; align-items: center; justify-content: center; color: var(--text-secondary); border:none;}
        .pin-btn.pinned { color: var(--brand); background: rgba(59, 130, 246, 0.1); }

        .content-spacer { margin-top: 92px; max-width: 800px; margin-left: auto; margin-right: auto; padding: 0 4px; }
        .app-section { display: none; opacity: 0; transition: opacity 0.2s ease; }
        .app-section.active { display: block; opacity: 1; }

        .tf-bar { display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px; padding: 4px 12px 8px 12px; border-bottom: 1px solid var(--border); }
        .tf-btn { background: transparent; border: none; color: var(--text-tertiary); padding: 4px 0; font-size: 12px; font-weight: 700; border-radius: 8px; }
        .tf-btn.active { color: var(--brand); background: rgba(59, 130, 246, 0.1); }

        .slot-nav { display: grid; grid-template-columns: repeat(5, 1fr); gap: 6px; padding: 8px 10px; position: sticky; top: calc(90px + var(--safe-top)); z-index: 900; background: var(--bg); border-bottom: 1px solid var(--border); margin-bottom: 10px; }
        .slot-card { background: transparent; color: var(--text-tertiary); padding: 10px 0; text-align: center; font-size: 14px; font-weight: 700; border-radius: 8px; position: relative; }
        .slot-card.active { color: var(--text-primary); background: rgba(255,255,255,0.02); font-weight: 800; }
        .slot-card.active::after { content: ''; position: absolute; bottom: 0; left: 25%; right: 25%; height: 3px; background: var(--brand); border-radius: 3px 3px 0 0; }
        .slot-card.has-profit:not(.active)::before { content: '‚Ä¢'; position: absolute; bottom: 2px; left: 0; right: 0; color: var(--long); font-size: 14px; line-height: 0; }

        .chart-wrapper { height: 280px; background: var(--chart-bg); margin: 0 10px; border-radius: var(--radius-m); border: 1px solid var(--border); overflow: hidden; position: relative; }
        .chart-wrapper.fullscreen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 5000; margin: 0; border-radius: 0; border: none; padding-top: var(--safe-top); }
        .chart-fs-btn { position: absolute; bottom: 10px; right: 10px; z-index: 20; width: 30px; height: 30px; background: rgba(128,128,128,0.2); border-radius: 6px; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(4px); color:#fff; }

        .controls-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; padding: 10px; }
        .input-group { background: var(--card-bg); border: 1px solid var(--border); border-radius: var(--radius-m); padding: 8px; text-align: center; }
        .input-label { font-size: 10px; color: var(--text-secondary); font-weight: 700; text-transform: uppercase; display: block; margin-bottom: 2px; }
        .input-field { width: 100%; background: transparent; border: none; color: var(--text-primary); font-family: var(--font-num); font-size: 15px; font-weight: 700; text-align: center; }

        .dashboard-card { background: var(--surface); border: 1px solid var(--border); border-radius: 24px; margin: 0 10px 15px; padding: 15px 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); position: relative; overflow: hidden; }
        .dashboard-card::before { content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 4px; background: linear-gradient(90deg, var(--brand), var(--long)); }
        
        /* NEW WALLET BAR */
        .wallet-bar { display:flex; justify-content:space-between; align-items:center; background:rgba(0,0,0,0.2); padding:8px 12px; border-radius:12px; margin-bottom:15px; border:1px solid var(--border); }
        .wallet-label { display:flex; align-items:center; gap:6px; font-size:11px; font-weight:700; color:var(--text-secondary); letter-spacing:1px; }
        .wallet-amount { font-family:var(--font-num); font-weight:800; color:var(--text-primary); font-size:15px; }

        .radar-ticker-large { background: rgba(59, 130, 246, 0.08); border: 1px solid rgba(59, 130, 246, 0.3); border-radius: 16px; padding: 20px 12px; text-align: center; margin-bottom: 20px; position: relative; }
        .radar-status-dot { position: absolute; top: 12px; right: 12px; width: 8px; height: 8px; border-radius: 50%; background: var(--text-tertiary); box-shadow: 0 0 5px rgba(0,0,0,0.5); }
        .radar-status-dot.online { background: var(--long); box-shadow: 0 0 8px var(--long); }
        .radar-status-dot.offline { background: var(--danger); box-shadow: 0 0 8px var(--danger); }
        
        .main-target-box { text-align: center; margin-bottom: 10px; }
        .target-price { font-family: var(--font-num); font-size: 38px; font-weight: 800; color: var(--gold-fixed); line-height: 1; letter-spacing: -1.5px; }

        .control-row-three { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; gap: 10px; padding: 0 5px; }
        .strat-display { flex: 1; text-align: center; font-family: var(--font-head); font-weight: 900; font-size: 11px; color: var(--gold-fixed) !important; letter-spacing: 1px; padding: 12px; border-radius: 12px; border: 1px solid transparent; }
        .icon-sq-btn { width: 42px; height: 42px; border-radius: 12px; background: rgba(255,255,255,0.03); border: 1px solid var(--border); display: flex; align-items: center; justify-content: center; color: var(--text-secondary); cursor: pointer; }
        .icon-sq-btn.locked { color: var(--danger); border-color: var(--danger); background: rgba(207, 48, 74, 0.1); }

        .stats-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 6px; }
        .stat-box { background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.05); border-radius: 12px; padding: 10px 4px; text-align: center; }
        .stat-label { font-size: 10px; color: var(--text-tertiary); font-weight: 700; text-transform: uppercase; margin-bottom: 4px; }
        .stat-value { font-family: var(--font-num); font-size: 15px; font-weight: 600; color: var(--text-primary); }

        .levels-container { padding: 0 10px; display: flex; flex-direction: column; gap: 8px; padding-bottom: 40px; }
        .unified-card { background: var(--card-bg); border: 1px solid var(--border); border-radius: var(--radius-m); padding: 0 12px; display: grid; grid-template-columns: 44px 1fr auto; gap: 12px; align-items: center; cursor: pointer; min-height: 72px; position: relative; overflow: hidden; }
        .unified-card.active { border-color: var(--brand); background: rgba(59, 130, 246, 0.08); }
        .u-index { width: 36px; height: 36px; border-radius: 50%; background: rgba(59, 130, 246, 0.1); border: 1px solid var(--brand); display: flex; align-items: center; justify-content: center; font-family: var(--font-head); font-weight: 900; color: var(--brand); font-size: 12px; }
        .u-title { font-family: var(--font-num); font-size: 21px; font-weight: 700; color: var(--text-primary); line-height: 1; }
        .u-val-primary { font-family: var(--font-num); font-size: 15px; font-weight: 800; color: var(--long); }
        .liquidate-card { background: var(--danger); color: #fff; justify-content: center; font-family: var(--font-head); font-weight: 900; letter-spacing: 1px; box-shadow: 0 4px 15px rgba(207, 48, 74, 0.4); border: none; padding: 20px; border-radius: var(--radius-m); margin-top: 10px; cursor: pointer; display: flex; align-items: center; gap:10px; }

        #toast { visibility: hidden; width: 90%; max-width: 400px; background-color: var(--surface); border: 1px solid var(--border); color: var(--text-primary); text-align: center; border-radius: 12px; padding: 16px; position: fixed; z-index: 9999; left: 50%; top: -100px; transform: translateX(-50%); font-weight: 700; font-size: 14px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); transition: top 0.4s, opacity 0.4s; opacity: 0; }
        #toast.show { top: calc(10px + var(--safe-top)); visibility: visible; opacity: 1; }
        #toast.alert-mode { background-color: rgba(207, 48, 74, 0.98); color: #fff; border: 1px solid #ff4d4d; }
        #toast.success-mode { background-color: rgba(14, 203, 129, 0.98); color: #fff; border: 1px solid #0ecb81; }

        #navModal, .generic-modal { position: fixed; inset: 0; background: rgba(0,0,0,0.85); backdrop-filter: blur(8px); z-index: 2000; display: none; justify-content: center; align-items: center; padding-top: var(--safe-top); }
        .nav-content { background: var(--surface); width: 85%; max-width: 320px; border-radius: 30px; padding: 35px 25px; border: 1px solid var(--border); display: flex; flex-direction: column; gap: 15px; }
        .nav-item { display: flex; align-items: center; padding: 20px; border-radius: 18px; background: rgba(255,255,255,0.02); border: 1px solid var(--border); cursor: pointer; }
        .nav-item.selected { background: rgba(59, 130, 246, 0.1); border-color: var(--brand); }
        
        .modal-box { background: var(--surface); width: 85%; max-width: 300px; padding: 25px; border-radius: 20px; border: 1px solid var(--border); text-align: center; }
        .trade-details { background: rgba(0,0,0,0.2); padding: 10px; border-radius: 8px; margin-bottom: 15px; font-family: var(--font-num); font-size: 13px; text-align: left; }
        .btn-modal { width: 100%; padding: 12px; border-radius: 10px; border: none; font-weight: 700; margin-bottom: 8px; cursor: pointer; }
        .btn-confirm { background: var(--brand); color: #fff; }
        .btn-cancel { background: transparent; color: var(--text-secondary); }

        .setting-section-title { padding: 5px 5px; font-family: var(--font-head); color: var(--text-secondary); font-size: 12px; font-weight: 900; letter-spacing: 1px; display:flex; align-items:center; gap:8px; margin-top: 5px; }
        .setting-card-item { background: var(--card-bg); border: 1px solid var(--border); border-radius: var(--radius-m); padding: 16px; margin-bottom:8px; display:flex; flex-direction:column; gap:10px; }
        .setting-label { font-size: 11px; color: var(--text-secondary); font-weight: 700; text-transform: uppercase; }
        .setting-input { width: 100%; background: transparent; border: none; color: var(--text-primary); font-family: var(--font-num); font-size: 18px; font-weight: 700; border-bottom:1px solid var(--border); }
        .btn-save-mini { background: var(--brand); color: #fff; border: none; width: 44px; height: 44px; border-radius: 12px; display: flex; align-items: center; justify-content: center; cursor: pointer; flex-shrink: 0; }
        
        /* ETF MONITOR */
        .etf-search-box { position: relative; margin: 5px 10px 10px 10px; } 
        .etf-search-input { width: 100%; background: var(--card-bg); border: 1px solid var(--border); padding: 14px 14px 14px 45px; border-radius: var(--radius-m); color: var(--text-primary); font-family: var(--font-head); font-weight: 700; font-size: 14px; }
        .etf-change-badge { padding: 6px 12px; border-radius: 8px; font-size: 16px; font-weight: 800; font-family: var(--font-num); }
        .etf-up { background: rgba(14, 203, 129, 0.15); color: var(--long); }
        .etf-down { background: rgba(246, 70, 93, 0.15); color: var(--short); }

        /* LOG */
        #logGrid { max-height: 395px; overflow-y: auto; }
        .chart-box { height: 160px; display: flex; align-items: flex-end; justify-content: space-between; gap: 4px; padding-bottom: 5px; border-bottom: 1px solid var(--border); margin-bottom: 10px; position: relative; }
        .chart-bar { flex: 1; min-width: 4px; border-radius: 2px 2px 0 0; position: relative; transition: height 0.5s ease; animation: grow-up 0.5s ease-out; }
        .chart-bar.win { background: linear-gradient(to top, rgba(16,203,129,0.3), var(--long)); }
        .chart-bar.loss { background: linear-gradient(to top, rgba(246,70,93,0.3), var(--short)); }
        
        .theme-grid-container { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; padding-bottom: 5px; }
        .theme-card { background: rgba(255,255,255,0.03); border: 2px solid var(--border); border-radius: 12px; display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; padding: 15px 5px; }
        .theme-card.active { border-color: var(--brand); background: rgba(59, 130, 246, 0.1); }
        .theme-preview-bubble { width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-bottom: 8px; font-size: 16px; box-shadow: 0 4px 10px rgba(0,0,0,0.3); border: 2px solid rgba(255,255,255,0.1); }
    </style>
</head>
<body onload="init()">

    <audio id="alertSound" preload="auto" src="data:audio/wav;base64,UklGRl9vT1BXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YU"></audio>
    <div id="toast">Notificaci√≥n</div>

    <div id="navModal" onclick="if(event.target===this) closeMenuViaButton()">
        <div class="nav-content">
            <div class="nav-title">MEN√ö C5X</div>
            <div class="nav-item selected anim-click" id="nav-operate" onclick="switchView('operate')"><div class="nav-text">OPERAR</div></div>
            <div class="nav-item anim-click" id="nav-etf" onclick="switchView('etf')"><div class="nav-text">MONITOR ETF</div></div>
            <div class="nav-item anim-click" id="nav-log" onclick="switchView('log')"><div class="nav-text">BIT√ÅCORA</div></div>
            <div class="nav-item anim-click" id="nav-settings" onclick="switchView('settings')"><div class="nav-text">AJUSTES</div></div>
            <button class="btn-cancel" onclick="closeMenuViaButton()">CERRAR MEN√ö</button>
        </div>
    </div>

    <div class="fixed-header">
        <header class="app-header">
            <div class="brand-btn anim-click" onclick="openMenuViaButton()">
                <span class="brand-text">C5X</span>
            </div>
            <div class="ticker-container"><div class="ticker-pill anim-click" onclick="viewTickerChart(event)"><div class="ticker-dot" id="t-dot"></div><span class="ticker-price" id="t-sym">BTC</span><span class="ticker-price" id="t-price">...</span></div></div>
            <button class="pin-btn anim-click" onclick="toggleTheme()" id="themeBtn">üåô</button>
        </header>
        <div class="tf-bar" id="tfBarContainer">
            <button class="tf-btn anim-click" data-tf="15" onclick="updateTF('15', this)">15M</button><button class="tf-btn anim-click" data-tf="30" onclick="updateTF('30', this)">30M</button><button class="tf-btn anim-click" data-tf="60" onclick="updateTF('60', this)">1H</button><button class="tf-btn anim-click" data-tf="240" onclick="updateTF('240', this)">4H</button><button class="tf-btn anim-click" data-tf="D" onclick="updateTF('D', this)">1D</button>
        </div>
    </div>

    <div class="content-spacer">
        <div id="section-operate" class="app-section active">
            <nav id="slotNav" class="slot-nav"></nav>
            <div id="tv_chart" class="chart-wrapper"><div class="chart-fs-btn anim-click" onclick="toggleFullscreenChart(event)">‚õ∂</div></div>
            
            <div class="controls-grid">
                <div class="input-group"><label class="input-label">Moneda</label><input type="text" id="coinInput" class="input-field" placeholder="BTC" oninput="forceCaps(this)" onblur="updateCoin()"></div>
                <div class="input-group"><label class="input-label">Base</label><input type="number" id="baseInput" class="input-field" oninput="calculate()" step="any" placeholder="0.00"></div>
                <div class="input-group"><label class="input-label">Capital</label><input type="number" id="capitalInput" class="input-field" readonly></div>
            </div>
            
            <div class="dashboard-card" id="dashMain">
                <div class="wallet-bar">
                    <div class="wallet-label">
                        <svg width="14" height="14" style="color:var(--brand)"><rect x="2" y="4" width="20" height="16" rx="2"/><path d="M7 15h0M2 10h20"/><path d="M7 15h0M2 10h20M7 15h0M2 10h20"/></svg>
                        <span>SALDO GATE.IO</span>
                    </div>
                    <span id="dashWallet" class="wallet-amount">...</span>
                </div>

                <div id="radarTickerContainer" class="radar-ticker-large anim-pulse" onclick="switchView('etf', false)">
                    <div id="radarStatus" class="radar-status-dot offline"></div>
                    <div class="radar-title">RADAR DE OPORTUNIDADES</div>
                    <div id="radarValue" class="radar-content"><span class="skeleton-text skeleton-box" style="width:120px; height:20px;"></span></div>
                </div>
                
                <div class="main-target-box"><div style="font-size:10px; color:var(--text-secondary); letter-spacing:1px; margin-bottom:5px;">OBJETIVO SALIDA</div><div class="target-price" id="resTarget">0.0000</div></div>
                
                <div class="control-row-three">
                    <div class="icon-sq-btn anim-click" id="lockBtn" onclick="toggleLock()">üîí</div>
                    <div class="strat-display anim-click" id="stratBadge" onclick="rotateDash()">NORMAL</div>
                    <div class="icon-sq-btn anim-click" onclick="cleanSlotOnly()">üóëÔ∏è</div>
                </div>
                
                <div class="stats-grid">
                    <div class="stat-box"><div class="stat-label">Promedio</div><div class="stat-value" id="resAvg">0.00</div></div>
                    <div class="stat-box"><div class="stat-label">Ganancia</div><div class="stat-value" id="resProfit" style="color:var(--long)">$0.00</div></div>
                    <div class="stat-box"><div class="stat-label">Inversi√≥n</div><div class="stat-value" id="resInv">$0.00</div></div>
                </div>
            </div>
            
            <main id="levelsGrid" class="levels-container"></main>
        </div>

        <div id="section-etf" class="app-section">
            <div class="etf-search-box"><input type="text" class="etf-search-input" placeholder="BUSCAR TOKEN (Ej: BTC, SUI)" oninput="filterETFs(this.value)"></div>
            <div id="etfGrid" class="levels-container"></div>
        </div>

        <div id="section-log" class="app-section">
            <div class="log-header-bar"><div class="log-title">BIT√ÅCORA</div>
                <div class="log-actions">
                    <button class="action-btn anim-click" onclick="exportPDF()">PDF</button>
                    <button class="action-btn anim-click" onclick="triggerDriveBackup()">RESPALDO</button>
                    <button class="action-btn anim-click" style="color:var(--danger); border-color:var(--danger)" onclick="clearLogs()">BORRAR</button>
                </div>
            </div>
            <div class="stats-card">
                <div class="stats-header">
                    <div class="stats-title">RENDIMIENTO</div>
                     <div class="stats-toggles">
                        <button class="stat-btn active" onclick="updateStats('D')">1D</button>
                        <button class="stat-btn" onclick="updateStats('W')">1S</button>
                        <button class="stat-btn" onclick="updateStats('M')">1M</button>
                    </div>
                </div>
                <div class="chart-box" id="pnlChart"></div>
                <div class="stats-summary"><div><span class="sum-label">NETO</span><span class="sum-val" id="chartNeto">$0.00</span></div></div>
            </div>
            <div id="logGrid" class="levels-container"></div>
        </div>

        <div id="section-settings" class="app-section">
            <div class="setting-section-title">APARIENCIA</div>
             <div class="setting-card-item">
                <div class="theme-grid-container">
                    <div class="theme-card active" id="pal-default" onclick="setPalette('default')"><div class="theme-preview-bubble" style="background:#3b82f6; color:#fff">üí†</div></div>
                    <div class="theme-card" id="pal-nature" onclick="setPalette('nature')"><div class="theme-preview-bubble" style="background:#22c55e; color:#fff">üåø</div></div>
                    <div class="theme-card" id="pal-ocean" onclick="setPalette('ocean')"><div class="theme-preview-bubble" style="background:#6366f1; color:#fff">üåä</div></div>
                    <div class="theme-card" id="pal-sunset" onclick="setPalette('sunset')"><div class="theme-preview-bubble" style="background:#f97316; color:#fff">üåÖ</div></div>
                    <div class="theme-card" id="pal-cyber" onclick="setPalette('cyber')"><div class="theme-preview-bubble" style="background:#000; border:2px solid #eab308; color:#eab308">‚ö†Ô∏è</div></div>
                    <div class="theme-card" id="pal-amethyst" onclick="setPalette('amethyst')"><div class="theme-preview-bubble" style="background:#d946ef; color:#fff">üîÆ</div></div>
                </div>
            </div>

            <div class="setting-section-title">API & TRADING (GATE.IO)</div>
            <div class="setting-card-item">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <span class="setting-label">CREDENCIALES API V4</span>
                    <button class="btn-save-mini anim-click" onclick="saveApiKeysSecure()">üíæ</button>
                </div>
                <input type="password" class="setting-input" id="apiKey" placeholder="Pegar API KEY (Key)">
                <input type="password" class="setting-input" id="apiSecret" placeholder="Pegar API SECRET (Secret)">
            </div>

            <div class="setting-section-title">CAPITAL & CONFIG</div>
            <div class="setting-card-item">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <span class="setting-label">CAPITAL TOTAL BASE</span>
                    <button class="btn-save-mini anim-click" onclick="saveGlobalCapSecure()">üíæ</button>
                </div>
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px">
                    <input type="number" class="setting-input" id="setGlobalCapital" placeholder="0.00">
                    <div><label class="setting-label">FEE %</label><input type="number" class="setting-input" id="setFee" placeholder="0.1"></div>
                </div>
            </div>

            <div class="setting-section-title">ESTRATEGIA SLOT</div>
            <div class="setting-card-item">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <span class="setting-label">PAR√ÅMETROS</span>
                    <button class="btn-save-mini anim-click" onclick="saveSlotParamsSecure()">üíæ</button>
                </div>
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
                    <div><label class="setting-label">CAPITAL ($)</label><input type="number" class="setting-input" id="setCapital"></div>
                    <div><label class="setting-label">ROI (%)</label><input type="number" class="setting-input" id="setRoi"></div>
                    <div><label class="setting-label">INC. (%)</label><input type="number" class="setting-input" id="setInc"></div>
                    <div><label class="setting-label">AGR. (%)</label><input type="number" class="setting-input" id="setDesc"></div>
                </div>
            </div>
            
             <div class="setting-section-title">SEGURIDAD</div>
             <div class="setting-card-item">
                <div style="display:flex; gap:10px">
                    <input type="password" class="setting-input" id="setNewPass" placeholder="NUEVO PIN (4 d√≠gitos)" maxlength="4">
                    <button class="btn-save-mini anim-click" onclick="savePassSecure()">üíæ</button>
                </div>
             </div>

            <div class="setting-section-title">DATA</div>
            <div class="data-actions"><button class="btn-data anim-click" onclick="exportData()">‚¨áÔ∏è EXPORTAR</button><button class="btn-data anim-click" onclick="document.getElementById('importFile').click()">‚¨ÜÔ∏è IMPORTAR</button><input type="file" id="importFile" style="display:none" onchange="importData(this)"></div>
            <button class="btn-reset" onclick="resetApp()" style="margin-top:20px; color:var(--danger); border-color:var(--danger)">RESET F√ÅBRICA</button>
            <div style="text-align:center; font-size:10px; color:var(--text-tertiary); margin-top:20px;">C5X V19.4 DIAGNOSTIC</div>
        </div>
    </div>

    <div id="tradeModal" class="generic-modal">
        <div class="modal-box">
            <div class="nav-title" style="color:var(--brand); margin-bottom:10px;">EJECUTAR ORDEN</div>
            <p class="modal-info-text">Orden REAL a Gate.io</p>
            <div class="trade-details">
                <div>PAR: <span id="trade-pair" style="font-weight:800; color:#fff"></span></div>
                <div>PRECIO: <span id="trade-price" style="font-weight:800; color:#fff"></span></div>
                <div>CANTIDAD: <span id="trade-amount" style="font-weight:800; color:#fff"></span></div>
                <div>TOTAL: <span id="trade-total" style="font-weight:800; color:var(--long)"></span></div>
            </div>
            <button class="btn-modal btn-confirm anim-click" onclick="executeGateOrder()">CONFIRMAR COMPRA</button>
            <button class="btn-modal btn-cancel anim-click" onclick="closeModals()">CANCELAR</button>
        </div>
    </div>

    <div id="confirmModal" class="generic-modal"><div class="modal-box"><div style="font-family:'Orbitron'; color:var(--danger); margin-bottom:15px">¬øLIQUIDAR?</div><p class="modal-info-text">Esto cerrar√° el slot.</p><button class="btn-modal btn-confirm anim-click" style="background:var(--danger)" onclick="executeRelease()">LIQUIDAR</button><button class="btn-modal btn-cancel anim-click" onclick="closeModals()">CANCELAR</button></div></div>
    
    <div id="securityModal" class="generic-modal">
        <div class="modal-box">
            <div style="font-family:'Orbitron'; font-size:12px; margin-bottom:10px;">SEGURIDAD</div>
            <input type="password" id="secInput" style="width:100%; padding:10px; margin-bottom:10px; text-align:center; border-radius:10px; border:none;" placeholder="PIN" maxlength="4" inputmode="numeric">
            <button class="btn-modal btn-confirm anim-click" onclick="validateSecurity()">VALIDAR</button>
            <button class="btn-modal btn-cancel anim-click" onclick="closeModals()">CANCELAR</button>
        </div>
    </div>
    
    <input type="hidden" id="incInput" value="7"><input type="hidden" id="descInput" value="66">

    <script>
        // --- CONFIGURACI√ìN E INICIO ---
        let isLight = localStorage.getItem('theme') === 'light';
        let currentPalette = localStorage.getItem('c5x_palette') || 'default';
        let activeIdx = parseInt(localStorage.getItem('c5x_last_slot')) || 0;
        let activeTF = localStorage.getItem('c5x_last_tf') || '60';
        let chartSymbol = '';
        let history = JSON.parse(localStorage.getItem('c5x_history')) || [];
        let slots = JSON.parse(localStorage.getItem('dca_v18_slots')) || Array(5).fill(null).map(() => ({ name:'', price:0, capital:5, buys:[], strat:'normal', locked: true, roi: 100 }));
        if(slots.length < 5) while(slots.length < 5) slots.push({ name:'', price:0, capital:5, buys:[], strat:'normal', locked: true, roi: 100 });
        
        let customMultipliers = JSON.parse(localStorage.getItem('c5x_multipliers')) || [1.0, 1.0, 1.5, 1.5, 2.0, 2.0, 5.0, 5.0, 8.0, 8.0, 16.0, 16.0];
        let apiConfig = JSON.parse(localStorage.getItem('c5x_api_keys')) || { key: '', secret: '' };
        let appConfig = JSON.parse(localStorage.getItem('c5x_config')) || { pin: '2524', dd: 10 };
        let globalCapital = parseFloat(localStorage.getItem('c5x_global_capital')) || 0; 
        let exchangeFee = 0.1;
        
        let tickerAssets = JSON.parse(localStorage.getItem('c5x_ticker_assets')) || ["BTC", "ETH", "SUI", "AVAX", "SOL"]; 
        let assetIdx = 0; 
        let currentTickerSymbol = "BTC";
        let radarLimit = 8; let radarSpeed = 5; 
        let allGateETFs = []; let topDroppers = []; let dropperIdx = 0; let radarIntervalId = null; let tickerIntervalId = null;
        
        let etfFavorites = JSON.parse(localStorage.getItem('c5x_etf_favorites')) || [];

        function init() {
            try {
                if(isLight) document.body.classList.add('light-mode');
                applyPalette(currentPalette);
                
                // Restaurar configuraci√≥n visual
                renderNav(); 
                selectSlot(activeIdx); 
                document.querySelectorAll('.tf-btn').forEach(btn => { if(btn.dataset.tf === activeTF) btn.classList.add('active'); });
                
                // INICIAR CONEXIONES REALES
                fetchWalletBalance(); // Leer saldo con diagn√≥stico
                startTickerSystem();
                fetchAndCalcTopDroppers(); // Radar

                // Audio unlock
                document.body.addEventListener('click', () => { document.getElementById('alertSound').play().catch(()=>{}); }, { once: true });
            } catch(e) { console.error("Init error", e); }
        }

        // --- MOTOR API GATE.IO V4 (SECURE/CORS) ---
        async function callGateApi(method, path, queryParams = "", body = null) {
            // Permitir llamadas p√∫blicas (tickers) sin keys
            if (!apiConfig.key && path.includes('tickers') && method === 'GET') {
                // pass
            } else if (!apiConfig.key || !apiConfig.secret) {
                if(!path.includes('tickers')) {
                    console.warn("Faltan API Keys");
                    throw new Error("No API Keys");
                }
            }

            const host = "https://api.gateio.ws";
            const prefix = "/api/v4";
            const url = prefix + path;
            const timestamp = Math.floor(Date.now() / 1000).toString();
            
            let headers = {
                'Accept': 'application/json',
                'Content-Type': 'application/json'
            };

            // Firmar solo si hay keys y es necesario
            if(apiConfig.key && apiConfig.secret) {
                const hashedPayload = body 
                    ? CryptoJS.SHA512(JSON.stringify(body)).toString(CryptoJS.enc.Hex)
                    : CryptoJS.SHA512("").toString(CryptoJS.enc.Hex);

                const signatureString = `${method}\n${url}\n${queryParams}\n${hashedPayload}\n${timestamp}`;
                const signature = CryptoJS.HmacSHA512(signatureString, apiConfig.secret).toString(CryptoJS.enc.Hex);

                headers['KEY'] = apiConfig.key;
                headers['Timestamp'] = timestamp;
                headers['SIGN'] = signature;
            }

            const fullUrl = queryParams ? `${host}${url}?${queryParams}` : `${host}${url}`;
            
            try {
                const response = await fetch(fullUrl, {
                    method: method,
                    headers: headers,
                    body: body ? JSON.stringify(body) : null
                });

                if (!response.ok) {
                    const errText = await response.text();
                    throw new Error(`API Error ${response.status} ${errText}`);
                }
                return await response.json();
            } catch (error) {
                throw error;
            }
        }

        // --- LEER SALDO (DIAGN√ìSTICO) ---
        async function fetchWalletBalance() {
            const elDash = document.getElementById('dashWallet');
            if(elDash) elDash.textContent = "Conectando...";
        
            try {
                console.log("Intentando leer saldo en Gate.io...");
                // Petici√≥n de prueba
                const data = await callGateApi("GET", "/spot/accounts", "currency=USDT");
                
                // Si responde Gate.io:
                let available = 0;
                if (Array.isArray(data) && data.length > 0) {
                    available = parseFloat(data[0].available);
                }
        
                globalCapital = available;
                localStorage.setItem('c5x_global_capital', globalCapital);
                
                if(elDash) {
                    elDash.textContent = "$" + available.toFixed(2);
                    elDash.style.color = "var(--text-primary)";
                }
                
                const elCap = document.getElementById('setGlobalCapital');
                if(elCap) elCap.value = available.toFixed(2);
        
            } catch (e) {
                console.error("Error detallado:", e);
                
                let errorMsg = "Sin Conexi√≥n";
                
                // Diagn√≥stico de errores comunes
                if(e.message.includes("401")) errorMsg = "Error Claves (401)";
                else if(e.message.includes("403")) errorMsg = "Error Permisos (403)";
                else if(e.message.includes("Network") || e.message.includes("Failed to fetch")) errorMsg = "Bloqueo CORS / Red";
                else if(e.message.includes("signature")) errorMsg = "Error Firma/Hora";
                
                if(elDash) {
                    elDash.textContent = errorMsg;
                    elDash.style.color = "var(--danger)";
                }
                // Solo alertar la primera vez
                if(!window.hasAlertedError) {
                    showToast("‚ùå " + errorMsg + ". Revisa Consola (F12)", 4000);
                    window.hasAlertedError = true;
                }
            }
        }

        // --- EJECUTAR ORDEN REAL ---
        async function executeGateOrder() {
            closeModals();
            if(!apiConfig.key || !apiConfig.secret) {
                showToast("‚ö†Ô∏è Modo Simulaci√≥n (Sin Keys)", 3000);
                simulatedBuy(currentTrade.level);
                return;
            }

            showToast("‚è≥ Enviando Orden...");

            const body = {
                "currency_pair": currentTrade.pair, 
                "side": "buy",
                "amount": currentTrade.amount.toFixed(4), 
                "price": currentTrade.price.toFixed(6),   
                "type": "limit",
                "account": "spot",
                "time_in_force": "gtc"
            };

            try {
                const result = await callGateApi("POST", "/spot/orders", "", body);
                showToast(`‚úÖ ORDEN CREADA: ${result.id}`, 4000, false, true);
                
                // Marcar localmente
                simulatedBuy(currentTrade.level);
                
                // Actualizar saldo despu√©s de un segundo
                setTimeout(fetchWalletBalance, 1500);

            } catch (e) {
                showToast("‚ùå Error API: " + e.message, 4000, true);
                if(confirm("La API fall√≥. ¬øMarcar nivel manualmente?")) {
                     simulatedBuy(currentTrade.level);
                }
            }
        }

        // --- FUNCIONES UI Y L√ìGICA BASE ---
        function simulatedBuy(idx) {
            const s = slots[activeIdx];
            for(let i=0; i<=idx; i++) { if(!s.buys.includes(i)) s.buys.push(i); }
            save(); calculate(); renderLevels();
        }

        function switchView(viewName) { 
            document.getElementById('navModal').style.display = 'none';
            document.querySelectorAll('.app-section').forEach(el => el.classList.remove('active'));
            document.getElementById('section-' + viewName).classList.add('active');
            
            // Navegaci√≥n Visual
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('selected'));
            const nav = document.getElementById('nav-' + viewName);
            if(nav) nav.classList.add('selected');

            // Header logica
            const tfBar = document.getElementById('tfBarContainer');
            if(viewName === 'operate') {
                tfBar.style.display = 'grid';
                document.querySelector('.content-spacer').style.marginTop = '92px';
                if(chartSymbol) loadChart(chartSymbol);
            } else {
                tfBar.style.display = 'none';
                document.querySelector('.content-spacer').style.marginTop = '60px';
            }

            if(viewName === 'etf') loadGateETFs();
            if(viewName === 'settings') loadSettingsValues();
            if(viewName === 'log') updateStats('D');
            window.scrollTo(0,0);
        }

        function openMenuViaButton() { document.getElementById('navModal').style.display = 'flex'; }
        function closeMenuViaButton() { document.getElementById('navModal').style.display = 'none'; }
        function closeModals() { document.querySelectorAll('.generic-modal').forEach(m => m.style.display = 'none'); }
        function showToast(txt, time=2500, alert=false, success=false) {
            const t = document.getElementById("toast");
            t.textContent = txt; t.className = "show";
            if(alert) t.classList.add("alert-mode");
            if(success) t.classList.add("success-mode");
            setTimeout(() => t.className = "", time);
        }

        // --- SLOT LOGIC ---
        function selectSlot(i) {
            activeIdx = i; localStorage.setItem('c5x_last_slot', i);
            const s = slots[i];
            document.getElementById('coinInput').value = s.name;
            document.getElementById('baseInput').value = s.price || '';
            document.getElementById('capitalInput').value = s.capital;
            renderNav(); loadChart(s.name); updateDashUI();
        }
        function save() { localStorage.setItem('dca_v18_slots', JSON.stringify(slots)); }
        function renderNav() { document.getElementById('slotNav').innerHTML = slots.map((s, i) => `<div class="slot-card ${i === activeIdx ? 'active' : ''} ${s.name?'is-occupied':''}" onclick="selectSlot(${i})">${s.name || 'S'+(i+1)}</div>`).join(''); }
        
        function updateDashUI() {
            const s = slots[activeIdx];
            document.getElementById('stratBadge').textContent = s.strat === "normal" ? "NORMAL" : "AGRESIVA";
            document.getElementById('stratBadge').style.borderColor = s.strat === "normal" ? "transparent" : "var(--warning)";
            const lockBtn = document.getElementById('lockBtn');
            lockBtn.textContent = s.locked ? "üîí" : "üîì";
            lockBtn.className = s.locked ? "icon-sq-btn locked" : "icon-sq-btn";
            calculate();
        }

        function calculate() {
            const s = slots[activeIdx];
            const p = parseFloat(document.getElementById('baseInput').value);
            s.price = isNaN(p) ? 0 : p;
            save(); renderLevels();
        }

        function renderLevels() {
            const grid = document.getElementById('levelsGrid');
            const s = slots[activeIdx];
            if(!s.price || s.price <= 0) { grid.innerHTML = '<div style="text-align:center; padding:20px; color:var(--text-secondary)">Define precio base</div>'; return; }
            
            let html = '', lastPrice = s.price, totalSpent = 0, totalQty = 0;
            const incPct = 7, descPct = 66; 
            
            for(let i=0; i<12; i++) {
                let pLevel, drop = 0;
                if(i===0) pLevel = s.price;
                else {
                    let step = (s.strat === "normal") ? (i===1?17:incPct) : descPct;
                    pLevel = lastPrice * (1 - (step/100));
                    drop = step;
                }
                
                const mult = customMultipliers[i] || 1;
                const usd = s.capital * mult;
                const on = s.buys.includes(i);
                
                if(on) { totalSpent += usd; totalQty += (usd/pLevel); }
                
                html += `<div class="unified-card ${on?'active':''}" onclick="toggleLvl(${i})">
                    <div class="u-index">${i+1}</div>
                    <div class="u-center"><div class="u-title">${pLevel < 1 ? pLevel.toFixed(6) : pLevel.toFixed(4)}</div></div>
                    <div class="u-right">
                        <div class="u-val-primary">$${usd.toFixed(1)}</div>
                        <div style="font-size:11px; color:var(--text-secondary)">${i===0?'-':'-'+drop+'%'}</div>
                    </div>
                </div>`;
                lastPrice = pLevel;
            }
            html += `<div class="liquidate-card anim-click" onclick="document.getElementById('confirmModal').style.display='flex'">LIQUIDAR POSICI√ìN</div>`;
            grid.innerHTML = html;
            
            const avg = totalQty > 0 ? totalSpent/totalQty : 0;
            const target = avg * (1 + (s.roi/100));
            document.getElementById('resAvg').textContent = avg < 1 ? avg.toFixed(6) : avg.toFixed(4);
            document.getElementById('resTarget').textContent = target < 1 ? target.toFixed(6) : target.toFixed(4);
            document.getElementById('resInv').textContent = `$${totalSpent.toFixed(2)}`;
            document.getElementById('resProfit').textContent = totalSpent > 0 ? `$${(totalSpent * (s.roi/100)).toFixed(2)}` : "$0.00";
        }

        let currentTrade = {};
        function toggleLvl(idx) {
            const s = slots[activeIdx];
            if(!s.buys.includes(idx)) {
                let pLevel = s.price; 
                let lastP = s.price; const incPct=7, descPct=66;
                for(let k=0; k<=idx; k++) { 
                    if(k>0) { let step = (s.strat==="normal")?(k===1?17:incPct):descPct; lastP = lastP * (1-(step/100)); }
                }
                pLevel = lastP;
                const mult = customMultipliers[idx] || 1;
                const usd = s.capital * mult;
                
                currentTrade = { level: idx, pair: s.name+"_USDT", price: pLevel, amount: usd/pLevel, usd: usd };
                document.getElementById('trade-pair').textContent = currentTrade.pair;
                document.getElementById('trade-price').textContent = currentTrade.price.toFixed(6);
                document.getElementById('trade-amount').textContent = currentTrade.amount.toFixed(4);
                document.getElementById('trade-total').textContent = "$"+currentTrade.usd.toFixed(2);
                document.getElementById('tradeModal').style.display = 'flex';
            } else {
                s.buys = s.buys.filter(x => x < idx);
                save(); calculate();
            }
        }

        function executeRelease() {
            closeModals();
            const s = slots[activeIdx];
            const inv = parseFloat(document.getElementById('resInv').textContent.replace('$',''));
            const profit = parseFloat(document.getElementById('resProfit').textContent.replace('$',''));
            
            const log = { date: new Date().toLocaleDateString(), time: new Date().toLocaleTimeString(), coin: s.name, profit: profit.toFixed(2), totalInv: inv.toFixed(2), roi: s.roi+"%" };
            history.push(log); localStorage.setItem('c5x_history', JSON.stringify(history));
            
            slots[activeIdx] = { name:'', price:0, capital:5, buys:[], strat:'normal', locked: true, roi: 100 };
            save(); selectSlot(0); showToast("‚úÖ Posici√≥n Cerrada");
        }

        // --- TICKER & RADAR ---
        async function startTickerSystem() {
            if(tickerIntervalId) clearInterval(tickerIntervalId);
            updateTicker();
            tickerIntervalId = setInterval(updateTicker, 7000);
        }

        async function updateTicker() {
            const sym = tickerAssets[assetIdx];
            if(!isTickerPinned) assetIdx = (assetIdx + 1) % tickerAssets.length;
            
            document.getElementById('t-sym').textContent = sym;
            try {
                // Intento directo a Gate
                const data = await callGateApi("GET", "/spot/tickers", `currency_pair=${sym}_USDT`);
                if(data && data.length > 0) {
                    const price = parseFloat(data[0].last);
                    document.getElementById('t-price').textContent = price < 1 ? price.toFixed(6) : price.toFixed(2);
                    document.getElementById('t-dot').classList.toggle('pulse');
                }
            } catch(e) {}
        }

        async function fetchAndCalcTopDroppers() {
            try {
                const data = await callGateApi("GET", "/spot/tickers");
                if(!data) return;
                document.getElementById('radarStatus').className = 'radar-status-dot online';
                allGateETFs = data.filter(t => t.currency_pair.includes('3L') || t.currency_pair.includes('3S') || t.currency_pair.includes('5L') || t.currency_pair.includes('5S'));
                topDroppers = allGateETFs.sort((a,b) => parseFloat(a.change_percentage) - parseFloat(b.change_percentage)).slice(0, radarLimit);
                startRadarRotation();
            } catch(e) { document.getElementById('radarStatus').className = 'radar-status-dot offline'; }
        }

        function startRadarRotation() {
            if(radarIntervalId) clearInterval(radarIntervalId);
            radarIntervalId = setInterval(() => {
                if(topDroppers.length === 0) return;
                dropperIdx = (dropperIdx + 1) % topDroppers.length;
                const t = topDroppers[dropperIdx];
                const name = t.currency_pair.replace('_USDT','');
                const price = parseFloat(t.last);
                const chg = parseFloat(t.change_percentage).toFixed(2);
                document.getElementById('radarValue').innerHTML = `${name} <span style="color:var(--gold-fixed)">$${price<1?price.toFixed(4):price.toFixed(2)}</span> <span style="font-size:12px">(${chg}%)</span>`;
            }, radarSpeed * 1000);
        }

        // --- UTILS ---
        function toggleLock() { slots[activeIdx].locked = !slots[activeIdx].locked; save(); updateDashUI(); }
        function rotateDash() { if(!slots[activeIdx].locked) { slots[activeIdx].strat = slots[activeIdx].strat==="normal"?"aggressive":"normal"; save(); updateDashUI(); } else showToast("Bloqueado"); }
        function cleanSlotOnly() { if(confirm("¬øLimpiar?")) { slots[activeIdx] = { name:'', price:0, capital:5, buys:[], strat:'normal', locked:true, roi:100 }; save(); selectSlot(0); } }
        function updateCoin() { slots[activeIdx].name = document.getElementById('coinInput').value.toUpperCase(); save(); loadChart(slots[activeIdx].name); }
        function loadChart(s) { if(!s) return; new TradingView.widget({ "autosize": true, "symbol": "GATEIO:"+s.replace('USDT','')+"USDT", "interval": activeTF, "theme": isLight?"light":"dark", "container_id": "tv_chart", "hide_top_toolbar": true }); }
        function updateTF(tf, btn) { activeTF=tf; localStorage.setItem('c5x_last_tf', tf); document.querySelectorAll('.tf-btn').forEach(b=>b.classList.remove('active')); btn.classList.add('active'); loadChart(slots[activeIdx].name); }
        function toggleFullscreenChart() { document.getElementById('tv_chart').classList.toggle('fullscreen'); loadChart(slots[activeIdx].name); }
        function forceCaps(el) { el.value = el.value.toUpperCase(); }
        
        // --- SETTINGS LOAD/SAVE ---
        function loadSettingsValues() {
            document.getElementById('setGlobalCapital').value = globalCapital.toFixed(2);
            document.getElementById('apiKey').value = apiConfig.key;
            document.getElementById('apiSecret').value = apiConfig.secret;
            const s = slots[activeIdx];
            document.getElementById('setCapital').value = s.capital;
            document.getElementById('setRoi').value = s.roi;
            document.getElementById('setInc').value = 7; 
            document.getElementById('setDesc').value = 66;
        }

        let secAction = null;
        function reqSec(cb) { secAction = cb; document.getElementById('secInput').value=''; document.getElementById('securityModal').style.display='flex'; }
        function validateSecurity() {
            if(document.getElementById('secInput').value === appConfig.pin) {
                closeModals(); if(secAction) secAction();
            } else showToast("PIN Incorrecto");
        }

        function saveApiKeysSecure() {
            reqSec(() => {
                const k = document.getElementById('apiKey').value;
                const s = document.getElementById('apiSecret').value;
                apiConfig = { key: k, secret: s };
                localStorage.setItem('c5x_api_keys', JSON.stringify(apiConfig));
                showToast("API Guardada");
                fetchWalletBalance();
            });
        }
        function saveGlobalCapSecure() {
             reqSec(() => {
                 globalCapital = parseFloat(document.getElementById('setGlobalCapital').value);
                 localStorage.setItem('c5x_global_capital', globalCapital);
                 showToast("Capital Guardado");
             });
        }
        function saveSlotParamsSecure() {
            reqSec(() => {
                slots[activeIdx].capital = parseFloat(document.getElementById('setCapital').value);
                slots[activeIdx].roi = parseFloat(document.getElementById('setRoi').value);
                save(); showToast("Params Guardados"); calculate();
            });
        }
        function savePassSecure() {
            reqSec(() => {
                const p = document.getElementById('setNewPass').value;
                if(p.length===4) { appConfig.pin = p; localStorage.setItem('c5x_config', JSON.stringify(appConfig)); showToast("PIN Cambiado"); }
            });
        }
        
        function clearLogs() { reqSec(() => { history = []; localStorage.setItem('c5x_history', JSON.stringify(history)); showToast("Logs Borrados"); }); }
        
        function toggleTheme() { isLight=!isLight; localStorage.setItem('theme', isLight?'light':'dark'); location.reload(); }
        function setPalette(p) { currentPalette=p; localStorage.setItem('c5x_palette', p); location.reload(); }
        
        function filterETFs(q) {
             const grid = document.getElementById('etfGrid');
             if(!q) { grid.innerHTML=""; return; }
             const res = allGateETFs.filter(t => t.currency_pair.includes(q.toUpperCase()));
             grid.innerHTML = res.map(t => `<div class="unified-card" onclick="quickAddFromTicker('${t.currency_pair.replace('_USDT','')}', ${t.last}, event)"><div class="u-center"><div class="u-title">${t.currency_pair.replace('_USDT','')}</div></div><div class="u-right"><div class="u-val-primary">$${parseFloat(t.last).toFixed(4)}</div></div></div>`).join('');
        }
        function quickAddFromTicker(n, p, e) {
            e.stopPropagation();
            const empty = slots.findIndex(s=>!s.name);
            if(empty>=0) { slots[empty].name=n; slots[empty].price=p; save(); selectSlot(empty); switchView('operate'); showToast("A√±adido Slot "+(empty+1)); }
            else showToast("Lleno");
        }
        
        // --- FUNCIONES COMPLETAS RESTAURADAS (PDF/BACKUP) ---
        function exportPDF() { 
            if(history.length === 0) return showToast("‚ö†Ô∏è Sin Datos"); 
            const { jsPDF } = window.jspdf; const doc = new jsPDF('l', 'mm', 'a4'); let totalProfit = 0; let totalInvested = 0; let wins = 0; 
            history.forEach(h => { const inv = parseFloat(h.totalInv) || 0; const prof = (h.netProfit !== undefined ? parseFloat(h.netProfit) : parseFloat(h.profit)) || 0; totalInvested += inv; totalProfit += prof; if(prof > 0) wins++; }); 
            const winRate = history.length > 0 ? ((wins / history.length) * 100).toFixed(1) : 0; 
            doc.setFillColor(11, 14, 17); doc.rect(0, 0, 297, 25, 'F'); doc.setFont("helvetica", "bold"); doc.setFontSize(22); doc.setTextColor(59, 130, 246); doc.text("C5X", 14, 16); doc.setFontSize(14); doc.setTextColor(255, 255, 255); doc.text("REPORTE PROFESIONAL", 40, 16); 
            doc.setFillColor(245, 247, 250); doc.rect(14, 30, 270, 20, 'F'); doc.setFontSize(10); doc.setTextColor(80); doc.text("CAPITAL MOVIDO", 20, 38); doc.text("NET PROFIT", 90, 38); doc.text("WIN RATE", 160, 38); doc.text("TOTAL OPS", 230, 38); 
            doc.setFontSize(14); doc.setTextColor(0); doc.text("$" + totalInvested.toFixed(2), 20, 46); doc.setTextColor(totalProfit >= 0 ? 14 : 200, totalProfit >= 0 ? 203 : 50, totalProfit >= 0 ? 129 : 50); doc.text((totalProfit>=0?'+':'') + "$" + totalProfit.toFixed(2), 90, 46); doc.setTextColor(0); doc.text(winRate + "%", 160, 46); doc.text(history.length.toString(), 230, 46); 
            const bodyData = history.map(h => { const inv = parseFloat(h.totalInv) || 0; const prof = (h.netProfit !== undefined ? parseFloat(h.netProfit) : parseFloat(h.profit)) || 0; const avg = parseFloat(h.avgPrice) || 0; const exit = parseFloat(h.exitPrice) || 0; return [ h.date + '\n' + h.time, h.coin, '$' + (avg < 1 ? avg.toFixed(6) : avg.toFixed(2)), '$' + (exit < 1 ? exit.toFixed(6) : exit.toFixed(2)), '$' + inv.toFixed(2), (prof>=0?'+':'') + '$' + prof.toFixed(2), h.roi ]; }); 
            doc.autoTable({ head: [['FECHA / HORA', 'ACTIVO', 'PRECIO ENT.', 'PRECIO SALIDA', 'INVERSI√ìN', 'PNL NETO', 'ROI']], body: bodyData, startY: 58, theme: 'grid', styles: { fontSize: 9, cellPadding: 3, valign: 'middle', halign: 'center' }, headStyles: { fillColor: [21, 26, 33], textColor: 255, fontStyle: 'bold', halign: 'center' }, didParseCell: function(data) { if (data.section === 'body' && data.column.index === 5) { const raw = data.cell.raw; if(raw.startsWith('+')) data.cell.styles.textColor = [14, 203, 129]; else data.cell.styles.textColor = [246, 70, 93]; } } }); 
            doc.save("C5X_Pro_Report.pdf"); 
        }
        function exportData() { const dataStr = JSON.stringify({ slots, history, tickerAssets, customMultipliers, etfFavorites, globalCapital, appConfig }); const blob = new Blob([dataStr], {type: "application/json"}); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = "C5X_Backup.json"; document.body.appendChild(a); a.click(); }
        function importData(input) { const file = input.files[0]; if(!file) return; const reader = new FileReader(); reader.onload = function(e) { try { const data = JSON.parse(e.target.result); if(data.slots) slots = data.slots; if(data.history) history = data.history; if(data.customMultipliers) { customMultipliers = data.customMultipliers; localStorage.setItem('c5x_multipliers', JSON.stringify(customMultipliers)); } if(data.etfFavorites) { etfFavorites = data.etfFavorites; localStorage.setItem('c5x_etf_favorites', JSON.stringify(etfFavorites)); } if(data.globalCapital) { globalCapital = data.globalCapital; localStorage.setItem('c5x_global_capital', globalCapital); } if(data.appConfig) { appConfig = data.appConfig; localStorage.setItem('c5x_config', JSON.stringify(appConfig)); } save(); localStorage.setItem('c5x_history', JSON.stringify(history)); location.reload(); } catch(err) { showToast("‚ùå Error al leer archivo"); } }; reader.readAsText(file); }
        function triggerDriveBackup() { const dataStr = JSON.stringify({ slots, history, tickerAssets, customMultipliers, etfFavorites, globalCapital, appConfig }); const blob = new Blob([dataStr], {type: "application/json"}); const a = document.createElement('a'); const date = new Date().toISOString().slice(0,10); a.href = URL.createObjectURL(blob); a.download = `C5X_Backup_${date}.json`; document.body.appendChild(a); a.click(); localStorage.setItem('c5x_last_backup', Date.now()); showToast("‚òÅÔ∏è Archivo generado para Drive"); }
        function resetApp() { openSecurity(() => { localStorage.clear(); location.reload(); }); }
        function updateStats(tf) {
            triggerHaptic();
            document.querySelectorAll('.stat-btn').forEach(b => b.classList.remove('active'));
            // L√≥gica simple de stats para mantener tama√±o
            showToast("Stats actualizados");
        }
    </script>
</body>
</html>