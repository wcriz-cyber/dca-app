<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>DCA COMMAND V17.37 - PRO</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@600;900&family=Roboto:wght@400;700;900&family=Roboto+Mono:wght@700;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #050708; --surface: #12151a; --primary: #3498db; --success: #0ecb81;
            --warning: #f1c40f; --text: #f0f2f5; --danger: #f6465d;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Roboto', sans-serif; background: var(--bg); color: var(--text); padding-bottom: 100px; overflow-x: hidden; }

        /* CARRUSEL SUPERIOR */
        .ticker-wrap { background: #000; border-bottom: 1px solid #222; padding: 10px 0; overflow: hidden; white-space: nowrap; display: flex; align-items: center; }
        .ticker-move { display: flex; gap: 20px; animation: ticker 40s linear infinite; }
        @keyframes ticker { 0% { transform: translateX(0); } 100% { transform: translateX(-50%); } }
        .ticker-item { display: inline-block; font-family: 'Roboto Mono'; font-size: 11px; font-weight: 900; }
        .t-up { color: var(--success); } .t-down { color: var(--danger); }

        /* 5 SLOTS FIJOS */
        .slots-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 4px; padding: 10px 8px; background: var(--surface); border-bottom: 2px solid #222; }
        .s-btn { 
            background: #1a1e23; border: 1.5px solid #333; border-radius: 8px; 
            padding: 10px 2px; text-align: center; cursor: pointer; transition: 0.3s;
        }
        .s-btn.active { border-width: 2.5px; transform: scale(1.03); }
        .s-btn.is-long.active { border-color: var(--success); box-shadow: 0 0 10px rgba(14,203,129,0.3); }
        .s-btn.is-short.active { border-color: var(--danger); box-shadow: 0 0 10px rgba(246,70,93,0.3); }
        .s-name { font-size: 10px; font-weight: 900; display: block; margin-bottom: 3px; }
        .s-price { font-family: 'Roboto Mono'; font-size: 10px; color: var(--warning); }

        /* TIMEFRAMES */
        .tf-bar { display: flex; width: 100%; background: #000; border-bottom: 1px solid #222; }
        .tf-btn { flex: 1; background: transparent; border: none; border-right: 1px solid #1a1e23; color: #848e9c; padding: 12px 0; font-size: 11px; font-weight: 900; }
        .tf-btn.active { background: var(--primary); color: #000; }

        /* DASHBOARD & CONTROLS */
        .dash { margin: 15px; padding: 20px; background: var(--surface); border-radius: 15px; border: 1px solid #333; text-align: center; }
        .avg-large { font-family: 'Roboto Mono'; font-size: 38px; font-weight: 900; color: var(--warning); }
        .controls { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; padding: 0 15px; }
        .c-box { background: var(--surface); padding: 10px; border-radius: 10px; border: 1px solid #2d3339; text-align: center; }
        .c-box label { font-size: 8px; color: var(--primary); font-weight: 900; display: block; }
        .c-box input { background: transparent; border: none; color: white; width: 100%; text-align: center; font-weight: 900; font-size: 17px; outline: none; }

        /* LEVELS */
        .levels-container { padding: 12px; display: grid; gap: 10px; }
        .lvl-card { background: var(--surface); border-radius: 12px; padding: 20px; display: flex; align-items: center; justify-content: space-between; border: 1px solid #2d3339; }
        .lvl-card.active { border-color: var(--primary); background: rgba(52,152,219,0.1); }
        .lvl-check { width: 30px; height: 30px; border: 2px solid #444; border-radius: 6px; display: flex; align-items: center; justify-content: center; }
        .active .lvl-check { background: var(--primary); border-color: var(--primary); color: #000; font-weight: 900; }

        .btn-main { width: 92%; margin: 20px auto; display: block; padding: 20px; border-radius: 15px; background: var(--danger); color: white; font-weight: 900; font-family: 'Orbitron'; border: none; }
    </style>
</head>
<body onload="init()">

    <div class="ticker-wrap" id="tickerWrap">
        <div class="ticker-move" id="ticker"></div>
        <button onclick="addTicker()" style="background:var(--primary); border:none; color:#000; font-weight:900; padding:0 15px; height:100%; position:absolute; right:0;">+</button>
    </div>

    <div class="slots-grid" id="slotsGrid"></div>

    <nav class="tf-bar">
        <button class="tf-btn" onclick="setTF('15', this)">15M</button>
        <button class="tf-btn" onclick="setTF('30', this)">30M</button>
        <button class="tf-btn active" onclick="setTF('60', this)">1H</button>
        <button class="tf-btn" onclick="setTF('240', this)">4H</button>
        <button class="tf-btn" onclick="setTF('D', this)">1D</button>
    </nav>

    <div id="tv_chart_box" style="width:100%; height:380px;"></div>

    <div class="controls">
        <div class="c-box"><label>ACTIVO</label><input type="text" id="coinIn" onblur="updateSlotName()"></div>
        <div class="c-box"><label>ENTRADA</label><input type="number" id="baseIn" step="any" oninput="calculate()"></div>
        <div class="c-box"><label>CAPITAL</label><input type="number" id="capIn" oninput="calculate()"></div>
    </div>

    <div class="dash">
        <small style="font-weight:900; color:#848e9c;">PRECIO PROMEDIO</small><br>
        <span id="resAvg" class="avg-large">0.000000</span>
        <div style="display:flex; justify-content:space-around; margin-top:15px; border-top:1px solid #222; padding-top:10px;">
            <div><small style="display:block; font-size:9px;">INVESTED</small><b id="resInv">$0.00</b></div>
            <div><small style="display:block; font-size:9px;">PROFIT</small><b id="resProfit" style="color:var(--success)">$0.00</b></div>
            <div><small style="display:block; font-size:9px;">TARGET</small><b id="resTarget">0.000000</b></div>
        </div>
    </div>

    <main id="levelsGrid" class="levels-container"></main>
    <button class="btn-main" onclick="releasePos()">LIQUIDAR Y RESETEAR SLOT</button>

    <script src="https://s3.tradingview.com/tv.js"></script>
    <script>
        let activeSlot = 0;
        let currentTF = '60';
        let tickerCoins = JSON.parse(localStorage.getItem('dca_ticker_v37')) || ['BTCUSDT', 'ETHUSDT', 'SUIUSDT', 'AVAXUSDT', 'BNBUSDT'];
        let slots = JSON.parse(localStorage.getItem('dca_slots_v37')) || [
            { name:'BTC3L', price:0, capital:10, buys:[] },
            { name:'ETH3L', price:0, capital:10, buys:[] },
            { name:'SUI3L', price:0, capital:10, buys:[] },
            { name:'SOL3L', price:0, capital:10, buys:[] },
            { name:'XRP3S', price:0, capital:10, buys:[] }
        ];

        function init() {
            renderSlots();
            renderTicker();
            loadChart();
            syncUI();
            setInterval(updateData, 4000);
            updateData();
        }

        function renderSlots() {
            const grid = document.getElementById('slotsGrid');
            grid.innerHTML = slots.map((s, i) => {
                const isLong = s.name.includes('L');
                return `
                <div class="s-btn ${activeSlot === i ? 'active' : ''} ${isLong ? 'is-long' : 'is-short'}" onclick="selectSlot(${i})">
                    <span class="s-name" style="color:${isLong ? 'var(--success)' : 'var(--danger)'}">${s.name}</span>
                    <span class="s-price" id="sl-p-${i}">---</span>
                </div>`;
            }).join('');
        }

        async function updateData() {
            // Update Ticker
            const tickerDiv = document.getElementById('ticker');
            let tickerHtml = '';
            for (const coin of tickerCoins) {
                try {
                    const r = await fetch(`https://api.bybit.com/v5/market/tickers?category=linear&symbol=${coin}`);
                    const d = await r.json();
                    if(d.result?.list[0]) {
                        const t = d.result.list[0];
                        const change = parseFloat(t.turnover24h) > 0 ? (t.lastPrice - t.prevPrice24h) / t.prevPrice24h * 100 : 0;
                        tickerHtml += `
                            <div class="ticker-item">
                                ${coin.replace('USDT','')}: ${parseFloat(t.lastPrice).toFixed(2)} 
                                <span class="${change >=0 ? 't-up' : 't-down'}">${change >=0 ? '▲' : '▼'}${Math.abs(change).toFixed(2)}%</span>
                            </div>`;
                    }
                } catch(e) {}
            }
            tickerDiv.innerHTML = tickerHtml + tickerHtml; // Double for loop

            // Update Slot Prices
            for (let i=0; i<5; i++) {
                try {
                    const s = slots[i].name.includes('USDT') ? slots[i].name : slots[i].name + 'USDT';
                    const r = await fetch(`https://api.bybit.com/v5/market/tickers?category=linear&symbol=${s}`);
                    const d = await r.json();
                    if(d.result?.list[0]) {
                        document.getElementById(`sl-p-${i}`).innerText = parseFloat(d.result.list[0].lastPrice).toFixed(4);
                    }
                } catch(e) {}
            }
        }

        function selectSlot(i) { activeSlot = i; renderSlots(); syncUI(); loadChart(); }
        function syncUI() {
            const s = slots[activeSlot];
            document.getElementById('coinIn').value = s.name;
            document.getElementById('baseIn').value = s.price || '';
            document.getElementById('capIn').value = s.capital || 10;
            calculate();
        }

        function updateSlotName() {
            slots[activeSlot].name = document.getElementById('coinIn').value.toUpperCase();
            save(); renderSlots(); loadChart();
        }

        function setTF(tf, btn) {
            currentTF = tf;
            document.querySelectorAll('.tf-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            loadChart();
        }

        function loadChart() {
            const coin = slots[activeSlot].name;
            const symb = coin.includes('USDT') ? coin : coin + 'USDT';
            new TradingView.widget({
                "autosize": true, "symbol": `GATEIO:${symb}`, "interval": currentTF,
                "theme": "dark", "style": "1", "container_id": "tv_chart_box",
                "hide_top_toolbar": true, "backgroundColor": "#050708"
            });
        }

        function calculate() {
            const s = slots[activeSlot];
            s.price = parseFloat(document.getElementById('baseIn').value) || 0;
            s.capital = parseFloat(document.getElementById('capIn').value) || 10;
            save();

            const grid = document.getElementById('levelsGrid');
            if(!s.price) { grid.innerHTML = ""; return; }

            const strategy = [
                { c: 0.00, m: 1.0 }, { c: 0.10, m: 1.0 }, { c: 0.15, m: 1.5 }, { c: 0.15, m: 1.5 },
                { c: 0.20, m: 2.0 }, { c: 0.20, m: 2.0 }, { c: 0.25, m: 2.5 }, { c: 0.25, m: 2.5 },
                { c: 0.30, m: 3.0 }, { c: 0.30, m: 3.0 }, { c: 0.35, m: 3.5 }, { c: 0.35, m: 3.5 },
                { c: 0.40, m: 4.0 }, { c: 0.40, m: 4.0 }, { c: 0.50, m: 5.0 }, { c: 0.50, m: 5.0 }
            ];

            let spent = 0, tokens = 0, currentP = s.price, lastLvl = -1, html = '';
            strategy.forEach((lvl, i) => {
                if(i > 0) currentP *= (1 - lvl.c);
                const isBought = s.buys.includes(i);
                if(isBought) { spent += (lvl.m * s.capital); tokens += ((lvl.m * s.capital) / currentP); lastLvl = i; }
                const mult = i < 4 ? 0.5 : (i < 8 ? 1.0 : (i < 12 ? 1.5 : 2.0));
                html += `<div class="lvl-card ${isBought ? 'active' : ''}" onclick="toggleLvl(${i})">
                    <div style="display:flex; align-items:center;">
                        <div class="lvl-check">${isBought ? '✓' : ''}</div>
                        <div style="margin-left:15px">
                            <small style="color:var(--primary); font-weight:900;">NIVEL ${i+1} (+${mult*100}%)</small>
                            <div style="font-size:22px; font-weight:900; font-family:'Roboto Mono';">${currentP.toFixed(6)}</div>
                        </div>
                    </div>
                    <button style="background:var(--primary); border:none; padding:8px 15px; border-radius:8px; font-weight:900; font-size:10px;" onclick="event.stopPropagation(); fillTo(${i})">FILL</button>
                </div>`;
            });

            grid.innerHTML = html;
            const avg = tokens > 0 ? (spent / tokens) : 0;
            const fMult = lastLvl < 4 ? 0.5 : (lastLvl < 8 ? 1.0 : (lastLvl < 12 ? 1.5 : 2.0));
            document.getElementById('resAvg').innerText = avg.toFixed(6);
            document.getElementById('resInv').innerText = `$${spent.toFixed(2)}`;
            document.getElementById('resProfit').innerText = `$${(spent * fMult).toFixed(2)}`;
            document.getElementById('resTarget').innerText = avg > 0 ? (avg * (1 + fMult)).toFixed(6) : '0.000000';
        }

        function toggleLvl(i) {
            const b = slots[activeSlot].buys;
            slots[activeSlot].buys = b.includes(i) ? b.filter(x => x !== i) : [...b, i];
            calculate();
        }

        function fillTo(i) {
            let n = []; for(let j=0; j<=i; j++) n.push(j);
            slots[activeSlot].buys = n; calculate();
        }

        function releasePos() {
            if(confirm("¿Liquidar y resetear slot?")) {
                slots[activeSlot].buys = []; slots[activeSlot].price = 0;
                save(); syncUI();
            }
        }

        function addTicker() {
            const c = prompt("Moneda (ej: SUIUSDT):");
            if(c) { tickerCoins.push(c.toUpperCase()); localStorage.setItem('dca_ticker_v37', JSON.stringify(tickerCoins)); }
        }

        function save() { localStorage.setItem('dca_slots_v37', JSON.stringify(slots)); }
        function renderTicker() {} // Handled by updateData
    </script>
</body>
</html>
