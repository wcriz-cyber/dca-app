<!-- Insertar ESTE BLOQUE dentro de tu sección "MONITOR ETF" (antes del cierre de su contenedor) -->
<div id="etf-alert-system" class="etf-alert-container" style="margin-top: 20px; padding: 15px; background: rgba(30, 40, 60, 0.7); border-radius: 12px; border-left: 3px solid #3498db; display: none;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
        <h3 style="margin: 0; color: #3498db; font-size: 1.3rem;">
            <i class="fas fa-bell" style="margin-right: 8px;"></i>Sistema de Alertas ETF
        </h3>
        <label class="toggle-switch" style="margin: 0;">
            <input type="checkbox" id="etf-alert-toggle" checked>
            <span class="slider" style="background-color: #34495e;"></span>
        </label>
    </div>
    
    <div class="alert-config" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 15px;">
        <div>
            <div style="font-size: 0.85rem; color: #95a5a6; margin-bottom: 5px;">Precio de Referencia</div>
            <div id="etf-reference-price" style="font-weight: bold; font-size: 1.2rem; color: #3498db;">$0.00</div>
        </div>
        <div>
            <div style="font-size: 0.85rem; color: #95a5a6; margin-bottom: 5px;">Caída Actual</div>
            <div id="etf-drop-percentage" style="font-weight: bold; font-size: 1.2rem; color: #f39c12;">0.00%</div>
        </div>
        <div>
            <div style="font-size: 0.85rem; color: #95a5a6; margin-bottom: 5px;">Umbral Alerta</div>
            <select id="etf-alert-threshold" class="setting-control" style="width: 100%; padding: 6px; background: rgba(40,50,70,0.9); border-radius: 8px; color: white; border: 1px solid #34495e;">
                <option value="50">50% (Crítico)</option>
                <option value="40">40%</option>
                <option value="45">45%</option>
                <option value="55">55%</option>
            </select>
        </div>
    </div>
    
    <div class="progress-container" style="height: 8px; background: rgba(52, 73, 94, 0.8); border-radius: 4px; overflow: hidden; margin: 10px 0;">
        <div id="etf-progress-fill" style="height: 100%; width: 0%; background: linear-gradient(to right, #3498db, #2ecc71); transition: width 0.5s ease;"></div>
    </div>
    
    <div style="display: flex; gap: 10px; margin-top: 12px;">
        <button id="set-etf-reference" class="btn" style="flex: 1; padding: 8px; background: linear-gradient(to right, #3498db, #2980b9); color: white; border: none; border-radius: 8px; font-weight: 500;">
            <i class="fas fa-bullseye"></i> Establecer Referencia Actual
        </button>
        <button id="test-etf-alert" class="btn" style="flex: 1; padding: 8px; background: linear-gradient(to right, #9b59b6, #8e44ad); color: white; border: none; border-radius: 8px; font-weight: 500;">
            <i class="fas fa-bell"></i> Probar Alerta
        </button>
    </div>
    
    <div id="alert-status" style="margin-top: 10px; padding: 8px; border-radius: 8px; font-size: 0.85rem; text-align: center; display: none;">
        <i class="fas fa-check-circle" style="color: #2ecc71; margin-right: 5px;"></i>
        <span>Alertas activas. Monitoreando caída ≥ <span id="current-threshold">50</span>%</span>
    </div>
</div>

<!-- Insertar ESTE MODAL junto a tus modales existentes (antes de </body>) -->
<div id="etf-critical-alert" class="modal-overlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 10000; justify-content: center; align-items: center;">
    <div class="modal-content" style="background: linear-gradient(145deg, #1e2a47, #131e30); width: 90%; max-width: 500px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); border: 2px solid #e74c3c; position: relative; overflow: hidden;">
        <div style="position: absolute; top: -50%; left: -50%; width: 200%; height: 200%; background: linear-gradient(45deg, transparent, rgba(231, 76, 60, 0.1), transparent); transform: rotate(45deg); animation: alert-pulse 2s infinite;"></div>
        <style>
            @keyframes alert-pulse {
                0% { transform: rotate(45deg) scale(0.8); opacity: 0.7; }
                50% { transform: rotate(45deg) scale(1.1); opacity: 1; }
                100% { transform: rotate(45deg) scale(0.8); opacity: 0.7; }
            }
            @keyframes sound-wave {
                0%, 100% { height: 20%; opacity: 0.4; }
                50% { height: 100%; opacity: 1; }
            }
        </style>
        
        <div style="padding: 25px; text-align: center; position: relative; z-index: 2;">
            <div style="display: flex; justify-content: center; margin-bottom: 15px;">
                <div style="display: flex; gap: 4px; height: 40px; align-items: flex-end;">
                    <div class="wave-bar" style="width: 6px; background: #e74c3c; border-radius: 3px; animation: sound-wave 1.2s ease-in-out infinite;"></div>
                    <div class="wave-bar" style="width: 6px; background: #e74c3c; border-radius: 3px; animation: sound-wave 1.2s ease-in-out 0.2s infinite;"></div>
                    <div class="wave-bar" style="width: 6px; background: #e74c3c; border-radius: 3px; animation: sound-wave 1.2s ease-in-out 0.4s infinite;"></div>
                    <div class="wave-bar" style="width: 6px; background: #e74c3c; border-radius: 3px; animation: sound-wave 1.2s ease-in-out 0.6s infinite;"></div>
                    <div class="wave-bar" style="width: 6px; background: #e74c3c; border-radius: 3px; animation: sound-wave 1.2s ease-in-out 0.8s infinite;"></div>
                </div>
            </div>
            
            <h2 style="font-size: 1.8rem; color: #e74c3c; margin: 10px 0; text-shadow: 0 0 10px rgba(231, 76, 60, 0.7);">
                <i class="fas fa-exclamation-triangle"></i> ¡ALERTA CRÍTICA ETF!
            </h2>
            <p style="color: #f1c40f; font-size: 1.1rem; margin-bottom: 20px;">Caída del <span id="alert-drop-percent">50.00</span>% detectada</p>
            
            <div style="background: rgba(0, 30, 60, 0.8); border-radius: 12px; padding: 15px; margin: 15px 0;">
                <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                    <span style="color: #95a5a6;">Precio Referencia:</span>
                    <span id="alert-ref-price" style="font-weight: bold; color: #3498db;">$91,641.00</span>
                </div>
                <div style="display: flex; justify-content: space-between;">
                    <span style="color: #95a5a6;">Precio Actual:</span>
                    <span id="alert-current-price" style="font-weight: bold; color: #e74c3c; font-size: 1.2rem;">$45,820.50</span>
                </div>
            </div>
            
            <p style="color: #ecf0f1; margin: 15px 0; line-height: 1.5;">
                El valor del ETF ha caído a la mitad de tu precio de referencia. 
                <strong style="color: #f1c40f;">¡Requiere acción inmediata!</strong>
            </p>
            
            <div style="display: flex; gap: 12px; margin-top: 20px; justify-content: center;">
                <button id="acknowledge-alert" class="btn" style="padding: 10px 25px; background: linear-gradient(to right, #e74c3c, #c0392b); color: white; border: none; border-radius: 50px; font-weight: bold; min-width: 150px;">
                    <i class="fas fa-check"></i> Entendido
                </button>
                <button id="reset-etf-reference" class="btn" style="padding: 10px 25px; background: linear-gradient(to right, #3498db, #2980b9); color: white; border: none; border-radius: 50px; font-weight: bold; min-width: 150px;">
                    <i class="fas fa-sync-alt"></i> Nueva Referencia
                </button>
            </div>
            
            <div style="margin-top: 20px; padding-top: 15px; border-top: 1px solid rgba(255,255,255,0.1); font-size: 0.85rem; color: #95a5a6;">
                <i class="fas fa-info-circle" style="margin-right: 5px;"></i>
                Esta alerta se activó automáticamente por tu configuración de monitoreo ETF en C5X
            </div>
        </div>
    </div>
</div>

<!-- Insertar ESTE SCRIPT al final de tus scripts existentes (antes de </body>) -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Solo activar si estamos en la sección MONITOR ETF
    const monitorSection = document.querySelector('.monitor-etf-section, [data-section="monitor-etf"], #monitor-etf-container');
    if (!monitorSection) return;
    
    // Mostrar el sistema de alertas en el monitor ETF
    const alertContainer = document.getElementById('etf-alert-system');
    if (alertContainer) alertContainer.style.display = 'block';
    
    // Variables del sistema
    const etfAlertSystem = {
        referencePrice: parseFloat(localStorage.getItem('c5x_etf_reference') || '0'),
        alertEnabled: JSON.parse(localStorage.getItem('c5x_etf_alert_enabled') || 'true'),
        threshold: parseFloat(localStorage.getItem('c5x_etf_threshold') || '50'),
        audioContext: null,
        alertTriggered: false,
        priceElement: null, // Referencia al elemento de precio actual del ETF en tu app
        
        init() {
            this.bindElements();
            this.loadSettings();
            this.setupAudio();
            this.startMonitoring();
            this.updateUI();
            
            // Registrar en bitácora de C5X si existe la función
            if (typeof addToBitacora === 'function') {
                addToBitacora('Sistema de alertas ETF inicializado', 'INFO');
            }
        },
        
        bindElements() {
            this.toggle = document.getElementById('etf-alert-toggle');
            this.thresholdSelect = document.getElementById('etf-alert-threshold');
            this.referencePriceEl = document.getElementById('etf-reference-price');
            this.dropPercentageEl = document.getElementById('etf-drop-percentage');
            this.progressFill = document.getElementById('etf-progress-fill');
            this.setStatusEl = document.getElementById('alert-status');
            this.currentThresholdEl = document.getElementById('current-threshold');
            this.setReferenceBtn = document.getElementById('set-etf-reference');
            this.testAlertBtn = document.getElementById('test-etf-alert');
            this.criticalModal = document.getElementById('etf-critical-alert');
            this.acknowledgeBtn = document.getElementById('acknowledge-alert');
            this.resetRefBtn = document.getElementById('reset-etf-reference');
            this.alertDropPercentEl = document.getElementById('alert-drop-percent');
            this.alertRefPriceEl = document.getElementById('alert-ref-price');
            this.alertCurrentPriceEl = document.getElementById('alert-current-price');
            
            // Encontrar el elemento de precio actual del ETF en tu interfaz existente
            // Ajusta este selector según tu estructura real
            this.priceElement = document.querySelector('#current-etf-price, .etf-price-display, [data-etf-price]');
            
            // Eventos
            this.toggle.addEventListener('change', () => this.toggleAlerts());
            this.thresholdSelect.addEventListener('change', (e) => this.setThreshold(e.target.value));
            this.setReferenceBtn.addEventListener('click', () => this.setReferencePrice());
            this.testAlertBtn.addEventListener('click', () => this.testAlert());
            this.acknowledgeBtn.addEventListener('click', () => this.acknowledgeAlert());
            this.resetRefBtn.addEventListener('click', () => this.resetReferenceFromAlert());
        },
        
        loadSettings() {
            this.toggle.checked = this.alertEnabled;
            this.thresholdSelect.value = this.threshold;
            this.currentThresholdEl.textContent = this.threshold;
            if (this.referencePrice > 0) {
                this.referencePriceEl.textContent = '$' + this.formatPrice(this.referencePrice);
                this.setStatusEl.style.display = 'block';
                this.setStatusEl.style.background = 'rgba(46, 204, 113, 0.15)';
                this.setStatusEl.innerHTML = `<i class="fas fa-check-circle" style="color: #2ecc71; margin-right: 5px;"></i> Alertas activas. Monitoreando caída ≥ ${this.threshold}%`;
            }
        },
        
        setupAudio() {
            // Inicializar audio solo tras interacción del usuario
            document.addEventListener('click', () => {
                if (!this.audioContext) {
                    try {
                        window.AudioContext = window.AudioContext || window.webkitAudioContext;
                        this.audioContext = new AudioContext();
                    } catch (e) {
                        console.warn('Web Audio API no soportado', e);
                    }
                }
            }, { once: true });
        },
        
        startMonitoring() {
            // Integrarse con el ciclo de actualización de precios existente de C5X
            // Este intervalo verifica el precio cada 2 segundos (ajustable)
            setInterval(() => {
                if (!this.alertEnabled || this.alertTriggered || !this.referencePrice) return;
                
                // Obtener precio actual desde tu interfaz existente
                let currentPrice = 0;
                if (this.priceElement) {
                    const priceText = this.priceElement.textContent || this.priceElement.innerText;
                    currentPrice = parseFloat(priceText.replace(/[^0-9.-]/g, ''));
                }
                
                // Si no hay precio, intentar obtener de otras fuentes de tu app
                if (!currentPrice && typeof getCurrentEtfPrice === 'function') {
                    currentPrice = getCurrentEtfPrice();
                }
                
                if (currentPrice > 0 && this.referencePrice > 0) {
                    this.checkAlertCondition(currentPrice);
                }
            }, 2000);
        },
        
        checkAlertCondition(currentPrice) {
            const dropPercent = ((this.referencePrice - currentPrice) / this.referencePrice) * 100;
            const threshold = parseFloat(this.thresholdSelect.value);
            
            // Actualizar UI de monitoreo
            this.dropPercentageEl.textContent = dropPercent.toFixed(2) + '%';
            this.dropPercentageEl.style.color = dropPercent >= 40 ? '#e74c3c' : '#f39c12';
            
            // Actualizar barra de progreso (escalar para que 50% = 100% de la barra)
            const progressWidth = Math.min(100, (dropPercent / threshold) * 100);
            this.progressFill.style.width = `${progressWidth}%`;
            this.progressFill.style.background = dropPercent >= threshold * 0.9 ? 
                'linear-gradient(to right, #e74c3c, #c0392b)' : 
                'linear-gradient(to right, #3498db, #2ecc71)';
            
            // Verificar condición de alerta
            if (dropPercent >= threshold && !this.alertTriggered) {
                this.triggerCriticalAlert(dropPercent, currentPrice);
            }
        },
        
        triggerCriticalAlert(dropPercent, currentPrice) {
            this.alertTriggered = true;
            
            // Actualizar modal
            this.alertDropPercentEl.textContent = dropPercent.toFixed(2);
            this.alertRefPriceEl.textContent = '$' + this.formatPrice(this.referencePrice);
            this.alertCurrentPriceEl.textContent = '$' + this.formatPrice(currentPrice);
            
            // Mostrar modal
            this.criticalModal.style.display = 'flex';
            
            // Reproducir sonido si está habilitado
            if (this.audioContext && this.audioContext.state === 'running') {
                this.playAlertSound();
            }
            
            // Vibración en móviles
            if (navigator.vibrate && window.innerWidth < 768) {
                navigator.vibrate([500, 200, 500, 200, 500]);
            }
            
            // Registrar en bitácora de C5X
            if (typeof addToBitacora === 'function') {
                addToBitacora(`ALERTA CRÍTICA: ETF caído ${dropPercent.toFixed(2)}% a $${this.formatPrice(currentPrice)}`, 'ALERT');
            }
            
            // Notificación push si está permitida
            if (Notification.permission === 'granted') {
                new Notification('C5X ALERTA CRÍTICA', {
                    body: `ETF caído ${dropPercent.toFixed(2)}% - Precio: $${this.formatPrice(currentPrice)}`,
                    icon: 'https://tu-dominio.com/favicon.ico'
                });
            }
        },
        
        playAlertSound() {
            if (!this.audioContext) return;
            
            // Generar sonido de alerta usando Web Audio API (sin archivos externos)
            const playTone = (frequency, duration, delay = 0) => {
                return new Promise((resolve) => {
                    setTimeout(() => {
                        try {
                            const oscillator = this.audioContext.createOscillator();
                            const gainNode = this.audioContext.createGain();
                            
                            oscillator.connect(gainNode);
                            gainNode.connect(this.audioContext.destination);
                            
                            oscillator.type = 'square';
                            oscillator.frequency.value = frequency;
                            
                            // Envolvente de ganancia para evitar clics
                            gainNode.gain.setValueAtTime(0, this.audioContext.currentTime);
                            gainNode.gain.linearRampToValueAtTime(0.3, this.audioContext.currentTime + 0.01);
                            gainNode.gain.linearRampToValueAtTime(0, this.audioContext.currentTime + duration - 0.01);
                            
                            oscillator.start();
                            oscillator.stop(this.audioContext.currentTime + duration);
                            
                            oscillator.onended = () => {
                                oscillator.disconnect();
                                gainNode.disconnect();
                                resolve();
                            };
                        } catch (e) {
                            resolve();
                        }
                    }, delay * 1000);
                });
            };
            
            // Secuencia de alerta: patrón distintivo de emergencia
            const alertSequence = async () => {
                for (let i = 0; i < 3; i++) {
                    await playTone(880, 0.3); // Nota alta
                    await playTone(660, 0.4); // Nota media-baja
                    if (i < 2) await new Promise(res => setTimeout(res, 300));
                }
            };
            
            alertSequence();
        },
        
        setReferencePrice() {
            // Obtener precio actual desde tu interfaz
            let currentPrice = 0;
            if (this.priceElement) {
                const priceText = this.priceElement.textContent || this.priceElement.innerText;
                currentPrice = parseFloat(priceText.replace(/[^0-9.-]/g, ''));
            }
            
            if (currentPrice <= 0) {
                if (typeof showC5XNotification === 'function') {
                    showC5XNotification('Error: Precio actual no disponible', 'error');
                }
                return;
            }
            
            this.referencePrice = currentPrice;
            localStorage.setItem('c5x_etf_reference', currentPrice.toString());
            this.referencePriceEl.textContent = '$' + this.formatPrice(currentPrice);
            
            // Resetear estado de alerta
            this.alertTriggered = false;
            if (this.criticalModal) this.criticalModal.style.display = 'none';
            
            // Actualizar UI
            this.setStatusEl.style.display = 'block';
            this.setStatusEl.style.background = 'rgba(46, 204, 113, 0.15)';
            this.setStatusEl.innerHTML = `<i class="fas fa-check-circle" style="color: #2ecc71; margin-right: 5px;"></i> Alertas activas. Monitoreando caída ≥ ${this.threshold}%`;
            
            // Registrar en bitácora
            if (typeof addToBitacora === 'function') {
                addToBitacora(`Precio de referencia ETF establecido: $${this.formatPrice(currentPrice)}`, 'INFO');
            }
            
            if (typeof showC5XNotification === 'function') {
                showC5XNotification(`Referencia ETF actualizada: $${this.formatPrice(currentPrice)}`, 'success');
            }
        },
        
        toggleAlerts() {
            this.alertEnabled = this.toggle.checked;
            localStorage.setItem('c5x_etf_alert_enabled', this.alertEnabled.toString());
            
            if (this.alertEnabled) {
                this.setStatusEl.style.display = 'block';
                this.setStatusEl.style.background = 'rgba(46, 204, 113, 0.15)';
                this.setStatusEl.innerHTML = `<i class="fas fa-check-circle" style="color: #2ecc71; margin-right: 5px;"></i> Alertas activas. Monitoreando caída ≥ ${this.threshold}%`;
            } else {
                this.setStatusEl.style.display = 'none';
            }
            
            if (typeof addToBitacora === 'function') {
                addToBitacora(`Alertas ETF ${this.alertEnabled ? 'activadas' : 'desactivadas'}`, 'INFO');
            }
        },
        
        setThreshold(value) {
            this.threshold = parseFloat(value);
            localStorage.setItem('c5x_etf_threshold', value);
            this.currentThresholdEl.textContent = value;
            
            if (this.setStatusEl.style.display !== 'none') {
                this.setStatusEl.innerHTML = `<i class="fas fa-check-circle" style="color: #2ecc71; margin-right: 5px;"></i> Alertas activas. Monitoreando caída ≥ ${value}%`;
            }
            
            if (typeof addToBitacora === 'function') {
                addToBitacora(`Umbral de alerta ETF cambiado a ${value}%`, 'INFO');
            }
        },
        
        acknowledgeAlert() {
            this.criticalModal.style.display = 'none';
            // No reseteamos referencia, solo acknowledgeamos
            if (typeof addToBitacora === 'function') {
                addToBitacora('Alerta ETF acknowledgeada por usuario', 'INFO');
            }
        },
        
        resetReferenceFromAlert() {
            this.setReferencePrice(); // Reutiliza la lógica existente
            this.criticalModal.style.display = 'none';
        },
        
        testAlert() {
            if (!this.referencePrice) {
                if (typeof showC5XNotification === 'function') {
                    showC5XNotification('Establece primero un precio de referencia', 'warning');
                }
                this.setReferencePrice(); // Intentar establecer con precio actual
                return;
            }
            
            // Simular caída crítica para prueba
            const testPrice = this.referencePrice * (1 - this.threshold/100);
            this.triggerCriticalAlert(this.threshold, testPrice);
            
            if (typeof addToBitacora === 'function') {
                addToBitacora('Prueba de alerta ETF ejecutada', 'INFO');
            }
        },
        
        formatPrice(value) {
            return value.toFixed(2).replace(/\d(?=(\d{3})+\.)/g, '$&,');
        },
        
        updateUI() {
            // Actualizar estado inicial
            this.toggle.checked = this.alertEnabled;
            this.thresholdSelect.value = this.threshold.toString();
        }
    };
    
    // Inicializar sistema SOLO si existe el contenedor de alertas
    if (document.getElementById('etf-alert-system')) {
        // Esperar a que C5X termine de cargar completamente
        if (document.readyState === 'complete') {
            etfAlertSystem.init();
        } else {
            window.addEventListener('load', () => etfAlertSystem.init());
        }
    }
    
    // Integración con sistema de notificaciones existente de C5X
    window.triggerEtfAlertTest = () => {
        if (typeof etfAlertSystem !== 'undefined') {
            etfAlertSystem.testAlert();
        }
    };
});
</script>

<style>
/* Estilos minimalistas que se integran con tu tema C5X existente */
.toggle-switch {
    position: relative; width: 48px; height: 26px;
}
.toggle-switch input { opacity: 0; width: 0; height: 0; }
.slider {
    position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0;
    background-color: #34495e; transition: .4s; border-radius: 34px;
}
.slider:before {
    position: absolute; content: ""; height: 18px; width: 18px; left: 4px; bottom: 4px;
    background-color: white; transition: .4s; border-radius: 50%;
}
input:checked + .slider { background-color: #2ecc71; }
input:checked + .slider:before { transform: translateX(22px); }
input:checked + .slider.danger { background-color: #e74c3c; }

.modal-overlay {
    animation: fadeIn 0.3s ease-out;
}
@keyframes fadeIn {
    from { opacity: 0; } to { opacity: 1; }
}

/* Respetar tema oscuro de C5X */
.etf-alert-container {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
}
.setting-control {
    background: rgba(40,50,70,0.9) !important;
    border: 1px solid #34495e !important;
    color: white !important;
}
.btn {
    cursor: pointer;
    transition: all 0.2s ease;
}
.btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.3);
}
</style>