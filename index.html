<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>C5X - V18</title>
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon.png">
    <meta name="theme-color" content="#050708">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@600;900&family=Roboto:wght@400;700;900&family=Roboto+Mono:wght@700;900&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --bg: #050708; --surface: #12151a; --text: #f0f2f5; 
            --border: #2d3339; --header-bg: #12151a;
            --dir-color: #3498db; --long-green: #0ecb81; --short-red: #f6465d;
            --warning: #f1c40f; --danger: #e74c3c;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
        body { 
            background: var(--bg); color: var(--text); 
            font-family: 'Roboto', sans-serif; overflow-x: hidden;
            display: flex; flex-direction: column; height: 100vh;
        }
        
        /* HEADER */
        header {
            background: var(--header-bg); padding: 10px 15px;
            display: flex; justify-content: space-between; align-items: center;
            border-bottom: 1px solid var(--border);
        }
        .logo { font-family: 'Orbitron', sans-serif; font-weight: 900; color: var(--dir-color); font-size: 20px; letter-spacing: 2px; }
        .btc-ticker { font-family: 'Roboto Mono', monospace; font-size: 14px; display: flex; align-items: center; gap: 8px; }
        .status-dot { width: 8px; height: 8px; background: #95a5a6; border-radius: 50%; }
        .status-dot.online { background: var(--long-green); box-shadow: 0 0 8px var(--long-green); }

        /* SLOTS BAR */
        .slots-bar {
            display: flex; overflow-x: auto; background: var(--surface);
            padding: 10px; gap: 8px; border-bottom: 1px solid var(--border);
        }
        .slot-pill {
            padding: 6px 15px; border-radius: 20px; background: #1c2127;
            font-size: 12px; font-weight: 700; white-space: nowrap; border: 1px solid transparent;
            color: #7f8c8d; cursor: pointer; transition: 0.2s;
        }
        .slot-pill.active { background: var(--dir-color); color: white; border-color: #5dade2; }

        /* MAIN CONTENT */
        main { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 15px; }

        .card { background: var(--surface); border-radius: 12px; padding: 15px; border: 1px solid var(--border); }
        .grid-inputs { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        .input-group label { display: block; font-size: 10px; color: #7f8c8d; margin-bottom: 4px; text-transform: uppercase; font-weight: 700; }
        .input-group input {
            width: 100%; background: #050708; border: 1px solid var(--border);
            color: white; padding: 10px; border-radius: 6px; font-family: 'Roboto Mono', monospace; font-size: 16px;
        }

        /* DCA TABLE */
        .dca-table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 13px; }
        .dca-table th { text-align: left; color: #7f8c8d; padding-bottom: 8px; font-size: 10px; }
        .dca-table td { padding: 8px 0; border-top: 1px solid #1c2127; font-family: 'Roboto Mono', monospace; }
        .row-active { color: var(--long-green); font-weight: 700; }
        .btn-check { width: 24px; height: 24px; border-radius: 4px; border: 2px solid var(--border); display: flex; align-items: center; justify-content: center; cursor: pointer; }
        .btn-check.on { background: var(--dir-color); border-color: var(--dir-color); color: white; }

        /* SUMMARY */
        .summary { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; background: #1c2127; border-radius: 8px; padding: 12px; }
        .sum-item .label { font-size: 10px; color: #7f8c8d; }
        .sum-item .val { font-size: 16px; font-weight: 900; font-family: 'Roboto Mono', monospace; }

        /* ACTIONS */
        .actions { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 5px; }
        .btn { border: none; padding: 12px; border-radius: 8px; font-weight: 900; font-size: 12px; cursor: pointer; text-transform: uppercase; letter-spacing: 1px; }
        .btn-close { background: var(--danger); color: white; }
        .btn-reset { background: #34495e; color: white; }
        .btn-backup { background: #27ae60; color: white; margin-top: 10px; grid-column: span 2; }

        /* HISTORIAL */
        .history-section { margin-top: 20px; }
        .history-item { 
            background: #0d1014; padding: 10px; border-radius: 6px; margin-bottom: 8px; 
            border-left: 4px solid var(--long-green); font-size: 12px;
        }

        /* TOAST */
        #toast {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            background: var(--dir-color); color: white; padding: 10px 20px;
            border-radius: 30px; font-size: 12px; font-weight: 700; opacity: 0; transition: 0.3s; pointer-events: none; z-index: 1000;
        }

        .hidden { display: none; }
    </style>
</head>
<body>

    <header>
        <div class="logo">C5X <span style="font-size: 10px; vertical-align: middle; color: #7f8c8d;">V18</span></div>
        <div class="btc-ticker">
            <div id="dot" class="status-dot"></div>
            <span id="btcPrice">0.00</span>
        </div>
    </header>

    <div class="slots-bar" id="slotsBar"></div>

    <main>
        <div class="card">
            <div class="grid-inputs">
                <div class="input-group">
                    <label>Moneda / Slot</label>
                    <input type="text" id="coinName" placeholder="BTC3L" oninput="updateSlotName(this.value)">
                </div>
                <div class="input-group">
                    <label>P. Base</label>
                    <input type="number" id="basePrice" step="any" inputmode="decimal" placeholder="0.0000" oninput="calc()">
                </div>
                <div class="input-group">
                    <label>Capital Inicial</label>
                    <input type="number" id="baseCap" step="any" inputmode="decimal" placeholder="10.00" oninput="calc()">
                </div>
                <div class="input-group">
                    <label>% CaÃ­da DCA</label>
                    <input type="number" id="dropPct" step="0.1" inputmode="decimal" placeholder="5.0" oninput="calc()">
                </div>
            </div>

            <table class="dca-table">
                <thead>
                    <tr>
                        <th>NIVEL</th>
                        <th>PRECIO</th>
                        <th>INVERSIÃ“N</th>
                        <th>CHECK</th>
                    </tr>
                </thead>
                <tbody id="dcaBody"></tbody>
            </table>
        </div>

        <div class="summary">
            <div class="sum-item">
                <div class="label">TOTAL INVERTIDO</div>
                <div class="val" id="totalInv">$0.00</div>
            </div>
            <div class="sum-item">
                <div class="label">PRECIO AVG</div>
                <div class="val" id="avgPrice" style="color:var(--warning)">$0.00</div>
            </div>
        </div>

        <div class="actions">
            <button class="btn btn-reset" onclick="resetSlot()">RESETEAR</button>
            <button class="btn btn-close" onclick="closeOperation()">CERRAR OP</button>
            <button class="btn btn-backup" onclick="exportData()">ðŸ’¾ EXPORTAR COPIA SEGURIDAD</button>
            <button class="btn btn-backup" style="background:#8e44ad;" onclick="document.getElementById('importFile').click()">ðŸ“‚ IMPORTAR COPIA</button>
            <input type="file" id="importFile" class="hidden" accept=".json" onchange="importData(event)">
        </div>

        <div class="history-section">
            <h4 style="font-size: 10px; color: #7f8c8d; margin-bottom: 10px; letter-spacing: 1px;">HISTORIAL DE CIERRES</h4>
            <div id="historyList"></div>
        </div>
    </main>

    <div id="toast">MENSAJE</div>

    <script>
        let slots = JSON.parse(localStorage.getItem('c5x_v18_slots')) || Array.from({length:10}, () => ({
            name: '', basePrice: '', baseCap: '', dropPct: '', buys: []
        }));
        let history = JSON.parse(localStorage.getItem('c5x_v18_history')) || [];
        let activeIdx = 0;

        function init() {
            renderSlots();
            renderHistory();
            loadSlot(0);
            connectBinance();
        }

        function renderSlots() {
            const bar = document.getElementById('slotsBar');
            bar.innerHTML = slots.map((s, i) => `
                <div class="slot-pill ${i === activeIdx ? 'active' : ''}" onclick="loadSlot(${i})">
                    ${s.name || 'SLOT ' + (i+1)}
                </div>
            `).join('');
        }

        function loadSlot(idx) {
            activeIdx = idx;
            const s = slots[idx];
            document.getElementById('coinName').value = s.name;
            document.getElementById('basePrice').value = s.basePrice;
            document.getElementById('baseCap').value = s.baseCap;
            document.getElementById('dropPct').value = s.dropPct;
            renderSlots();
            calc();
        }

        function updateSlotName(val) {
            slots[activeIdx].name = val.toUpperCase();
            renderSlots();
            save();
        }

        function calc() {
            const bp = parseFloat(document.getElementById('basePrice').value) || 0;
            const bc = parseFloat(document.getElementById('baseCap').value) || 0;
            const dp = parseFloat(document.getElementById('dropPct').value) || 0;
            
            slots[activeIdx].basePrice = document.getElementById('basePrice').value;
            slots[activeIdx].baseCap = document.getElementById('baseCap').value;
            slots[activeIdx].dropPct = document.getElementById('dropPct').value;

            const tbody = document.getElementById('dcaBody');
            tbody.innerHTML = '';

            let totalInversion = 0;
            let totalTokens = 0;

            for(let i=0; i<7; i++) {
                const levelPrice = i === 0 ? bp : bp * (1 - (dp * i / 100));
                const levelCap = bc * Math.pow(2, i);
                const isBought = slots[activeIdx].buys.includes(i);

                if(isBought && bp > 0) {
                    totalInversion += levelCap;
                    totalTokens += (levelCap / levelPrice);
                }

                if(bp > 0) {
                    const tr = document.createElement('tr');
                    if(isBought) tr.className = 'row-active';
                    tr.innerHTML = `
                        <td>${i === 0 ? 'BASE' : 'DCA ' + i}</td>
                        <td onclick="copyText('${levelPrice.toFixed(4)}')">${levelPrice.toFixed(4)}</td>
                        <td>$${levelCap.toFixed(2)}</td>
                        <td><div class="btn-check ${isBought ? 'on' : ''}" onclick="toggleBuy(${i})">${isBought ? 'âœ“' : ''}</div></td>
                    `;
                    tbody.appendChild(tr);
                }
            }

            const avg = totalTokens > 0 ? totalInversion / totalTokens : 0;
            document.getElementById('totalInv').textContent = `$${totalInversion.toFixed(2)}`;
            document.getElementById('avgPrice').textContent = `$${avg.toFixed(4)}`;
            save();
        }

        function toggleBuy(lvl) {
            const buys = slots[activeIdx].buys;
            if(buys.includes(lvl)) {
                slots[activeIdx].buys = buys.filter(x => x !== lvl);
            } else {
                slots[activeIdx].buys.push(lvl);
            }
            calc();
        }

        function resetSlot() {
            if(confirm('Â¿Reiniciar este slot?')) {
                slots[activeIdx] = { name: '', basePrice: '', baseCap: '', dropPct: '', buys: [] };
                loadSlot(activeIdx);
            }
        }

        function closeOperation() {
            const s = slots[activeIdx];
            if(s.buys.length === 0) return;
            
            const record = {
                date: new Date().toLocaleString(),
                coin: s.name || 'Token',
                total: document.getElementById('totalInv').textContent,
                avg: document.getElementById('avgPrice').textContent
            };
            
            history.unshift(record);
            if(history.length > 20) history.pop();
            
            localStorage.setItem('c5x_v18_history', JSON.stringify(history));
            showToast("OP. CERRADA Y GUARDADA");
            resetSlot();
            renderHistory();
        }

        function renderHistory() {
            const container = document.getElementById('historyList');
            container.innerHTML = history.map(h => `
                <div class="history-item">
                    <strong>${h.coin}</strong> - ${h.date}<br>
                    <span style="color:#7f8c8d">Invertido: ${h.total} | AVG: ${h.avg}</span>
                </div>
            `).join('');
        }

        function exportData() {
            const data = { slots, history, version: 'V18' };
            const blob = new Blob([JSON.stringify(data)], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `C5X_Backup_${new Date().toISOString().slice(0,10)}.json`;
            a.click();
            showToast("BACKUP DESCARGADO");
        }

        function importData(event) {
            const file = event.target.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const imported = JSON.parse(e.target.result);
                    if(imported.slots) {
                        slots = imported.slots;
                        history = imported.history || [];
                        save();
                        localStorage.setItem('c5x_v18_history', JSON.stringify(history));
                        init();
                        showToast("DATOS IMPORTADOS");
                    }
                } catch(err) { alert("Error al leer archivo"); }
            };
            reader.readAsText(file);
        }

        function copyText(txt) {
            navigator.clipboard.writeText(txt);
            showToast("PRECIO COPIADO: " + txt);
        }

        function showToast(msg) {
            const t = document.getElementById('toast');
            t.textContent = msg;
            t.style.opacity = 1;
            setTimeout(() => t.style.opacity = 0, 2000);
        }

        function save() { localStorage.setItem('c5x_v18_slots', JSON.stringify(slots)); }

        function connectBinance() {
            const ws = new WebSocket('wss://stream.binance.com:9443/ws/btcusdt@ticker');
            ws.onmessage = (e) => {
                const data = JSON.parse(e.data);
                document.getElementById('btcPrice').textContent = parseFloat(data.c).toLocaleString();
                document.getElementById('dot').classList.add('online');
            };
            ws.onclose = () => {
                document.getElementById('dot').classList.remove('online');
                setTimeout(connectBinance, 5000);
            };
        }

        window.onload = init;
    </script>
</body>
</html>
