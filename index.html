<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>C5X - V44.0 AUTO-PILOT</title>
    <meta name="theme-color" content="#0b0e11">
    
    <link rel="manifest" href="manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="icon" type="image/png" href="icon.png">
    
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@500;600;700;800&family=JetBrains+Mono:wght@500;700;800&family=Orbitron:wght@600;900&display=swap" rel="stylesheet">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <script src="https://s3.tradingview.com/tv.js"></script>

    <style>
        :root {
            --bg: #0b0e11; --surface: #151a21; --surface-glass: rgba(21, 26, 33, 0.98);
            --card-bg: rgba(255, 255, 255, 0.03); --text-primary: #eaecef; --text-secondary: #848e9c;
            --text-tertiary: #5e6673; --brand: #3b82f6; --long: #0ecb81; --short: #f6465d;
            --warning: #f0b90b; --danger: #cf304a; --border: #2b3139; --radius-m: 16px;
            --drive: #34A853; 
            /* COLOR ORO FIJO */
            --gold-fixed: #f0b90b;
            --chart-bg: #000000; --safe-top: env(safe-area-inset-top, 20px);
            --safe-bottom: env(safe-area-inset-bottom, 20px);
            --skeleton: rgba(255,255,255,0.05);
        }
        body.light-mode {
            --bg: #f5f7fa !important; --surface: #ffffff !important;
            --surface-glass: rgba(255, 255, 255, 0.98) !important; --card-bg: #ffffff !important;
            --text-primary: #1e2329 !important; --text-secondary: #707a8a !important;
            --border: #e6e8ea !important; --chart-bg: #ffffff !important; --warning: #d97706 !important;
            --skeleton: rgba(0,0,0,0.05) !important;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        body { 
            font-family: 'Rajdhani', sans-serif; font-weight: 600;
            background: var(--bg); color: var(--text-primary); 
            padding-top: var(--safe-top); padding-bottom: calc(20px + var(--safe-bottom)); 
            overflow-x: hidden; user-select: none; font-size: 16px; 
            overscroll-behavior-y: none; 
        }

        /* --- ANIMACIONES --- */
        @keyframes click-pop { 0% { transform: scale(1); } 50% { transform: scale(0.95); } 100% { transform: scale(1); } }
        @keyframes spin-slow { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @keyframes pulse-ring { 0% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.4); } 70% { box-shadow: 0 0 0 6px rgba(59, 130, 246, 0); } 100% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0); } }
        @keyframes slide-in { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes grow-up { from { height: 0; opacity: 0; } to { opacity: 1; } }
        @keyframes shimmer { 0% { background-position: -200% 0; } 100% { background-position: 200% 0; } }
        @keyframes flash-green { 0% { background-color: rgba(14, 203, 129, 0); } 50% { background-color: rgba(14, 203, 129, 0.3); } 100% { background-color: rgba(14, 203, 129, 0); } }

        .anim-click:active { animation: click-pop 0.2s ease-in-out; }
        .anim-spin { animation: spin-slow 8s linear infinite; }
        .anim-pulse { animation: pulse-ring 2s infinite; }
        .section-enter { animation: slide-in 0.4s cubic-bezier(0.16, 1, 0.3, 1); }
        .flash-buy { animation: flash-green 1s ease-out; }

        /* SKELETON LOADER */
        .skeleton-box {
            background: var(--skeleton);
            background: linear-gradient(90deg, var(--skeleton) 25%, var(--card-bg) 50%, var(--skeleton) 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
            border-radius: 4px;
            color: transparent !important;
        }
        .skeleton-text { display: inline-block; min-width: 40px; min-height: 1em; border-radius: 4px; }

        /* ICONOS CLEAN */
        svg { fill: none; stroke: currentColor; stroke-linecap: round; stroke-linejoin: round; stroke-width: 1.5; pointer-events: none; /* CRITICO PARA BOTONES */ }

        /* --- COMPONENTES UI --- */
        #toast { 
            visibility: hidden; width: 90%; max-width: 400px;
            background-color: var(--surface); border: 1px solid var(--border);
            color: var(--text-primary); text-align: center; border-radius: 12px; 
            padding: 16px; position: fixed; z-index: 9999; 
            left: 50%; top: -100px; transform: translateX(-50%); 
            font-weight: 700; font-size: 14px; font-family: 'Orbitron', sans-serif;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            transition: top 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275), opacity 0.4s ease; opacity: 0;
        }
        #toast.show { top: calc(10px + var(--safe-top)); visibility: visible; opacity: 1; }
        #toast.alert-mode { background-color: rgba(207, 48, 74, 0.98); color: #fff; border: 1px solid #ff4d4d; }
        #toast.success-mode { background-color: rgba(14, 203, 129, 0.98); color: #fff; border: 1px solid #0ecb81; }

        .fixed-header { position: fixed; top: 0; left: 0; width: 100%; z-index: 1000; background: var(--surface-glass); backdrop-filter: blur(12px); border-bottom: 1px solid var(--border); padding-top: var(--safe-top); }
        .app-header { display: flex; justify-content: space-between; align-items: center; height: 50px; padding: 0 16px; max-width: 800px; margin: 0 auto; position: relative; }
        .brand-btn { display: flex; align-items: center; gap: 6px; cursor: pointer; padding: 5px; }
        .brand-text { font-family: 'Orbitron', sans-serif; font-weight: 900; font-size: 24px; color: var(--brand); line-height: 1; }
        
        .ticker-container { position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%); display: flex; align-items: center; gap: 8px; }
        .ticker-pill { display: flex; align-items: center; gap: 10px; background: rgba(255,255,255,0.03); border: 1px solid var(--border); padding: 4px 12px; border-radius: 24px; height: 32px; }
        .ticker-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--text-secondary); transition: background 0.3s; }
        .ticker-dot.pulse { animation: pulse-ring 1.5s infinite; }
        .ticker-sym { font-family: 'Orbitron', sans-serif; font-weight: 800; font-size: 13px; color: var(--text-secondary); }
        .ticker-price { font-family: 'JetBrains Mono', monospace; font-weight: 800; font-size: 16px; color: var(--text-primary); }
        
        .pin-btn { width: 30px; height: 30px; border-radius: 50%; background: transparent; border: 1px solid transparent; display: flex; align-items: center; justify-content: center; color: var(--text-secondary); }
        .pin-btn.pinned { color: var(--brand); background: rgba(59, 130, 246, 0.1); }
        .theme-btn { width: 36px; height: 36px; border-radius: 50%; background: transparent; border: 1px solid var(--border); color: var(--text-primary); display: flex; align-items: center; justify-content: center; font-size: 16px; }

        .content-spacer { margin-top: 92px; max-width: 800px; margin-left: auto; margin-right: auto; padding: 0 4px; }
        .app-section { display: none; opacity: 0; transition: opacity 0.2s ease; }
        .app-section.active { display: block; opacity: 1; animation: slide-in 0.3s ease-out; }

        .tf-bar { display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px; padding: 4px 12px 8px 12px; border-bottom: 1px solid var(--border); justify-content: center; }
        .tf-btn { background: transparent; border: none; color: var(--text-tertiary); padding: 4px 0; text-align: center; font-family: sans-serif; font-size: 12px; font-weight: 700; border-radius: 8px; transition: all 0.2s; }
        .tf-btn.active { color: var(--brand); background: rgba(59, 130, 246, 0.1); font-weight: 800; }

        .slot-nav { display: grid; grid-template-columns: repeat(5, 1fr); gap: 6px; padding: 8px 10px; position: sticky; top: calc(90px + var(--safe-top)); z-index: 900; background: var(--bg); border-bottom: 1px solid var(--border); margin-bottom: 10px; }
        .slot-card { background: transparent; color: var(--text-tertiary); padding: 10px 0; text-align: center; font-size: 14px; font-weight: 700; border-radius: 8px; position: relative; transition: all 0.3s; }
        .slot-card.active { color: var(--text-primary); background: rgba(255,255,255,0.02); font-weight: 800; }
        .slot-card.active::after { content: ''; position: absolute; bottom: 0; left: 25%; right: 25%; height: 3px; background: var(--brand); border-radius: 3px 3px 0 0; }
        .slot-card.has-profit:not(.active)::before { content: '‚Ä¢'; position: absolute; bottom: 2px; left: 0; right: 0; color: var(--long); font-size: 14px; line-height: 0; }

        .chart-wrapper { height: 280px; background: var(--chart-bg); margin: 0 10px; border-radius: var(--radius-m); border: 1px solid var(--border); overflow: hidden; position: relative; }
        .chart-wrapper.fullscreen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 5000; margin: 0; border-radius: 0; border: none; padding-top: var(--safe-top); padding-bottom: var(--safe-bottom); background: var(--bg); }
        .chart-fs-btn { position: absolute; bottom: 10px; right: 10px; z-index: 20; width: 30px; height: 30px; background: rgba(128,128,128,0.2); border-radius: 6px; display: flex; align-items: center; justify-content: center; color: var(--text-primary); backdrop-filter: blur(4px); }

        .controls-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; padding: 10px; }
        .input-group { background: var(--card-bg); border: 1px solid var(--border); border-radius: var(--radius-m); padding: 8px; text-align: center; transition: border-color 0.3s; }
        .input-group:focus-within { border-color: var(--brand); }
        .input-label { font-size: 10px; color: var(--text-secondary); font-weight: 700; text-transform: uppercase; display: block; margin-bottom: 2px; }
        .input-field { width: 100%; background: transparent; border: none; color: var(--text-primary); font-family: 'JetBrains Mono', monospace; font-size: 15px; font-weight: 700; text-align: center; }
        
        .dashboard-card { background: var(--surface); border: 1px solid var(--border); border-radius: 24px; margin: 0 10px 15px; padding: 15px 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); position: relative; overflow: hidden; }
        .dashboard-card::before { content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 4px; background: linear-gradient(90deg, var(--brand), var(--long)); }
        
        .radar-ticker-large { background: rgba(59, 130, 246, 0.08); border: 1px solid rgba(59, 130, 246, 0.3); border-radius: 16px; padding: 20px 12px; text-align: center; margin-bottom: 20px; min-height: 80px; display:flex; flex-direction:column; justify-content:center; }
        .radar-title { font-family: 'Orbitron', sans-serif; font-size: 12px; font-weight: 900; color: var(--brand); letter-spacing: 2px; margin-bottom: 8px; display: flex; align-items: center; justify-content: center; gap: 6px; }
        .radar-content { font-family: 'JetBrains Mono', monospace; font-weight: 800; font-size: 22px; color: var(--text-primary); min-height: 30px; display: flex; align-items: center; justify-content: center;}
        
        .capital-status-bar { display: none; }
        
        .main-target-box { text-align: center; margin-bottom: 10px; } 
        /* TARGET PRICE USES GOLD FIXED */
        .target-price { font-family: 'JetBrains Mono', monospace; font-size: 38px; font-weight: 800; color: var(--gold-fixed); line-height: 1; letter-spacing: -1.5px; text-shadow: 0 0 20px rgba(240, 185, 11, 0.15); }
        
        .control-row-three { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; gap: 10px; padding: 0 5px; }
        
        /* STRATEGY DISPLAY - FIXED GOLD COLOR ALWAYS */
        .strat-display { 
            flex: 1; text-align: center; font-family: 'Orbitron', sans-serif; 
            font-weight: 900; font-size: 11px; 
            color: var(--gold-fixed) !important; /* SIEMPRE DORADO */
            letter-spacing: 1px; padding: 12px; border-radius: 12px; border: 1px solid transparent; 
        }
        
        /* AGGRESSIVE ADDS BACKGROUND, COLOR IS ALREADY GOLD */
        .strat-display.aggressive { background: rgba(240, 185, 11, 0.1); border-color: rgba(240, 185, 11, 0.2); }
        
        .icon-sq-btn { width: 42px; height: 42px; border-radius: 12px; background: rgba(255,255,255,0.03); border: 1px solid var(--border); display: flex; align-items: center; justify-content: center; color: var(--text-secondary); cursor: pointer; }
        .icon-sq-btn.locked { color: var(--danger); border-color: var(--danger); background: rgba(207, 48, 74, 0.1); }
        
        .stats-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 6px; }
        .stat-box { background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.05); border-radius: 12px; padding: 10px 4px; text-align: center; }
        .stat-label { font-size: 10px; color: var(--text-tertiary); font-weight: 700; text-transform: uppercase; margin-bottom: 4px; }
        .stat-value { font-family: 'JetBrains Mono', monospace; font-size: 12px; font-weight: 700; color: var(--text-primary); }

        .levels-container { padding: 0 10px; display: flex; flex-direction: column; gap: 8px; padding-bottom: 40px; }
        
        /* UNIFIED CARD */
        .unified-card { 
            background: var(--card-bg); 
            border: 1px solid var(--border); 
            border-radius: var(--radius-m); 
            padding: 0 12px; 
            display: grid; 
            grid-template-columns: 50px 1fr auto; 
            gap: 12px;
            align-items: center; 
            cursor: pointer; 
            transition: transform 0.1s ease, background 0.2s ease;
            position: relative; 
            overflow: hidden; 
            min-height: 72px; height: 72px;
        }
        .unified-card:active { transform: scale(0.98); }
        .unified-card.active { border-color: var(--brand); background: rgba(59, 130, 246, 0.08); }
        
        .u-index { 
            width: 50px; height: 50px; 
            border-radius: 12px; 
            background: rgba(0,0,0,0.2); 
            border: 1px solid var(--border); 
            display: flex; align-items: center; justify-content: center; 
            font-family: 'Orbitron', sans-serif; font-weight: 900; 
            color: var(--text-secondary); 
            font-size: 11px; 
            white-space: nowrap; overflow: hidden;
            text-overflow: ellipsis;
        }
        .u-center { display: flex; flex-direction: column; justify-content: center; overflow: hidden; }
        .u-title { font-family: 'JetBrains Mono', monospace; font-size: 16px; font-weight: 800; color: var(--text-primary); line-height: 1.2; }
        .u-sub { font-size: 11px; font-weight: 600; color: var(--text-tertiary); margin-top: 2px; text-transform: uppercase; }
        
        .u-right { text-align: right; display: flex; flex-direction: column; justify-content: center; gap: 2px; flex-shrink: 0; }
        .u-val-primary { font-family: 'JetBrains Mono', monospace; font-size: 15px; font-weight: 800; color: var(--long); }
        .u-val-secondary { font-size: 11px; color: var(--text-secondary); font-weight: 700; }
        
        .liquidate-card { background: var(--danger); color: #fff; justify-content: center; font-family: 'Orbitron', sans-serif; font-weight: 900; letter-spacing: 1px; box-shadow: 0 4px 15px rgba(207, 48, 74, 0.4); border: none; padding: 20px; border-radius: var(--radius-m); margin-top: 10px; cursor: pointer; display: flex; align-items: center; gap:10px; }

        .etf-search-box { position: relative; margin: 5px 10px 10px 10px; } 
        .etf-search-input { width: 100%; background: var(--card-bg); border: 1px solid var(--border); padding: 14px 14px 14px 45px; border-radius: var(--radius-m); color: var(--text-primary); font-family: 'Orbitron', sans-serif; font-weight: 700; font-size: 14px; transition: border 0.3s; }
        .etf-search-input:focus { border-color: var(--brand); }
        .etf-search-icon { position: absolute; left: 16px; top: 50%; transform: translateY(-50%); color: var(--text-tertiary); }
        .etf-change-badge { padding: 6px 12px; border-radius: 8px; font-size: 16px; font-weight: 800; font-family: 'JetBrains Mono', monospace; }
        .etf-up { background: rgba(14, 203, 129, 0.15); color: var(--long); }
        .etf-down { background: rgba(246, 70, 93, 0.15); color: var(--short); }
        .etf-fav-icon { display: flex; align-items: center; justify-content: center; width: 32px; height: 32px; color: var(--text-tertiary); cursor: pointer; transition: 0.2s; }
        .etf-fav-icon.is-fav { color: var(--warning); }
        .etf-card-right { display: flex; align-items: center; gap: 12px; }

        .setting-section-title { padding: 5px 5px; font-family: 'Orbitron', sans-serif; color: var(--text-secondary); font-size: 12px; font-weight: 900; letter-spacing: 1px; display:flex; align-items:center; gap:8px; margin-top: 5px; }
        .settings-grid { display: flex; flex-direction: column; gap: 8px; }
        .setting-card-item { background: var(--card-bg); border: 1px solid var(--border); border-radius: var(--radius-m); padding: 16px; display: flex; flex-direction: column; gap: 5px; }
        .setting-label { font-size: 11px; color: var(--text-secondary); font-weight: 700; text-transform: uppercase; }
        .setting-input { width: 100%; background: transparent; border: none; color: var(--text-primary); font-family: 'JetBrains Mono', monospace; font-size: 18px; font-weight: 700; }
        
        /* BOT√ìN DE GUARDADO INDIVIDUAL */
        .input-row-save { display: flex; align-items: center; gap: 10px; width: 100%; }
        .btn-save-mini { background: var(--brand); color: #fff; border: none; width: 44px; height: 44px; border-radius: 12px; display: flex; align-items: center; justify-content: center; cursor: pointer; flex-shrink: 0; }
        
        .data-actions { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px; }
        .btn-data { background: var(--surface); border: 1px solid var(--border); color: var(--text-primary); padding: 12px; border-radius: 10px; font-size: 12px; font-weight: 700; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 6px; }
        .btn-reset { background: rgba(207, 48, 74, 0.1); color: var(--danger); border: 1px solid var(--danger); padding: 12px 20px; border-radius: 10px; font-weight: 900; width: 100%; margin-top: 10px; font-family: 'Orbitron', sans-serif; cursor: pointer; display:flex; align-items:center; justify-content:center; gap:8px; }
        .chip-container { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 10px; }
        .chip { background: rgba(59, 130, 246, 0.1); border: 1px solid var(--border); border-radius: 20px; padding: 6px 12px; font-size: 12px; font-weight: 700; display: flex; align-items: center; gap: 8px; color: var(--text-primary); }
        .chip-del { cursor: pointer; width: 16px; height: 16px; border-radius: 50%; background: rgba(255,255,255,0.1); display: flex; align-items: center; justify-content: center; font-size: 10px; color: var(--text-secondary); }

        .multi-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-top: 5px; }
        .multi-item { background: rgba(0,0,0,0.2); border: 1px solid var(--border); border-radius: 8px; padding: 5px; text-align: center; }
        .multi-lbl { font-size: 9px; color: var(--text-tertiary); display: block; font-weight: 700; }
        .multi-inp { width: 100%; background: transparent; border: none; color: var(--brand); font-family: 'JetBrains Mono'; font-weight: 800; font-size: 14px; text-align: center; }

        #navModal { position: fixed; inset: 0; background: rgba(0,0,0,0.85); backdrop-filter: blur(8px); z-index: 2000; display: none; justify-content: center; align-items: center; padding-top: var(--safe-top); }
        .nav-content { background: var(--surface); width: 85%; max-width: 320px; border-radius: 30px; padding: 35px 25px; border: 1px solid var(--border); box-shadow: 0 30px 60px rgba(0,0,0,0.6); display: flex; flex-direction: column; gap: 15px; }
        .nav-title { font-family: 'Orbitron', sans-serif; font-size: 18px; margin-bottom: 10px; color: var(--brand); text-align: center; font-weight: 900; letter-spacing: 2px; }
        .nav-item { display: flex; align-items: center; padding: 20px; border-radius: 18px; background: rgba(255,255,255,0.02); border: 1px solid var(--border); cursor: pointer; transition: 0.3s; }
        .nav-item.selected { background: rgba(59, 130, 246, 0.1); border-color: var(--brand); box-shadow: 0 5px 20px rgba(59, 130, 246, 0.15); }
        .nav-icon { width: 40px; height: 40px; margin-right: 20px; display: flex; align-items: center; justify-content: center; color: var(--text-secondary); }
        .nav-item.selected .nav-icon { color: var(--brand); }
        .nav-icon svg { width: 24px; height: 24px; }
        .nav-text { font-family: 'Orbitron', sans-serif; font-weight: 700; font-size: 14px; letter-spacing: 1px; color: var(--text-primary); }
        .btn-close-menu { margin-top: 10px; width: 100%; padding: 16px; border-radius: 16px; border: 1px solid var(--border); background: var(--surface); color: var(--danger); font-family: 'Orbitron', sans-serif; font-weight: 900; font-size: 13px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px; }

        .generic-modal { position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 3000; display: none; justify-content: center; align-items: center; }
        .modal-box { background: var(--surface); width: 85%; max-width: 300px; padding: 25px; border-radius: 20px; border: 1px solid var(--border); text-align: center; }
        .btn-modal { width: 100%; padding: 12px; border-radius: 10px; border: none; font-weight: 700; margin-bottom: 8px; cursor: pointer; }
        .btn-confirm { background: var(--brand); color: #fff; }
        .btn-cancel { background: transparent; color: var(--text-secondary); }
        .modal-inp { width: 100%; background: var(--bg); border: 1px solid var(--border); padding: 12px; border-radius: 10px; color: var(--text-primary); font-size: 24px; letter-spacing: 5px; text-align: center; margin: 20px 0; font-family: 'JetBrains Mono', monospace; }
        .equity-row { display: flex; justify-content: space-between; margin-bottom: 15px; font-size: 14px; }
        .equity-val { font-family: 'JetBrains Mono', monospace; font-weight: 800; color: var(--text-primary); }
        .equity-total { border-top: 1px solid var(--border); padding-top: 15px; margin-top: 10px; color: var(--brand); font-size: 18px; }

        .action-btn { background: var(--surface); border: 1px solid var(--brand); color: var(--brand); padding: 6px 12px; border-radius: 8px; font-size: 11px; font-weight: 800; cursor: pointer; font-family: 'Orbitron', sans-serif; display: flex; align-items: center; gap: 5px; }
        
        .log-header-bar { display: flex; flex-direction: column; align-items: center; gap: 8px; padding: 5px 16px 10px 16px; }
        .log-title { margin-bottom: 5px; font-family: 'Orbitron'; font-weight: 900; letter-spacing: 1px; color:var(--brand); }
        .log-actions { display: flex; gap: 15px; width: 100%; justify-content: center; }

        .stats-card { background: var(--surface); border: 1px solid var(--border); border-radius: 16px; margin: 0 10px 15px; padding: 15px; }
        .stats-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .stats-title { font-family: 'Orbitron', sans-serif; font-size: 12px; font-weight: 900; color: var(--brand); letter-spacing: 1px; }
        .stats-toggles { display: flex; gap: 5px; background: rgba(0,0,0,0.2); padding: 3px; border-radius: 8px; border: 1px solid var(--border); }
        .stat-btn { background: transparent; border: none; color: var(--text-tertiary); font-size: 10px; font-weight: 800; padding: 4px 10px; border-radius: 6px; cursor: pointer; transition: all 0.2s; }
        .stat-btn.active { background: var(--brand); color: #fff; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        
        .chart-box { height: 160px; display: flex; align-items: flex-end; justify-content: space-between; gap: 4px; padding-bottom: 5px; border-bottom: 1px solid var(--border); margin-bottom: 10px; position: relative; }
        .chart-bar { flex: 1; min-width: 4px; border-radius: 2px 2px 0 0; position: relative; transition: height 0.5s ease; animation: grow-up 0.5s ease-out; }
        .chart-bar.win { background: linear-gradient(to top, rgba(16,203,129,0.3), var(--long)); }
        .chart-bar.loss { background: linear-gradient(to top, rgba(246,70,93,0.3), var(--short)); }
        .chart-bar:hover { opacity: 0.8; }
        .chart-bar::after { content: attr(data-val); position: absolute; top: -15px; left: 50%; transform: translateX(-50%); font-size: 9px; font-family: 'JetBrains Mono'; color: var(--text-primary); opacity: 0; transition: 0.2s; pointer-events: none; white-space: nowrap; }
        .chart-bar:hover::after { opacity: 1; top: -20px; }

        .stats-summary { display: flex; justify-content: space-between; align-items: center; font-size: 12px; }
        .sum-label { color: var(--text-tertiary); font-weight: 700; margin-right: 5px; }
        .sum-val { font-family: 'JetBrains Mono', monospace; font-weight: 800; color: var(--text-primary); }

        #logGrid {
            max-height: 395px; /* Altura para mostrar 5 tarjetas */
            overflow-y: auto;
            overscroll-behavior: contain;
            border-bottom: 1px solid var(--border);
            margin-bottom: 20px;
            padding-right: 2px;
        }
        #logGrid::-webkit-scrollbar { width: 4px; }
        #logGrid::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }
    </style>
</head>
<body onload="init()">

    <audio id="alertSound" preload="auto" src="data:audio/wav;base64,UklGRl9vT1BXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YU"></audio>
    <div id="toast">Notificaci√≥n</div>

    <div id="navModal" onclick="if(event.target===this) closeMenuViaButton()">
        <div class="nav-content section-enter">
            <div class="nav-title">MEN√ö C5X</div>
            <div class="nav-item selected anim-click" id="nav-operate" onclick="switchView('operate')"><div class="nav-icon"><svg width="24" height="24"><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg></div><div class="nav-text">OPERAR</div></div>
            <div class="nav-item anim-click" id="nav-etf" onclick="switchView('etf')"><div class="nav-icon anim-pulse"><svg width="24" height="24"><circle cx="12" cy="12" r="10"/><path d="M16.24 7.76l-2.12 2.12"/><path d="M7.76 16.24l2.12-2.12"/><line x1="12" y1="12" x2="12" y2="8"/><line x1="12" y1="12" x2="16" y2="12"/></svg></div><div class="nav-text">MONITOR ETF</div></div>
            <div class="nav-item anim-click" id="nav-log" onclick="switchView('log')"><div class="nav-icon"><svg width="24" height="24"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg></div><div class="nav-text">BIT√ÅCORA</div></div>
            <div class="nav-item anim-click" id="nav-settings" onclick="switchView('settings')"><div class="nav-icon anim-spin"><svg width="24" height="24"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg></div><div class="nav-text">AJUSTES</div></div>
            <button class="btn-close-menu anim-click" onclick="closeMenuViaButton()"><svg width="18" height="18"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg> CERRAR MEN√ö</button>
        </div>
    </div>

    <div class="fixed-header">
        <header class="app-header">
            <div class="brand-btn anim-click" onclick="openMenuViaButton()">
                <span class="brand-text">C5X</span>
                <svg width="20" height="20" style="color:var(--text-tertiary)"><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="18" x2="21" y2="18"/></svg>
            </div>
            
            <div class="ticker-container"><div class="ticker-pill anim-click" onclick="viewTickerChart(event)"><div class="ticker-dot" id="t-dot"></div><span class="ticker-sym" id="t-sym">BTC</span><span class="ticker-price" id="t-price"><span class="skeleton-text skeleton-box"></span></span></div><button class="pin-btn anim-click" id="tickerPinBtn" onclick="toggleTickerPin()"><svg width="14" height="14"><path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"/></svg></button></div>
            
            <button class="theme-btn anim-click" onclick="toggleTheme()" id="themeBtn">üåô</button>
        </header>
        <div class="tf-bar" id="tfBarContainer">
            <button class="tf-btn anim-click" data-tf="15" onclick="updateTF('15', this)">15M</button><button class="tf-btn anim-click" data-tf="30" onclick="updateTF('30', this)">30M</button><button class="tf-btn anim-click" data-tf="60" onclick="updateTF('60', this)">1H</button><button class="tf-btn anim-click" data-tf="240" onclick="updateTF('240', this)">4H</button><button class="tf-btn anim-click" data-tf="D" onclick="updateTF('D', this)">1D</button>
        </div>
    </div>

    <div class="content-spacer">
        <div id="section-operate" class="app-section active">
            <nav id="slotNav" class="slot-nav"></nav>
            <div id="tv_chart" class="chart-wrapper"><div class="chart-fs-btn anim-click" onclick="toggleFullscreenChart(event)"><svg width="18" height="18"><polyline points="15 3 21 3 21 9"/><polyline points="9 21 3 21 3 15"/><line x1="21" y1="3" x2="14" y2="10"/><line x1="3" y1="21" x2="10" y2="14"/></svg></div></div>
            <div class="controls-grid"><div class="input-group"><label class="input-label">Moneda</label><input type="text" id="coinInput" class="input-field" placeholder="BTC" oninput="forceCaps(this)" onblur="updateCoin()"></div><div class="input-group"><label class="input-label">Base</label><input type="number" id="baseInput" class="input-field" oninput="calculate()" step="any" placeholder="0.00"></div><div class="input-group readonly"><label class="input-label">Capital</label><input type="number" id="capitalInput" class="input-field" readonly></div></div>
            
            <div class="dashboard-card" id="dashMain">
                <div id="radarTickerContainer" class="radar-ticker-large anim-pulse" onclick="switchView('etf', false)">
                    <div class="radar-title"><svg width="12" height="12"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg> RADAR DE OPORTUNIDADES</div>
                    <div id="radarValue" class="radar-content"><span class="skeleton-text skeleton-box" style="width:120px; height:20px;"></span></div>
                </div>
                
                <div class="main-target-box"><div class="target-label">OBJETIVO SALIDA</div><div class="target-price" id="resTarget">0.00000000</div></div>
                <div class="control-row-three">
                    <div class="icon-sq-btn anim-click" id="lockBtn" onclick="toggleLock()" title="Bloquear Slot"><svg width="18" height="18"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg></div>
                    <div class="strat-display anim-click" id="stratBadge" onclick="rotateDash()">NORMAL</div>
                    <div class="icon-sq-btn anim-click" onclick="cleanSlotOnly()" title="Limpiar Slot"><svg width="18" height="18"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg></div>
                </div>
                <div class="stats-grid"><div class="stat-box"><div class="stat-label">Promedio</div><div class="stat-value" id="resAvg">0.00000000</div></div><div class="stat-box"><div class="stat-label">Ganancia</div><div class="stat-value" id="resProfit" style="color:var(--long)">$0.00</div></div><div class="stat-box"><div class="stat-label">Inversi√≥n</div><div class="stat-value" id="resInv">$0.00</div></div></div>
            </div>
            
            <main id="levelsGrid" class="levels-container"></main>
        </div>

        <div id="section-etf" class="app-section">
            <div class="etf-search-box"><span class="etf-search-icon"><svg width="16" height="16"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg></span><input type="text" class="etf-search-input" placeholder="BUSCAR TOKEN (Ej: BTC, SUI)" oninput="filterETFs(this.value)"></div>
            <div id="etfGrid" class="levels-container"></div>
        </div>

        <div id="section-log" class="app-section">
            <div class="log-header-bar">
                <div class="log-title">BIT√ÅCORA</div>
                <div class="log-actions">
                    <button class="action-btn anim-click" onclick="exportPDF()"><svg width="14" height="14"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg> REPORTE</button>
                    <button class="action-btn anim-click" onclick="triggerDriveBackup()"><svg width="14" height="14"><path d="M19 18a3.5 3.5 0 0 0 0-7h-1A5 4.5 0 0 0 8 9a4.5 4.5 0 0 0-4.5 4.5c0 .4.04.79.12 1.16"/></svg> RESPALDO</button>
                    <button class="action-btn anim-click" style="color:var(--danger); border-color:var(--danger)" onclick="clearLogs()"><svg width="14" height="14"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg> BORRAR</button>
                </div>
            </div>
            
            <div class="stats-card anim-click">
                <div class="stats-header">
                    <div class="stats-title">RENDIMIENTO</div>
                    <div class="stats-toggles">
                        <button class="stat-btn active" onclick="updateStats('D')">1D</button>
                        <button class="stat-btn" onclick="updateStats('W')">1S</button>
                        <button class="stat-btn" onclick="updateStats('M')">1M</button>
                        <button class="stat-btn" onclick="updateStats('A')">TODO</button>
                    </div>
                </div>
                <div class="chart-box" id="pnlChart"></div>
                <div class="stats-summary">
                    <div><span class="sum-label">NETO (FEES INC.)</span><span class="sum-val" id="chartNeto">$0.00</span></div>
                    <div><span class="sum-label">WIN RATE</span><span class="sum-val" id="chartWr">0%</span></div>
                </div>
            </div>

            <div id="logGrid" class="levels-container"></div>
        </div>

        <div id="section-settings" class="app-section">
            <div class="setting-section-title"><svg width="14" height="14"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg> CAPITAL & RENDIMIENTO</div>
            <div class="settings-grid">
                <div class="setting-card-item">
                    <div class="input-row-save" style="margin-bottom:10px;">
                        <span class="setting-label" style="flex:1">CAPITAL TOTAL BASE ($)</span>
                        <button class="btn-save-mini anim-click" onclick="saveGlobalCapSecure()"><svg width="18" height="18"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg></button>
                    </div>
                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px">
                        <input type="number" class="setting-input" id="setGlobalCapital" placeholder="0.00" style="border-bottom:1px solid var(--border)">
                        <div><label class="setting-label">COMISI√ìN EXCHANGE (%)</label><input type="number" class="setting-input" id="setFee" placeholder="0.1" step="0.01"></div>
                    </div>
                </div>
                <div class="setting-card-item">
                    <label class="setting-label">GANANCIA MES ACTUAL</label>
                    <div id="monthlyProfitDisplay" style="font-family:var(--font-num); font-size:16px; font-weight:800; color:var(--text-primary);">$0.00 <span style="font-size:12px; color:var(--text-tertiary)">(0%)</span></div>
                </div>
            </div>

            <div class="setting-section-title"><svg width="14" height="14"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg> ESTRATEGIA Y GESTI√ìN</div>
            <div class="settings-grid">
                <div class="setting-card-item">
                    <div class="input-row-save" style="margin-bottom:10px; justify-content:space-between;">
                        <span class="setting-label">CONFIGURACI√ìN SLOT ACTUAL</span>
                        <button class="btn-save-mini anim-click" onclick="saveSlotParamsSecure()"><svg width="18" height="18"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg></button>
                    </div>
                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
                        <div><label class="setting-label">CAPITAL ($)</label><input type="number" class="setting-input" id="setCapital"></div>
                        <div><label class="setting-label">ROI (%)</label><input type="number" class="setting-input" id="setRoi" placeholder="100"></div>
                        <div><label class="setting-label">INC. BASE (%)</label><input type="number" class="setting-input" id="setInc"></div>
                        <div><label class="setting-label">AGRESIVO (%)</label><input type="number" class="setting-input" id="setDesc"></div>
                        <div><label class="setting-label">DD MAX (%)</label><input type="number" class="setting-input" id="setDD" placeholder="10"></div>
                    </div>
                </div>
            </div>

            <div class="setting-section-title"><svg width="14" height="14"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg> AJUSTES AVANZADOS</div>
            <div class="settings-grid">
                <div class="setting-card-item">
                     <div class="input-row-save" style="justify-content:space-between; margin-bottom:5px;">
                        <span class="setting-label">RADAR ETF</span>
                        <button class="btn-save-mini anim-click" onclick="saveRadarSecure()"><svg width="18" height="18"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg></button>
                    </div>
                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
                        <div><label class="setting-label">CANTIDAD</label><input type="number" class="setting-input" id="setRadarLimit" placeholder="8"></div>
                        <div><label class="setting-label">VELOCIDAD (S)</label><input type="number" class="setting-input" id="setRadarSpeed" placeholder="5"></div>
                    </div>
                </div>
                
                <div class="setting-card-item">
                    <div class="input-row-save" style="justify-content:space-between; margin-bottom:5px;">
                        <span class="setting-label">MULTIPLICADORES</span>
                        <button class="btn-save-mini anim-click" onclick="saveMultiSecure()"><svg width="18" height="18"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg></button>
                    </div>
                    <div id="multiGrid" class="multi-grid"></div>
                </div>

                <div class="setting-card-item">
                     <div class="input-row-save">
                        <div style="flex:1"><label class="setting-label">PROXY</label><input type="text" class="setting-input" id="setProxy" placeholder="https://..." ></div>
                        <button class="btn-save-mini anim-click" onclick="saveProxySecure()"><svg width="18" height="18"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg></button>
                     </div>
                </div>

                <div class="setting-card-item">
                    <label class="setting-label">MONEDAS DEL TICKER</label>
                    <div id="tickerChipsContainer" class="chip-container"></div>
                    <div class="add-coin-row"><div class="input-wrapper" style="flex:1"><input type="text" id="newTickerCoin" placeholder="A√ëADIR (ej: PEPE)" oninput="forceCaps(this)" onkeypress="handleEnter(event)" style="border:none; background:transparent; color:var(--text-primary); font-family:var(--font-num); font-weight:700;"></div><button id="addCoinBtn" class="btn-data anim-click" style="width:auto; padding:5px 15px; margin:0;" onclick="verifyAndAddCoin()">A√ëADIR</button></div>
                </div>
            </div>

            <div class="setting-section-title"><svg width="14" height="14"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg> SEGURIDAD</div>
            <div class="settings-grid">
                <div class="setting-card-item">
                     <div class="input-row-save">
                        <div style="flex:1"><label class="setting-label">NUEVA CLAVE</label><input type="password" class="setting-input" id="setNewPass" placeholder="****" maxlength="4" style="letter-spacing:4px;"></div>
                        <button class="btn-save-mini anim-click" onclick="savePassSecure()"><svg width="18" height="18"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg></button>
                     </div>
                </div>
            </div>

            <div class="setting-section-title"><svg width="14" height="14"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg> GESTI√ìN DE DATOS</div>
            <div class="data-actions"><button class="btn-data anim-click" onclick="exportData()">‚¨áÔ∏è EXPORTAR BACKUP</button><button class="btn-data anim-click" onclick="document.getElementById('importFile').click()">‚¨ÜÔ∏è IMPORTAR BACKUP</button><input type="file" id="importFile" style="display:none" onchange="importData(this)"></div>
            <button class="btn-reset anim-click" style="margin-top:15px; border-color:var(--border); color:var(--text-secondary); background:transparent;" onclick="clearLogs()"><svg width="14" height="14"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg> BORRAR HISTORIAL</button>

            <div class="settings-card danger">
                <div class="setting-header" style="color:var(--danger); border-bottom-color:rgba(207, 48, 74, 0.3);">‚ö†Ô∏è ZONA CR√çTICA</div>
                <div class="setting-info" style="text-align:center; margin-bottom:10px;"><p>Restablecer la aplicaci√≥n borrar√° TODOS los datos, slots y configuraciones.</p></div>
                <button class="btn-reset anim-click" onclick="resetApp()"><svg width="14" height="14"><path d="M2.5 2v6h6M21.5 22v-6h-6"/><path d="M22 11.5A10 10 0 0 0 3.2 7.2M2 12.5a10 10 0 0 0 18.8 4.2"/></svg> RESTABLECER DE F√ÅBRICA</button>
            </div>
            <div style="text-align:center; font-size:10px; color:var(--text-tertiary); margin-top:20px; font-weight:700; letter-spacing:1px;">C5X V44.0 AUTO-PILOT</div>
        </div>
    </div>

    <div id="confirmModal" class="generic-modal"><div class="modal-box section-enter"><div style="font-family:'Orbitron'; font-size:14px; margin-bottom:15px; color:var(--danger)">¬øLIQUIDAR POSICI√ìN?</div><p style="font-size:12px; color:var(--text-secondary); margin-bottom:20px;">Esta acci√≥n cerrar√° el slot actual y guardar√° el registro.</p><button class="btn-modal btn-confirm anim-click" style="background:var(--danger)" onclick="executeRelease()">S√ç, LIQUIDAR</button><button class="btn-modal btn-cancel anim-click" onclick="closeModals()">CANCELAR</button></div></div>
    <div id="securityModal" class="generic-modal"><div class="modal-box section-enter"><div style="font-family:'Orbitron'; font-size:12px;">SEGURIDAD</div><input type="password" id="secInput" class="modal-inp" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢" maxlength="4" inputmode="numeric" pattern="[0-9]*"><button class="btn-modal btn-confirm anim-click" onclick="validateSecurity()">VALIDAR</button><button class="btn-modal btn-cancel anim-click" onclick="closeModals()">CANCELAR</button></div></div>
    <input type="hidden" id="incInput" value="7"><input type="hidden" id="descInput" value="66">

    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('sw.js')
                    .then(reg => console.log('SW registrado', reg))
                    .catch(err => console.log('SW fallo', err));
            });
        }

        let isLight = localStorage.getItem('theme') === 'light';
        let activeIdx = parseInt(localStorage.getItem('c5x_last_slot'));
        if(isNaN(activeIdx)) activeIdx = 0;
        let activeTF = localStorage.getItem('c5x_last_tf') || '60';
        let chartSymbol = '';
        let history = JSON.parse(localStorage.getItem('c5x_history')) || [];
        // DEFAULT LOCKED TO TRUE
        let slots = JSON.parse(localStorage.getItem('dca_v18_slots')) || Array(5).fill(null).map(() => ({ name:'', price:0, capital:5, buys:[], strat:'normal', locked: true, roi: 100, note: '', alerted: false }));
        if(Array.isArray(slots) && slots.length > 5) slots = slots.slice(0, 5);
        if(Array.isArray(slots) && slots.length < 5) while(slots.length < 5) slots.push({ name:'', price:0, capital:5, buys:[], strat:'normal', locked: true, roi: 100, note: '', alerted: false });
        let currentSection = 'operate';
        let modalCallback = null;
        let customMultipliers = JSON.parse(localStorage.getItem('c5x_multipliers')) || [1.0, 1.0, 1.5, 1.5, 2.0, 2.0, 5.0, 5.0, 8.0, 8.0, 16.0, 16.0];
        let customProxy = localStorage.getItem('c5x_custom_proxy') || '';
        let etfFavorites = JSON.parse(localStorage.getItem('c5x_etf_favorites')) || [];
        let globalCapital = parseFloat(localStorage.getItem('c5x_global_capital')) || 0; 
        let exchangeFee = parseFloat(localStorage.getItem('c5x_fee')) || 0.1;
        
        let appConfig = JSON.parse(localStorage.getItem('c5x_config')) || { pin: '2524', dd: 10 };

        let tickerAssets = JSON.parse(localStorage.getItem('c5x_ticker_assets')) || ["BTC", "ETH", "SUI", "AVAX", "SOL", "BNB"]; 
        let isTickerPinned = localStorage.getItem('c5x_ticker_pinned') === 'true'; 
        let assetIdx = parseInt(localStorage.getItem('c5x_ticker_index')) || 0; 
        let currentTickerSymbol = "BTC";
        let currentWs = null; 
        let radarLimit = parseInt(localStorage.getItem('c5x_radar_limit')) || 8;
        let radarSpeed = parseInt(localStorage.getItem('c5x_radar_speed')) || 5; 
        let allGateETFs = []; let topDroppers = []; let dropperIdx = 0; 
        let radarIntervalId = null;
        let crashAlertedCoins = JSON.parse(localStorage.getItem('c5x_alert_levels')) || {};
        let proxies = ['https://corsproxy.io/?', 'https://api.allorigins.win/raw?url='];
        if(customProxy) proxies.unshift(customProxy);

        function init() { 
            try {
                // CARGAR ESTRATEGIA PERSISTENTE AL INICIO
                const savedParams = JSON.parse(localStorage.getItem('c5x_inc_desc'));
                if(savedParams) {
                    document.getElementById('incInput').value = savedParams.inc;
                    document.getElementById('descInput').value = savedParams.desc;
                    // Tambi√©n actualizar los inputs visibles en ajustes
                    document.getElementById('setInc').value = savedParams.inc;
                    document.getElementById('setDesc').value = savedParams.desc;
                }

                if(isLight) { document.body.classList.add('light-mode'); updateThemeIcon(); }
                slots.forEach(s => { 
                    if(typeof s.roi === 'undefined') s.roi = 100; 
                    if(typeof s.note === 'undefined') s.note = ''; 
                    if(typeof s.alerted === 'undefined') s.alerted = false; 
                    // ENSURE LOCKED PROPERTY EXISTS
                    if(typeof s.locked === 'undefined') s.locked = true;
                });
                if(!customMultipliers || customMultipliers.length === 0) customMultipliers = [1.0, 1.0, 1.5, 1.5, 2.0, 2.0, 5.0, 5.0, 8.0, 8.0, 16.0, 16.0];
                const multInput = document.getElementById('setMultipliers'); if(multInput) multInput.value = customMultipliers.join(', ');
                const proxInput = document.getElementById('setProxy'); if(proxInput) proxInput.value = customProxy;
                
                window.history.replaceState({page: 'operate'}, '', '');

                if("Notification" in window) Notification.requestPermission();

                renderNav(); selectSlot(activeIdx); renderHistory(); updatePinUI(); startTickerSystem(); fetchAndCalcTopDroppers(); setupSwipe(); 
                document.querySelectorAll('.tf-btn').forEach(btn => { if(btn.dataset.tf === activeTF) btn.classList.add('active'); });
                calculateGlobalStats(); 
                updateStats('D');

                document.body.addEventListener('click', unlockAudioAndWake, { once: true });
                document.body.addEventListener('touchstart', unlockAudioAndWake, { once: true });
                requestWakeLock();

            } catch(e) { console.error("Init Error", e); }
        }

        // --- SISTEMA DE GUARDADO INDIVIDUAL SEGURO ---
        let secCallback = null;

        function reqSec(cb) {
            secCallback = cb;
            const m = document.getElementById('securityModal');
            document.getElementById('secInput').value = '';
            m.style.display = 'flex';
            void m.offsetWidth;
        }

        function validateSecurity() {
            const inp = document.getElementById('secInput').value;
            closeModals(); 
            if(inp === appConfig.pin) {
                if(secCallback) secCallback();
            } else {
                showToast("‚õî PIN INCORRECTO");
            }
        }

        function saveGlobalCapSecure() {
            reqSec(() => {
                const val = parseFloat(document.getElementById('setGlobalCapital').value);
                const feeVal = parseFloat(document.getElementById('setFee').value);

                if(!isNaN(val)) {
                    globalCapital = val;
                    localStorage.setItem('c5x_global_capital', globalCapital);
                }
                
                if(!isNaN(feeVal)) {
                    exchangeFee = feeVal;
                    localStorage.setItem('c5x_fee', exchangeFee);
                }

                calculateGlobalStats();
                showToast("‚úÖ Capital y Comisi√≥n Guardados");
            });
        }

        function saveSlotParamsSecure() {
            reqSec(() => {
                const newCap = parseFloat(document.getElementById('setCapital').value);
                const newRoi = parseFloat(document.getElementById('setRoi').value);
                const newDD = parseFloat(document.getElementById('setDD').value);
                const newInc = parseFloat(document.getElementById('setInc').value);
                const newDesc = parseFloat(document.getElementById('setDesc').value);

                if(isNaN(newCap) || isNaN(newRoi)) return showToast("‚ö†Ô∏è Valores Inv√°lidos");

                slots[activeIdx].capital = newCap;
                slots[activeIdx].roi = newRoi;
                if(!isNaN(newDD)) appConfig.dd = newDD;
                localStorage.setItem('c5x_config', JSON.stringify(appConfig));
                save(); 

                if(!isNaN(newInc) && !isNaN(newDesc)) {
                    localStorage.setItem('c5x_inc_desc', JSON.stringify({ inc: newInc, desc: newDesc }));
                    document.getElementById('incInput').value = newInc;
                    document.getElementById('descInput').value = newDesc;
                }

                calculate();
                updateDashUI();
                showToast("‚úÖ Configuraci√≥n Slot Guardada");
            });
        }

        function saveRadarSecure() {
            reqSec(() => {
                const lim = parseInt(document.getElementById('setRadarLimit').value);
                const spd = parseInt(document.getElementById('setRadarSpeed').value);
                if(lim > 0) { radarLimit = lim; localStorage.setItem('c5x_radar_limit', lim); fetchAndCalcTopDroppers(); }
                if(spd > 0) { radarSpeed = spd; localStorage.setItem('c5x_radar_speed', spd); startRadarRotation(); }
                showToast("‚úÖ Radar Actualizado");
            });
        }

        function saveMultiSecure() {
            reqSec(() => {
                const inputs = document.querySelectorAll('.multi-inp');
                let newMultipliers = [];
                inputs.forEach(inp => {
                    let val = parseFloat(inp.value);
                    if(!isNaN(val)) newMultipliers.push(val);
                });
                if(newMultipliers.length >= 5) {
                    customMultipliers = newMultipliers;
                    localStorage.setItem('c5x_multipliers', JSON.stringify(customMultipliers)); 
                    calculate();
                    showToast("‚úÖ Multiplicadores Guardados");
                } else {
                    showToast("‚ö†Ô∏è M√≠nimo 5 Niveles");
                }
            });
        }

        function saveProxySecure() {
            reqSec(() => {
                const val = document.getElementById('setProxy').value.trim();
                customProxy = val;
                localStorage.setItem('c5x_custom_proxy', customProxy);
                proxies = ['https://corsproxy.io/?', 'https://api.allorigins.win/raw?url='];
                if(customProxy) proxies.unshift(customProxy);
                showToast("‚úÖ Proxy Guardado");
            });
        }

        function savePassSecure() {
            reqSec(() => { 
                const newPass = document.getElementById('setNewPass').value;
                if(newPass && newPass.length === 4) {
                    appConfig.pin = newPass;
                    localStorage.setItem('c5x_config', JSON.stringify(appConfig));
                    showToast("‚úÖ Contrase√±a Cambiada");
                } else {
                    showToast("‚ö†Ô∏è Clave debe ser 4 d√≠gitos");
                }
            });
        }

        function updateStats(tf) {
            triggerHaptic();
            document.querySelectorAll('.stat-btn').forEach(b => b.classList.remove('active'));
            const btns = document.querySelectorAll('.stat-btn');
            if(tf === 'D') btns[0].classList.add('active');
            else if(tf === 'W') btns[1].classList.add('active');
            else if(tf === 'M') btns[2].classList.add('active');
            else if(tf === 'A') btns[3].classList.add('active');
            
            const chart = document.getElementById('pnlChart');
            chart.innerHTML = '';
            
            const now = new Date();
            let totalNet = 0;
            let wins = 0, total = 0;

            const filtered = history.filter(h => {
                if(!h.date) return false;
                const parts = h.date.split('/');
                const hDate = new Date(parts[2], parts[1]-1, parts[0]);
                const diffTime = Math.abs(now - hDate);
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                if(tf === 'D' && diffDays <= 7) return true;
                if(tf === 'W' && diffDays <= 60) return true;
                if(tf === 'M' && diffDays <= 365) return true;
                if(tf === 'A') return true;
                return false;
            }).reverse();

            let groups = {};
            filtered.forEach(h => {
                let key = h.date;
                if(tf === 'M' || tf === 'A') {
                    const parts = h.date.split('/');
                    key = parts[1] + '/' + parts[2].substring(2);
                }
                if(!groups[key]) groups[key] = 0;
                
                // USE NET PROFIT IF AVAILABLE, ELSE GROSS
                const p = (h.netProfit !== undefined) ? parseFloat(h.netProfit) : (parseFloat(h.profit) || 0);
                
                groups[key] += p;
                totalNet += p;
                total++;
                if(p > 0) wins++;
            });

            const keys = Object.keys(groups);
            const maxVal = Math.max(...Object.values(groups).map(Math.abs), 1); 

            keys.forEach(k => {
                const val = groups[k];
                const heightPct = (Math.abs(val) / maxVal) * 100;
                const bar = document.createElement('div');
                bar.className = `chart-bar ${val >= 0 ? 'win' : 'loss'}`;
                bar.style.height = Math.max(heightPct, 5) + '%';
                bar.setAttribute('data-val', (val>=0?'+':'') + Math.round(val));
                chart.appendChild(bar);
            });

            if(keys.length === 0) chart.innerHTML = '<div style="width:100%; text-align:center; color:var(--text-tertiary); font-size:10px; padding-bottom:20px;">SIN ACTIVIDAD RECIENTE</div>';

            const netEl = document.getElementById('chartNeto');
            netEl.textContent = (totalNet>=0?'+':'') + '$' + totalNet.toFixed(2);
            netEl.style.color = totalNet >= 0 ? 'var(--long)' : 'var(--short)';
            
            document.getElementById('chartWr').textContent = total > 0 ? Math.round((wins/total)*100) + '%' : '0%';
        }

        function openMenuViaButton() { document.getElementById('navModal').style.display = 'flex'; window.history.pushState({modal: 'menu'}, '', '#menu'); }
        function closeMenuViaButton() { window.history.back(); }
        function switchView(viewName) { triggerHaptic(); document.getElementById('navModal').style.display = 'none'; if (viewName !== 'operate') { window.history.pushState({page: viewName}, '', `#${viewName}`); } updateViewVisuals(viewName); }
        function updateViewVisuals(viewName) { 
            currentSection = viewName; 
            document.querySelectorAll('.app-section').forEach(el => el.classList.remove('active')); 
            document.getElementById('section-' + viewName).classList.add('active'); 
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('selected')); 
            const navItem = document.getElementById('nav-' + viewName); 
            if(navItem) navItem.classList.add('selected'); 
            const tfBar = document.getElementById('tfBarContainer'), spacer = document.querySelector('.content-spacer'); 
            if(viewName === 'operate') { 
                tfBar.style.display = 'grid'; spacer.style.marginTop = '92px'; 
                if(chartSymbol) loadChart(chartSymbol); 
            } else { 
                tfBar.style.display = 'none'; spacer.style.marginTop = '60px'; 
            } 
            if(viewName === 'etf') loadGateETFs(); 
            if(viewName === 'settings') { loadSettingsValues(); renderTickerSettings(); } 
            if(viewName === 'log') updateStats('D'); 
            window.scrollTo(0,0); 
        }
        window.onpopstate = function(event) { const state = event.state; document.getElementById('navModal').style.display = 'none'; if (!state) { updateViewVisuals('operate'); return; } if (state.modal === 'menu') { document.getElementById('navModal').style.display = 'flex'; } else if (state.page) { updateViewVisuals(state.page); } else { updateViewVisuals('operate'); } };
        function setupSwipe() { document.addEventListener('touchstart', e => { window.touchStartX = e.changedTouches[0].screenX; window.touchStartY = e.changedTouches[0].screenY; }, {passive: true}); document.addEventListener('touchend', e => { let touchEndX = e.changedTouches[0].screenX; let touchEndY = e.changedTouches[0].screenY; handleSwipe(window.touchStartX, window.touchStartY, touchEndX, touchEndY); }, {passive: true}); }
        function handleSwipe(tsX, tsY, teX, teY) { const threshold = 60; const diffX = teX - tsX; const diffY = teY - tsY; if (Math.abs(diffY) > Math.abs(diffX)) return; if (currentSection !== 'operate') { if (diffX > threshold) { window.history.back(); } } else { const occupiedIndices = slots.map((s, i) => s.name !== '' ? i : -1).filter(i => i !== -1); if (occupiedIndices.length === 0) { if (diffX < -threshold) { let next = activeIdx + 1; if(next >= 5) next = 0; selectSlot(next); } else if (diffX > threshold) { let prev = activeIdx - 1; if(prev < 0) prev = 4; selectSlot(prev); } } else { let currentPosInOccupied = occupiedIndices.indexOf(activeIdx); if (currentPosInOccupied === -1) { selectSlot(occupiedIndices[0]); return; } if (diffX < -threshold) { let nextPos = currentPosInOccupied + 1; if (nextPos >= occupiedIndices.length) nextPos = 0; selectSlot(occupiedIndices[nextPos]); } else if (diffX > threshold) { let prevPos = currentPosInOccupied - 1; if (prevPos < 0) prevPos = occupiedIndices.length - 1; selectSlot(occupiedIndices[prevPos]); } } } }
        async function requestWakeLock() { try { if ('wakeLock' in navigator) await navigator.wakeLock.request('screen'); } catch (err) {} }
        function unlockAudioAndWake() { const audio = document.getElementById('alertSound'); if(audio) { audio.play().then(() => { audio.pause(); audio.currentTime = 0; }).catch(e=>{}); } if("Notification" in window && Notification.permission !== "granted") { Notification.requestPermission(); } requestWakeLock(); checkAutoBackup(); }
        
        // --- NOTIFICATION FIX ---
        function triggerCrashAlert(coin, pct) { 
            const audio = document.getElementById('alertSound'); 
            if(audio) { 
                audio.currentTime = 0; 
                audio.play().catch(e => console.log("Audio play failed")); 
            } 
            if(navigator.vibrate) navigator.vibrate([500, 200, 500, 200, 500]); // Stronger Vibe
            showToast(`‚ö†Ô∏è ${coin} CAY√ì ${pct.toFixed(2)}%`, 5000, true); 
            if("Notification" in window && Notification.permission === "granted") { 
                new Notification(`ALERTA DE CRASH: ${coin}`, { body: `El precio cay√≥ un ${pct.toFixed(2)}%`, icon: 'icon.png' }); 
            } 
        }
        
        function showToast(txt, duration = 2500, isAlert = false, isSuccess = false) { 
            const t = document.getElementById("toast"); 
            t.textContent = txt; 
            t.classList.remove("alert-mode", "success-mode"); 
            if(isAlert) t.classList.add("alert-mode"); 
            if(isSuccess) t.classList.add("success-mode"); 
            t.classList.add("show"); 
            setTimeout(() => { t.classList.remove("show"); }, duration); 
        }
        function sortSlots() { const filled = slots.filter(s => s.name && s.name !== ''); const empty = slots.filter(s => !s.name || s.name === ''); slots = [...filled, ...empty]; save(); renderNav(); }
        function calculateGlobalStats() { 
            let totalRealizedProfit = history.reduce((sum, item) => {
                // Use Net Profit if available, otherwise legacy gross
                return sum + (item.netProfit !== undefined ? parseFloat(item.netProfit) : (parseFloat(item.profit) || 0));
            }, 0); 
            
            let currentEquity = globalCapital + totalRealizedProfit; 
            let pnl = currentEquity - globalCapital; 
            let pnlPct = (globalCapital > 0) ? (pnl / globalCapital) * 100 : 0; 
            
            // REMOVED FROM DASHBOARD, BUT KEPT FOR SETTINGS
        }
        function cleanSlotOnly() { 
            triggerHaptic(); 
            if(confirm("¬øLimpiar datos del Slot actual? (No se guardar√° en el historial)")) { 
                slots[activeIdx] = { name:'', price:0, capital: slots[activeIdx].capital || 5, buys:[], strat:'normal', locked: true, roi: 100, note: '', alerted: false }; 
                sortSlots(); 
                selectSlot(0); 
                showToast("üóëÔ∏è Slot Limpiado"); 
            } 
        }
        function quickAddFromTicker(symbol, price, e) { e.stopPropagation(); triggerHaptic(); if(slots.some(s => s.name === symbol)) { showToast("‚ö†Ô∏è " + symbol + " ya existe"); return; } const emptyIdx = slots.findIndex(s => !s.name || s.name === ''); if(emptyIdx === -1) { showToast("‚ö†Ô∏è No hay slots disponibles"); return; } let cleanName = symbol.replace('_USDT','').replace('USDT',''); slots[emptyIdx].name = cleanName; slots[emptyIdx].price = price; slots[emptyIdx].buys = []; slots[emptyIdx].locked = true; slots[emptyIdx].note = ''; save(); updateBodyMode(cleanName); selectSlot(emptySlotIdx); showToast("‚úÖ " + symbol + " a√±adido"); }
        function saveGlobalCapital() { const val = parseFloat(document.getElementById('setGlobalCapital').value); if(!isNaN(val)) { globalCapital = val; localStorage.setItem('c5x_global_capital', globalCapital); calculateGlobalStats(); } }
        
        // --- LOGIC FOR DROPPERS ---
        async function fetchAndCalcTopDroppers() { 
            try { 
                const proxy = proxies[0]; 
                const res = await fetch(proxy + encodeURIComponent("https://api.gateio.ws/api/v4/spot/tickers")); 
                if(!res.ok) throw new Error("Network"); 
                data = await res.json(); 
                allGateETFs = data.filter(t => { 
                    const pair = t.currency_pair; 
                    return pair.endsWith('_USDT') && (pair.includes('3L') || pair.includes('3S') || pair.includes('5L') || pair.includes('5S')); 
                }); 
                topDroppers = [...allGateETFs].sort((a,b) => parseFloat(a.change_percentage) - parseFloat(b.change_percentage)).slice(0, radarLimit); 
                
                topDroppers.forEach(t => { 
                    const pct = parseFloat(t.change_percentage); 
                    const pair = t.currency_pair.replace('_USDT', ''); 
                    
                    // Logic check every 10% after -50%
                    if(pct <= -50.0) { 
                        let currentLevel = 0; 
                        if (pct <= -90) currentLevel = -90; 
                        else if (pct <= -80) currentLevel = -80; 
                        else if (pct <= -70) currentLevel = -70; 
                        else if (pct <= -60) currentLevel = -60; 
                        else if (pct <= -50) currentLevel = -50; 
                        
                        let lastLevel = crashAlertedCoins[pair] || 0; 
                        
                        // Trigger if deeper level reached (smaller number is deeper e.g. -60 < -50)
                        if (lastLevel === 0 || currentLevel < lastLevel) { 
                            triggerCrashAlert(pair, pct); 
                            crashAlertedCoins[pair] = currentLevel; 
                            localStorage.setItem('c5x_alert_levels', JSON.stringify(crashAlertedCoins)); 
                        } 
                    } 
                }); 
                startRadarRotation(); 
            } catch(e) { console.log("Error loading radar"); } 
        }

        function startRadarRotation() { if(radarIntervalId) clearInterval(radarIntervalId); updateRadarUI(); radarIntervalId = setInterval(() => { dropperIdx = (dropperIdx + 1) % topDroppers.length; updateRadarUI(); }, radarSpeed * 1000); }
        function updateRadarUI() { if(topDroppers.length === 0) return; const elVal = document.getElementById('radarValue'); const item = topDroppers[dropperIdx]; if(!item) return; elVal.style.opacity = 0; setTimeout(() => { const pairName = item.currency_pair.replace('_USDT', ''); const change = parseFloat(item.change_percentage).toFixed(2); const price = parseFloat(item.last); const displayPrice = price < 1 ? price.toFixed(4) : price.toFixed(2); elVal.innerHTML = `<span onclick="quickAddFromTicker('${pairName}', ${price}, event)" style="color:var(--text-primary); text-decoration:underline dotted; text-underline-offset:4px; cursor:pointer">${pairName}</span> <span style="color:var(--text-tertiary); font-size:14px; margin:0 5px;">$${displayPrice}</span> <span class="radar-pct">(${change}%)</span>`; elVal.style.opacity = 1; }, 200); }
        
        function updateSlotStatus(symbol, currentPrice) { 
            try { 
                slots.forEach((s, idx) => { 
                    if(s.name === symbol && s.buys.length > 0) { 
                        // Visual update logic
                        const el = document.getElementById('nav-s'+idx); 
                        if(el) {
                            let avg = calculateAvgPriceForSlot(s); 
                            if(avg > 0) { 
                                if(currentPrice > avg) { 
                                    el.classList.remove('has-loss'); el.classList.add('has-profit'); 
                                    const target = avg * (1 + (s.roi/100)); 
                                    if(currentPrice >= target && !s.alerted) { triggerAlert(s.name); s.alerted = true; save(); } 
                                } else { 
                                    el.classList.remove('has-profit'); el.classList.add('has-loss'); s.alerted = false; 
                                } 
                            }
                        }
                        
                        // --- AUTO-PILOT LOGIC (Check and Buy Levels) ---
                        // Only run if active entry (Level 0) exists
                        if(s.buys.includes(0)) {
                            checkAutoFill(s, idx, currentPrice);
                        }
                    } 
                }); 
            } catch(e) { console.warn("Heatmap/Auto Error", e); } 
        }

        function checkAutoFill(s, idx, currentPrice) {
            const descPct = parseFloat(document.getElementById('descInput').value) || 66; 
            const incPct = parseFloat(document.getElementById('incInput').value) || 7; 
            const limit = customMultipliers ? customMultipliers.length : 12; 
            let lastPrice = s.price;
            let changesMade = false;

            for(let i=0; i<limit; i++){ 
                let pLevel; 
                let currentStepDrop = 0;
                
                if(i===0) {
                    pLevel = s.price; 
                } else { 
                    if(s.strat === "normal") { 
                        if(i===1) currentStepDrop = 17; 
                        else currentStepDrop += incPct; 
                    } else { 
                        currentStepDrop = descPct; 
                    } 
                    pLevel = lastPrice * (1 - (currentStepDrop/100)); 
                } 
                
                // CORE LOGIC: If price is BELOW level AND NOT Bought yet
                if (currentPrice <= pLevel && !s.buys.includes(i)) {
                    s.buys.push(i);
                    changesMade = true;
                    // Trigger Notification
                    triggerAutoBuyAlert(s.name, i);
                }

                lastPrice = pLevel; 
            }

            if(changesMade) {
                save();
                // If currently viewing this slot, refresh UI
                if(activeIdx === idx) {
                    calculate(); // This calls renderLevels
                }
            }
        }

        function triggerAutoBuyAlert(coin, level) {
            const audio = document.getElementById('alertSound'); 
            if(audio) { 
                audio.currentTime = 0; 
                audio.play().catch(e => {}); 
            } 
            if(navigator.vibrate) navigator.vibrate([100, 50, 100]); 
            showToast(`üõí COMPRA AUTO: ${coin} NIVEL ${level}`, 3000, false, true);
        }

        function calculateAvgPriceForSlot(s) { if(!s.price) return 0; let totalSpent = 0, totalQty = 0, lastPrice = s.price; const descPct = parseFloat(document.getElementById('descInput').value) || 66; const incPct = parseFloat(document.getElementById('incInput').value) || 7; const limit = customMultipliers ? customMultipliers.length : 12; for(let i=0; i<limit; i++){ let pLevel; if(i===0) pLevel = s.price; else { let step = (s.strat === "normal") ? (i===1 ? 17 : incPct) : descPct; pLevel = lastPrice * (1 - (step/100)); } if(s.buys.includes(i)) { const m = customMultipliers ? (customMultipliers[i] || 1) : 1; const mUSD = m * s.capital; totalSpent += mUSD; totalQty += (mUSD/pLevel); } lastPrice = pLevel; } return totalQty > 0 ? totalSpent/totalQty : 0; }
        function triggerAlert(coin) { const audio = document.getElementById('alertSound'); if(audio) audio.play().catch(e => console.log("Audio autoplay blocked by browser")); if(navigator.vibrate) navigator.vibrate([200, 100, 200]); showToast("üéØ OBJETIVO ALCANZADO: " + coin); }
        function toggleTheme() { isLight = !isLight; if(isLight) document.body.classList.add('light-mode'); else document.body.classList.remove('light-mode'); updateThemeIcon(); localStorage.setItem('theme', isLight ? 'light' : 'dark'); if(chartSymbol) loadChart(chartSymbol); }
        function updateThemeIcon() { document.getElementById('themeBtn').textContent = isLight ? '‚òÄÔ∏è' : 'üåô'; }
        function triggerHaptic() { if (navigator.vibrate) navigator.vibrate(10); }
        function forceCaps(el) { const start = el.selectionStart; const end = el.selectionEnd; el.value = el.value.toUpperCase(); el.setSelectionRange(start, end); }
        function handleEnter(e) { if(e.key === 'Enter') verifyAndAddCoin(); }
        function saveMultipliers() { 
            const inputs = document.querySelectorAll('.multi-inp');
            let newMultipliers = [];
            inputs.forEach(inp => {
                let val = parseFloat(inp.value);
                if(!isNaN(val)) newMultipliers.push(val);
            });
            if(newMultipliers.length < 5) return showToast("‚ö†Ô∏è M√≠nimo 5 niveles");
            customMultipliers = newMultipliers;
            localStorage.setItem('c5x_multipliers', JSON.stringify(customMultipliers)); 
            calculate();
        }
        function saveProxy() { const val = document.getElementById('setProxy').value.trim(); customProxy = val; localStorage.setItem('c5x_custom_proxy', customProxy); proxies = ['https://corsproxy.io/?', 'https://api.allorigins.win/raw?url=']; if(customProxy) proxies.unshift(customProxy); showToast("‚úÖ Proxy Actualizado"); }
        function startTickerSystem() { updateTicker(); setInterval(() => { if(!isTickerPinned) { assetIdx = (assetIdx + 1) % tickerAssets.length; localStorage.setItem('c5x_ticker_index', assetIdx); updateTicker(); } }, 7000); }
        async function updateTicker() { 
            let sym = tickerAssets[assetIdx]; 
            let apiSym = sym.includes('USDT') ? sym : sym + "USDT"; 
            let displaySym = sym.replace("USDT",""); 
            document.getElementById('t-sym').textContent = displaySym; 
            
            // SKELETON RESET
            document.getElementById('t-price').innerHTML = '<span class="skeleton-text skeleton-box"></span>';
            
            if(currentWs) { if(currentWs.url && currentWs.url.includes(apiSym.toLowerCase())) return; currentWs.close(); currentWs = null; } 
            try { 
                const wsUrl = `wss://stream.binance.com:9443/ws/${apiSym.toLowerCase()}@trade`; 
                currentWs = new WebSocket(wsUrl); 
                currentWs.onmessage = (event) => { 
                    const data = JSON.parse(event.data); 
                    const price = parseFloat(data.p); 
                    updateTickerUI(displaySym, price, true); 
                    updateSlotStatus(displaySym, price); 
                    document.getElementById('t-dot').classList.add('pulse'); 
                }; 
                currentWs.onerror = () => { 
                    fetchTickerRest(apiSym, displaySym); 
                    document.getElementById('t-dot').classList.remove('pulse'); 
                }; 
            } catch(e) { fetchTickerRest(apiSym, displaySym); } 
        }
        async function fetchTickerRest(apiSym, displaySym) { try { let price = 0; try { const res = await fetch(`https://api.binance.com/api/v3/ticker/price?symbol=${apiSym}`); if(res.ok) { const d = await res.json(); price = parseFloat(d.price); } } catch(e){} if(price === 0) { const gateSym = displaySym + "_USDT"; const proxy = proxies[0]; const res = await fetch(proxy + encodeURIComponent(`https://api.gateio.ws/api/v4/spot/tickers?currency_pair=${gateSym}`)); if(res.ok) { const data = await res.json(); if(data && data.length > 0) price = parseFloat(data[0].last); } } if(price > 0) { updateTickerUI(displaySym, price, true); updateSlotStatus(displaySym, price); } } catch(e) {} }
        function updateTickerUI(sym, price, isUp) { currentTickerSymbol = sym; let displayPrice = (price < 1) ? price.toFixed(8) : price.toLocaleString(); document.getElementById('t-price').textContent = displayPrice; document.getElementById('t-dot').style.background = isUp ? 'var(--long)' : 'var(--short)'; }
        function toggleTickerPin() { triggerHaptic(); isTickerPinned = !isTickerPinned; localStorage.setItem('c5x_ticker_pinned', isTickerPinned); updatePinUI(); if(isTickerPinned) showToast("‚öì Fijado: " + currentTickerSymbol); else { showToast("‚ñ∂Ô∏è Rotando"); updateTicker(); } }
        function updatePinUI() { const btn = document.getElementById('tickerPinBtn'); if(isTickerPinned) btn.classList.add('pinned'); else btn.classList.remove('pinned'); }
        function toggleFullscreenChart(e) { if(e) e.stopPropagation(); const wrapper = document.getElementById('tv_chart'); wrapper.classList.toggle('fullscreen'); setTimeout(() => loadChart(chartSymbol), 100); }
        async function loadGateETFs() { const grid = document.getElementById('etfGrid'); if(allGateETFs.length > 0) { filterETFs(""); return; } try { await fetchAndCalcTopDroppers(); filterETFs(""); } catch(e) { grid.innerHTML = '<div style="text-align:center; padding:20px; color:var(--danger)">Error al cargar datos.<br>Revisa tu conexi√≥n.</div>'; } }
        function toggleEtfFavorite(symbol, e) { e.stopPropagation(); if(etfFavorites.includes(symbol)) etfFavorites = etfFavorites.filter(s => s !== symbol); else etfFavorites.push(symbol); localStorage.setItem('c5x_etf_favorites', JSON.stringify(etfFavorites)); filterETFs(document.querySelector('.etf-search-input').value); }
        function filterETFs(query) { const grid = document.getElementById('etfGrid'); const term = query.toUpperCase().trim(); let sorted = [...allGateETFs].sort((a, b) => { const aFav = etfFavorites.includes(a.currency_pair.replace('_', '')); const bFav = etfFavorites.includes(b.currency_pair.replace('_', '')); if(aFav && !bFav) return -1; if(!aFav && bFav) return 1; return parseFloat(a.change_percentage) - parseFloat(b.change_percentage); }); let filtered = sorted; if(term) filtered = sorted.filter(t => t.currency_pair.includes(term)); else filtered = sorted.slice(0, 50); if(filtered.length === 0) { grid.innerHTML = '<div style="text-align:center; padding:20px; color:var(--text-tertiary)">Sin resultados</div>'; return; } const fragment = document.createDocumentFragment(); filtered.forEach((t, index) => { const price = parseFloat(t.last); const change = parseFloat(t.change_percentage); const displayPrice = (price < 1) ? price.toFixed(6) : price.toFixed(4); const pairName = t.currency_pair.replace('_', ''); const isFav = etfFavorites.includes(pairName); const div = document.createElement('div'); div.className = 'unified-card'; div.onclick = () => smartSelectETF(pairName, price); div.innerHTML = `<div class="u-index">${index+1}</div><div class="u-center"><div class="u-title">${pairName}</div></div><div class="etf-card-right"><div class="etf-change-badge ${change >= 0 ? 'etf-up' : 'etf-down'}">${change >= 0 ? '+' : ''}${change.toFixed(2)}%</div><div class="etf-fav-icon ${isFav ? 'is-fav' : ''}" onclick="toggleEtfFavorite('${pairName}', event)"><svg width="22" height="22" stroke="currentColor" fill="${isFav?'currentColor':'none'}" stroke-width="1.5"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg></div></div>`; fragment.appendChild(div); }); grid.innerHTML = ''; grid.appendChild(fragment); }
        function smartSelectETF(symbol, price) { triggerHaptic(); let cleanName = symbol.replace('_USDT','').replace('USDT',''); const dupSlot = slots.findIndex(s => s.name === cleanName); if (dupSlot !== -1) { showToast("‚õî " + cleanName + " YA EXISTE EN SLOT " + (dupSlot + 1)); return; } const emptySlotIdx = slots.findIndex(s => !s.name || s.name === ''); if(emptySlotIdx === -1) { showToast("‚ö†Ô∏è No hay slots disponibles"); return; } slots[emptySlotIdx].name = cleanName; slots[emptySlotIdx].price = price; slots[emptySlotIdx].buys = []; slots[emptySlotIdx].locked = true; slots[emptySlotIdx].note = ''; save(); updateBodyMode(cleanName); selectSlot(emptySlotIdx); switchView('operate', false); showToast("‚úÖ Agregado al Slot " + (emptySlotIdx + 1)); }
        function viewTickerChart(e) { if(e) e.stopPropagation(); chartSymbol = currentTickerSymbol.toUpperCase(); loadChart(chartSymbol); if(currentSection !== 'operate') switchView('operate', false); }
        function updateTF(tf, btn) { triggerHaptic(); activeTF = tf; localStorage.setItem('c5x_last_tf', tf); document.querySelectorAll('.tf-btn').forEach(b => b.classList.remove('active')); btn.classList.add('active'); loadChart(chartSymbol); }
        function loadChart(coin) { chartSymbol = (coin || 'BTC3L').toUpperCase(); new TradingView.widget({ "autosize": true, "symbol": `GATEIO:${chartSymbol.replace('USDT','') }USDT`, "interval": activeTF, "theme": isLight ? "light" : "dark", "container_id": "tv_chart", "hide_top_toolbar": true, "backgroundColor": isLight ? "#ffffff" : "#0b0e11", "locale": "es" }); }
        function selectSlot(i) { triggerHaptic(); activeIdx = i; localStorage.setItem('c5x_last_slot', i); const s = slots[i]; document.getElementById('coinInput').value = s.name; document.getElementById('baseInput').value = s.price || ''; document.getElementById('capitalInput').value = s.capital; renderNav(); loadChart(s.name); updateDashUI(); }
        function updateCoin() { const el = document.getElementById('coinInput'); let val = el.value.toUpperCase().replace('USDT','').trim(); if (val && slots.some((s, i) => s.name === val && i !== activeIdx)) { showToast("‚õî DUPLICADO"); el.value = slots[activeIdx].name; return; } el.value = val; slots[activeIdx].name = val; save(); renderNav(); loadChart(val); calculate(); }
        
        function rotateDash() { 
            triggerHaptic(); 
            const s = slots[activeIdx]; 
            // LOCK CHECK
            if(s.locked) return showToast("üîí Desbloquea para editar"); 
            
            s.strat = (s.strat === "normal") ? "agresiva" : "normal"; 
            save(); 
            updateDashUI(); 
        }
        
        function toggleLock() { 
            triggerHaptic(); 
            const s = slots[activeIdx]; 
            s.locked = !s.locked; 
            save(); 
            updateDashUI(); 
        }
        
        function updateDashUI() { 
            const s = slots[activeIdx], isNormal = s.strat === "normal"; 
            const elBadge = document.getElementById('stratBadge'); 
            const elCard = document.getElementById('dashMain'); 
            const elTarget = document.getElementById('resTarget'); 
            const btnLock = document.getElementById('lockBtn'); 
            
            elBadge.textContent = isNormal ? "NORMAL" : "AGRESIVA"; 
            
            if(isNormal) { 
                elBadge.classList.remove('aggressive'); 
                elCard.style.borderColor = "var(--border)"; 
            } else { 
                elBadge.classList.add('aggressive'); 
                elCard.style.borderColor = "var(--warning)"; 
            } 
            
            if(s.locked) { 
                btnLock.classList.add('locked'); 
                btnLock.innerHTML = '<svg width="24" height="24"><path d="M19 21H5a2 2 0 0 1-2-2V9a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2z"/><path d="M12 11v4"/><path d="M8 7v-2a4 4 0 0 1 8 0v2"/></svg>'; 
            } else { 
                btnLock.classList.remove('locked'); 
                btnLock.innerHTML = '<svg width="24" height="24"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>'; 
            } 
            
            document.getElementById('capitalInput').value = s.capital; 
            calculate(); 
        }
        function calculate() { const s = slots[activeIdx]; const inputVal = parseFloat(document.getElementById('baseInput').value); s.price = isNaN(inputVal) ? 0 : inputVal; save(); renderLevels(); }
        function toggleLvl(idx) { triggerHaptic(); const s = slots[activeIdx]; if (!s.buys.includes(idx)) { for(let i=0; i<=idx; i++) { if(!s.buys.includes(i)) s.buys.push(i); } } else { s.buys = s.buys.filter(val => val < idx); } calculate(); }
        function renderLevels() { const grid = document.getElementById('levelsGrid'), s = slots[activeIdx], descPct = parseFloat(document.getElementById('descInput').value) || 66, incPct = parseFloat(document.getElementById('incInput').value) || 7; updateBodyMode(s.name); if(!s.price || s.price <= 0) { grid.innerHTML = '<div style="text-align:center; padding:20px; color:var(--text-secondary)">Ingresa precio base</div>'; return; } let totalSpent = 0, totalQty = 0, lastPrice = s.price, currentStepDrop = 0, html = ''; const maxLevels = customMultipliers ? customMultipliers.length : 12; for(let i=0; i < maxLevels; i++){ let pLevel; if(i === 0) { pLevel = s.price; currentStepDrop = 0; } else { if(s.strat === "normal") { if(i === 1) currentStepDrop = 17; else currentStepDrop += incPct; } else { currentStepDrop = descPct; } pLevel = lastPrice * (1 - (currentStepDrop / 100)); } const mUSD = (customMultipliers[i] || 1) * s.capital, on = s.buys.includes(i); if(on) { totalSpent += mUSD; totalQty += (mUSD/pLevel); } const displayPrice = (pLevel < 1) ? pLevel.toFixed(8) : pLevel.toFixed(4); html += `<div class="unified-card ${on ? 'active' : ''}" onclick="toggleLvl(${i})"><div class="u-index">${i+1}</div><div class="u-center"><div class="u-title">${displayPrice}</div><div class="u-sub">${i===0 ? 'ENTRADA' : 'NIVEL ' + (i+1)}</div></div><div class="u-right"><div class="u-val-primary">$${mUSD.toFixed(1)}</div><div class="u-val-secondary">${i===0 ? '---' : '-'+currentStepDrop.toFixed(1)+'%'}</div></div></div>`; lastPrice = pLevel; } html += `<div class="liquidate-card anim-click" onclick="openLiquidateConfirm()"><svg width="18" height="18"><path d="M18 6L6 18M6 6l12 12"/></svg> LIQUIDAR POSICI√ìN</div>`; grid.innerHTML = html; const avg = totalQty > 0 ? totalSpent/totalQty : 0; const targetPrice = avg * (1 + (s.roi / 100)); document.getElementById('resInv').textContent = `$${totalSpent.toFixed(2)}`; document.getElementById('resAvg').textContent = (avg < 1) ? avg.toFixed(8) : avg.toFixed(4); document.getElementById('resTarget').textContent = (targetPrice < 1) ? targetPrice.toFixed(8) : targetPrice.toFixed(4); document.getElementById('resProfit').textContent = `$${totalSpent.toFixed(2)}`; }
        function openLiquidateConfirm() { triggerHaptic(); const s = slots[activeIdx]; if(!s.name || s.price <= 0) return showToast("‚ö†Ô∏è Slot Vac√≠o"); document.getElementById('confirmModal').style.display = 'flex'; }
        
        function executeRelease() { 
            triggerHaptic(); closeModals(); 
            try { 
                const s = slots[activeIdx]; 
                const totalInv = parseFloat(document.getElementById('resInv').textContent.replace('$','')) || 0; 
                const avgPrice = parseFloat(document.getElementById('resAvg').textContent) || 0; 
                const targetPrice = avgPrice * (1 + (s.roi / 100)); 
                const grossExitValue = totalInv * (1 + (s.roi / 100));
                const entryFee = totalInv * (exchangeFee / 100);
                const exitFee = grossExitValue * (exchangeFee / 100);
                const totalFees = entryFee + exitFee;
                const grossProfit = grossExitValue - totalInv;
                const netProfit = grossProfit - totalFees;

                const logEntry = { 
                    date: new Date().toLocaleDateString(), 
                    time: new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}), 
                    coin: s.name || 'S/N', 
                    strategy: s.strat.toUpperCase(), 
                    basePrice: s.price, 
                    avgPrice: avgPrice, 
                    exitPrice: targetPrice, 
                    qty: (avgPrice > 0 ? totalInv/avgPrice : 0).toFixed(8), 
                    totalInv: totalInv.toFixed(2), 
                    profit: grossProfit.toFixed(2), 
                    netProfit: netProfit.toFixed(2), 
                    fees: totalFees.toFixed(2), 
                    roi: s.roi + '%', 
                    levelsUsed: s.buys ? s.buys.length : 0 
                }; 
                
                if(!history) history = []; 
                history.push(logEntry); 
                localStorage.setItem('c5x_history', JSON.stringify(history)); 
                
                renderHistory(); 
                // RESET TO LOCKED NORMAL
                slots[activeIdx] = { name:'', price:0, capital:5, buys:[], strat:'normal', locked: true, roi: 100, note: '', alerted: false }; 
                sortSlots(); 
                save(); 
                selectSlot(0); 
                showToast(`‚úÖ Cerrada. Neta: $${netProfit.toFixed(2)}`); 
                switchView('log', false); 
                calculateGlobalStats(); 
            } catch(e) { showToast("‚ùå Error al liquidar"); } 
        }

        function updateBodyMode(n) { const r = document.querySelector(':root'); if(!n) { r.style.setProperty('--brand', '#3b82f6'); return; } if(n.includes('3S') || n.includes('5S') || n.endsWith('S')) { r.style.setProperty('--brand', 'var(--short)'); } else if (n.includes('3L') || n.includes('5L') || n.endsWith('L')) { r.style.setProperty('--brand', 'var(--long)'); } else { r.style.setProperty('--brand', '#3b82f6'); } }
        function renderHistory() { 
            const grid = document.getElementById('logGrid'); 
            if(!history || history.length === 0) { 
                grid.innerHTML = '<div style="text-align:center; padding:20px; color:var(--text-secondary)">Sin registros</div>'; return; 
            } 
            grid.innerHTML = history.map(h => { 
                const hasNet = h.netProfit !== undefined;
                const finalProfit = hasNet ? parseFloat(h.netProfit) : parseFloat(h.profit);
                const isWin = finalProfit >= 0; 
                return `<div class="unified-card">
                            <div class="u-index" style="color:var(--brand)">${h.coin.substring(0,3)}</div>
                            <div class="u-center">
                                <div class="u-title">${h.coin}</div>
                                <div class="u-sub">${h.date} - ${h.time}</div>
                            </div>
                            <div class="u-right">
                                <div class="u-val-primary" style="color:${isWin?'var(--long)':'var(--short)'}">${isWin?'+':''}$${finalProfit.toFixed(2)}</div>
                                <div class="u-val-secondary">${hasNet ? 'NETO' : 'BRUTO'} ${h.roi}</div>
                            </div>
                        </div>`; 
            }).reverse().join('');
        }
        function triggerDriveBackup() {
            const dataStr = JSON.stringify({ slots, history, tickerAssets, customMultipliers, etfFavorites, customProxy, globalCapital, appConfig }); 
            const blob = new Blob([dataStr], {type: "application/json"}); 
            const a = document.createElement('a'); 
            const date = new Date().toISOString().slice(0,10);
            a.href = URL.createObjectURL(blob); 
            a.download = `C5X_Backup_${date}.json`; 
            document.body.appendChild(a); 
            a.click();
            localStorage.setItem('c5x_last_backup', Date.now());
            showToast("‚òÅÔ∏è Archivo generado para Drive");
        }
        function checkAutoBackup() {
            const last = localStorage.getItem('c5x_last_backup');
            const now = Date.now();
            if(!last || (now - last > 2592000000)) { 
                if(confirm("‚ö†Ô∏è Han pasado 30 d√≠as desde tu √∫ltimo respaldo. ¬øGuardar en Drive ahora?")) {
                    triggerDriveBackup();
                }
            }
        }
        function openSecurity(cb) { secCallback = cb; document.getElementById('secInput').value = ''; document.getElementById('securityModal').style.display = 'flex'; }
        
        function closeModals() { document.querySelectorAll('.generic-modal').forEach(m => m.style.display = 'none'); }
        function renderNav() { document.getElementById('slotNav').innerHTML = slots.map((s, i) => { let statusClass = ''; if(s.name) statusClass = 'is-occupied'; return `<div class="slot-card ${i === activeIdx ? 'active' : ''} ${statusClass}" id="nav-s${i}" onclick="selectSlot(${i})">${s.name || 'S'+(i+1)}</div>`; }).join(''); }
        function save() { localStorage.setItem('dca_v18_slots', JSON.stringify(slots)); }
        function clearLogs() { openSecurity(() => { history = []; localStorage.setItem('c5x_history', JSON.stringify(history)); renderHistory(); calculateGlobalStats(); showToast("üóëÔ∏è Historial Borrado"); }); }
        function resetApp() { openSecurity(() => { localStorage.clear(); location.reload(); }); }
        function toggleMenu() { const m = document.getElementById('navModal'); m.style.display = (m.style.display === 'flex') ? 'none' : 'flex'; }
        
        function loadSettingsValues() { 
            const s = slots[activeIdx]; 
            document.getElementById('setCapital').value = s.capital; 
            document.getElementById('setInc').value = document.getElementById('incInput').value; 
            document.getElementById('setDesc').value = document.getElementById('descInput').value; 
            document.getElementById('setRoi').value = s.roi || 100; 
            document.getElementById('setGlobalCapital').value = globalCapital; 
            document.getElementById('setFee').value = exchangeFee; // LOAD FEE
            document.getElementById('setRadarLimit').value = radarLimit; 
            document.getElementById('setRadarSpeed').value = radarSpeed; 
            document.getElementById('setDD').value = appConfig.dd; 
            document.getElementById('setNewPass').value = ''; 
            
            const grid = document.getElementById('multiGrid');
            grid.innerHTML = customMultipliers.map((val, i) => `
                <div class="multi-item">
                    <span class="multi-lbl">N${i+1}</span>
                    <input type="number" class="multi-inp" value="${val}" step="0.1">
                </div>
            `).join('');

            calcMonthlyPerformance(); 
        }
        function calcMonthlyPerformance() { 
            const now = new Date(); const currentMonth = now.getMonth(); const currentYear = now.getFullYear(); 
            let monthlyProfit = 0; 
            history.forEach(h => { 
                const parts = h.date.split('/'); 
                if(parts.length === 3) { 
                    const hDate = new Date(parts[2], parts[1]-1, parts[0]); 
                    if(hDate.getMonth() === currentMonth && hDate.getFullYear() === currentYear) { 
                        // Use netProfit if exists
                        monthlyProfit += (h.netProfit !== undefined ? parseFloat(h.netProfit) : (parseFloat(h.profit) || 0)); 
                    } 
                } 
            }); 
            let growth = (globalCapital > 0) ? (monthlyProfit / globalCapital) * 100 : 0; 
            const el = document.getElementById('monthlyProfitDisplay'); 
            el.innerHTML = `$${monthlyProfit.toFixed(2)} <span style="font-size:14px; color:${monthlyProfit>=0?'var(--long)':'var(--short)'}">(${growth.toFixed(2)}%)</span>`; 
        }
        
        function verifyAndAddCoin() { const input = document.getElementById('newTickerCoin'); let val = input.value.trim().toUpperCase().replace('USDT',''); if(!val) return; tickerAssets.push(val); localStorage.setItem('c5x_ticker_assets', JSON.stringify(tickerAssets)); input.value=''; renderTickerSettings(); showToast("‚úÖ Agregada"); }
        function renderTickerSettings() { document.getElementById('tickerChipsContainer').innerHTML = tickerAssets.map((a,i)=>`<div class="chip">${a}<div class="chip-del" onclick="removeTickerCoin(${i})">‚úï</div></div>`).join(''); }
        function removeTickerCoin(i) { tickerAssets.splice(i,1); localStorage.setItem('c5x_ticker_assets', JSON.stringify(tickerAssets)); renderTickerSettings(); }
        function exportPDF() { 
            if(history.length === 0) return showToast("‚ö†Ô∏è Sin Datos"); 
            const { jsPDF } = window.jspdf; 
            const doc = new jsPDF('l', 'mm', 'a4'); 
            let totalProfit = 0; let totalInvested = 0; let wins = 0; 
            history.forEach(h => { 
                const inv = parseFloat(h.totalInv) || 0; 
                // Use Net
                const prof = (h.netProfit !== undefined ? parseFloat(h.netProfit) : parseFloat(h.profit)) || 0; 
                totalInvested += inv; 
                totalProfit += prof; 
                if(prof > 0) wins++; 
            }); 
            const winRate = history.length > 0 ? ((wins / history.length) * 100).toFixed(1) : 0; 
            doc.setFillColor(11, 14, 17); doc.rect(0, 0, 297, 25, 'F'); doc.setFont("helvetica", "bold"); doc.setFontSize(22); doc.setTextColor(59, 130, 246); doc.text("C5X", 14, 16); doc.setFontSize(14); doc.setTextColor(255, 255, 255); doc.text("REPORTE PROFESIONAL", 40, 16); 
            doc.setFillColor(245, 247, 250); doc.rect(14, 30, 270, 20, 'F'); doc.setFontSize(10); doc.setTextColor(80); 
            doc.text("CAPITAL MOVIDO", 20, 38); doc.text("NET PROFIT", 90, 38); doc.text("WIN RATE", 160, 38); doc.text("TOTAL OPS", 230, 38); 
            doc.setFontSize(14); doc.setTextColor(0); 
            doc.text("$" + totalInvested.toFixed(2), 20, 46); 
            doc.setTextColor(totalProfit >= 0 ? 14 : 200, totalProfit >= 0 ? 203 : 50, totalProfit >= 0 ? 129 : 50); 
            doc.text((totalProfit>=0?'+':'') + "$" + totalProfit.toFixed(2), 90, 46); 
            doc.setTextColor(0); doc.text(winRate + "%", 160, 46); doc.text(history.length.toString(), 230, 46); 
            
            const bodyData = history.map(h => { 
                const inv = parseFloat(h.totalInv) || 0; 
                const prof = (h.netProfit !== undefined ? parseFloat(h.netProfit) : parseFloat(h.profit)) || 0;
                const avg = parseFloat(h.avgPrice) || 0; 
                const exit = parseFloat(h.exitPrice) || 0; 
                return [ h.date + '\n' + h.time, h.coin, '$' + (avg < 1 ? avg.toFixed(6) : avg.toFixed(2)), '$' + (exit < 1 ? exit.toFixed(6) : exit.toFixed(2)), '$' + inv.toFixed(2), (prof>=0?'+':'') + '$' + prof.toFixed(2), h.roi ]; 
            }); 
            
            doc.autoTable({ head: [['FECHA / HORA', 'ACTIVO', 'PRECIO ENT.', 'PRECIO SALIDA', 'INVERSI√ìN', 'PNL NETO', 'ROI']], body: bodyData, startY: 58, theme: 'grid', styles: { fontSize: 9, cellPadding: 3, valign: 'middle', halign: 'center' }, headStyles: { fillColor: [21, 26, 33], textColor: 255, fontStyle: 'bold', halign: 'center' }, didParseCell: function(data) { if (data.section === 'body' && data.column.index === 5) { const raw = data.cell.raw; if(raw.startsWith('+')) data.cell.styles.textColor = [14, 203, 129]; else data.cell.styles.textColor = [246, 70, 93]; } } }); 
            doc.save("C5X_Pro_Report.pdf"); 
        }
        function exportData() { const dataStr = JSON.stringify({ slots, history, tickerAssets, customMultipliers, etfFavorites, customProxy, globalCapital, appConfig }); const blob = new Blob([dataStr], {type: "application/json"}); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = "C5X_Backup.json"; document.body.appendChild(a); a.click(); }
        function importData(input) { const file = input.files[0]; if(!file) return; const reader = new FileReader(); reader.onload = function(e) { try { const data = JSON.parse(e.target.result); if(data.slots) slots = data.slots; if(data.history) history = data.history; if(data.customMultipliers) { customMultipliers = data.customMultipliers; localStorage.setItem('c5x_multipliers', JSON.stringify(customMultipliers)); } if(data.customProxy) { customProxy = data.customProxy; localStorage.setItem('c5x_custom_proxy', customProxy); } if(data.etfFavorites) { etfFavorites = data.etfFavorites; localStorage.setItem('c5x_etf_favorites', JSON.stringify(etfFavorites)); } if(data.globalCapital) { globalCapital = data.globalCapital; localStorage.setItem('c5x_global_capital', globalCapital); } if(data.appConfig) { appConfig = data.appConfig; localStorage.setItem('c5x_config', JSON.stringify(appConfig)); } save(); localStorage.setItem('c5x_history', JSON.stringify(history)); location.reload(); } catch(err) { showToast("‚ùå Error al leer archivo"); } }; reader.readAsText(file); }
    </script>
</body>
</html>