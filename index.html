<style>
    /* Estilos específicos para las nuevas funciones de las tarjetas */
    .gain-edit {
        background: rgba(255, 255, 255, 0.05); border: 1px solid var(--border);
        color: var(--long-green); font-weight: 900; width: 50px; border-radius: 4px;
        text-align: center; font-size: 12px; padding: 2px; outline: none;
    }
    
    /* Modal de PIN Seguro */
    #pinModal {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.95); z-index: 9999; display: none;
        flex-direction: column; align-items: center; justify-content: center;
    }
    .pin-dots { font-size: 40px; color: var(--dir-color); margin-bottom: 20px; letter-spacing: 15px; }
    .pin-grid { display: grid; grid-template-columns: repeat(3, 70px); gap: 15px; }
    .pin-key {
        width: 70px; height: 70px; border-radius: 50%; border: 1px solid var(--border);
        background: var(--surface); color: var(--text); font-size: 22px; font-weight: 900;
        display: flex; align-items: center; justify-content: center;
    }
    .pin-key:active { background: var(--dir-color); }
</style>

<div id="pinModal">
    <div style="color:white; margin-bottom:20px; font-family:'Orbitron';">SEGURIDAD C5X</div>
    <div class="pin-dots" id="pinDisplay">____</div>
    <div class="pin-grid">
        <div class="pin-key" onclick="pressPin('1')">1</div>
        <div class="pin-key" onclick="pressPin('2')">2</div>
        <div class="pin-key" onclick="pressPin('3')">3</div>
        <div class="pin-key" onclick="pressPin('4')">4</div>
        <div class="pin-key" onclick="pressPin('5')">5</div>
        <div class="pin-key" onclick="pressPin('6')">6</div>
        <div class="pin-key" onclick="pressPin('7')">7</div>
        <div class="pin-key" onclick="pressPin('8')">8</div>
        <div class="pin-key" onclick="pressPin('9')">9</div>
        <div class="pin-key" onclick="closePin()" style="color:var(--danger)">X</div>
        <div class="pin-key" onclick="pressPin('0')">0</div>
        <div class="pin-key" onclick="clearPin()">←</div>
    </div>
</div>

<script>
// --- LÓGICA EXCLUSIVA PARA LOS NIVELES ---

let currentPinInput = "";
let pendingLevelAction = null;

// Configuración inicial de ganancias por bloques de 4 niveles
const defaultGains = [
    50, 50, 50, 50,    // Niveles 1-4
    100, 100, 100, 100, // Niveles 5-8
    150, 150, 150, 150, // Niveles 9-12
    200, 200, 200, 200  // Niveles 13-16
];

// 1. Función de selección en cascada automática
function toggleLvlCascade(index) {
    const s = slots[activeIdx];
    if (s.buys.includes(index)) {
        // Si se apaga, apaga todos los niveles superiores también
        s.buys = s.buys.filter(i => i < index);
    } else {
        // Si se enciende, enciende todos los niveles anteriores automáticamente
        let newBuys = [];
        for (let i = 0; i <= index; i++) {
            newBuys.push(i);
        }
        s.buys = newBuys;
    }
    calculate();
}

// 2. Función para solicitar el PIN antes de editar
function requestGainEdit(idx, newVal, inputElement) {
    pendingLevelAction = { type: 'gain', idx: idx, val: newVal, el: inputElement };
    openPin();
}

// 3. Lógica del Teclado Numérico con Asteriscos
function openPin() {
    currentPinInput = "";
    document.getElementById('pinDisplay').textContent = "____";
    document.getElementById('pinModal').style.display = "flex";
}

function pressPin(num) {
    if (currentPinInput.length < 4) {
        currentPinInput += num;
        document.getElementById('pinDisplay').textContent = "*".repeat(currentPinInput.length) + "_".repeat(4 - currentPinInput.length);
    }
    if (currentPinInput.length === 4) {
        if (currentPinInput === "2524") {
            executePendingAction();
            closePin();
        } else {
            alert("PIN INCORRECTO");
            closePin();
            calculate(); // Revierte cambios visuales
        }
    }
}

function executePendingAction() {
    if (pendingLevelAction.type === 'gain') {
        slots[activeIdx].gains[pendingLevelAction.idx] = parseFloat(pendingLevelAction.val);
        calculate();
    }
}

function closePin() { document.getElementById('pinModal').style.display = "none"; }
function clearPin() { currentPinInput = ""; document.getElementById('pinDisplay').textContent = "____"; }

// 4. Renderizado actualizado de las tarjetas
function renderLevels() {
    const grid = document.getElementById('levelsGrid'), s = slots[activeIdx];
    if (!s.gains) s.gains = [...defaultGains];
    
    if (!s.price) { grid.innerHTML = ''; return; }
    
    let spent = 0, tokens = 0, cp = s.price, html = '', lastGain = 0;
    
    strategy.forEach((lvl, i) => {
        if (i > 0) cp *= (1 - lvl.c);
        const mUSD = lvl.m * s.capital;
        const on = s.buys.includes(i);
        const currentGain = s.gains[i];
        
        if (on) { 
            spent += mUSD; 
            tokens += (mUSD / cp); 
            lastGain = currentGain; 
        }
        
        html += `
        <div class="level-card ${on ? 'active' : ''}" onclick="toggleLvlCascade(${i})">
            <input type="checkbox" class="check-box-large" ${on ? 'checked' : ''}>
            <div class="lvl-grid-content">
                <div class="lvl-col-left">
                    <span class="tag-sim" style="color:var(--dir-color)">NV ${i+1}</span>
                    <span class="val-sim">$${mUSD.toFixed(1)}</span>
                </div>
                <div class="lvl-col-right">
                    <div style="display:flex; justify-content:flex-end; align-items:center; gap:5px;">
                        <input type="number" class="gain-edit" value="${currentGain}" 
                            onclick="event.stopPropagation()" 
                            onchange="requestGainEdit(${i}, this.value, this)">
                        <span class="val-sim" style="color:var(--short-red)">${lvl.p}</span>
                    </div>
                    <span class="val-sim">${cp.toFixed(6)}</span>
                </div>
            </div>
        </div>`;
    });
    
    grid.innerHTML = html;
    
    // Actualización del Dashboard con el % del último nivel seleccionado
    const avg = tokens > 0 ? (spent / tokens) : 0;
    document.getElementById('resInv').textContent = `$${spent.toFixed(2)}`;
    document.getElementById('resAvg').textContent = avg.toFixed(6);
    document.getElementById('resTarget').textContent = avg > 0 ? (avg * (1 + (lastGain/100))).toFixed(6) : '0.000000';
    document.getElementById('resProf').textContent = `$${(spent * (lastGain/100)).toFixed(2)}`;
}
</script>
