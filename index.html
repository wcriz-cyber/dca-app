<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>C5X DCA ENGINE V44.5</title>
    <meta name="theme-color" content="#0b0e11">
    
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@500;600;700;800&family=JetBrains+Mono:wght@500;700;800&family=Orbitron:wght@600;900&display=swap" rel="stylesheet">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <style>
        :root {
            --bg-main: #0b0e11; --bg-card: #181a20; --bg-input: #1e2329;
            --accent: #fcd535; --long: #0ecb81; --short: #f6465d;
            --text-primary: #eaecef; --text-secondary: #929aa5; --text-tertiary: #474d57;
            --border: rgba(255,255,255,0.05); --header-h: 60px; --tab-h: 70px;
        }

        * { margin:0; padding:0; box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
        body { background: var(--bg-main); color: var(--text-primary); font-family: 'Rajdhani', sans-serif; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }

        /* HEADER & TICKER */
        header { height: var(--header-h); background: rgba(11,14,17,0.98); border-bottom: 1px solid var(--border); display: flex; align-items: center; padding: 0 15px; position: relative; z-index: 100; }
        .ticker-container { flex:1; overflow:hidden; white-space:nowrap; margin-right:10px; }
        #tickerScroll { display:inline-block; animation: scrollTicker 40s linear infinite; }
        @keyframes scrollTicker { from { transform: translateX(100%); } to { transform: translateX(-100%); } }
        .ticker-item { display:inline-block; margin-right:20px; font-family:'JetBrains Mono'; font-size:12px; font-weight:700; }

        /* MAIN CONTENT */
        main { flex:1; overflow-y:auto; padding:15px 15px 120px; }

        /* SLOTS */
        .slots-grid { display:grid; grid-template-columns: repeat(4, 1fr); gap:8px; margin-bottom:15px; }
        .slot-btn { 
            background: var(--bg-card); border: 1px solid var(--border); border-radius:10px; padding:10px 4px;
            text-align:center; position:relative; transition: 0.2s;
        }
        .slot-btn.active { border-color: var(--accent); background: rgba(252,213,53,0.05); }
        .slot-btn.is-long { border-bottom: 3px solid var(--long); }
        .slot-btn.is-short { border-bottom: 3px solid var(--short); }
        .slot-btn span { display:block; font-size:11px; font-weight:800; overflow:hidden; text-overflow:ellipsis; }

        /* CONTROL CARD */
        .control-card { background:var(--bg-card); border-radius:16px; padding:18px; margin-bottom:15px; border:1px solid var(--border); }
        .input-row { display:flex; gap:10px; margin-bottom:12px; }
        .input-group { flex:1; }
        .input-group label { display:block; font-size:10px; color:var(--text-secondary); margin-bottom:4px; font-weight:700; }
        .input-wrap { background:var(--bg-input); border-radius:8px; border:1px solid var(--border); display:flex; align-items:center; }
        .input-wrap input { width:100%; background:transparent; border:none; padding:10px; color:var(--text-primary); font-family:'JetBrains Mono'; font-weight:700; font-size:14px; }

        /* STRAT TOGGLE */
        .strat-toggle { display:flex; background:var(--bg-input); border-radius:10px; padding:4px; margin-bottom:12px; }
        .st-btn { flex:1; padding:8px; border:none; background:transparent; color:var(--text-secondary); font-weight:800; border-radius:8px; font-size:11px; }
        .st-btn.active { background:var(--bg-card); color:var(--accent); }

        /* NIVELES ESTILO V44.5 */
        .levels-grid { display: flex; flex-direction: column; gap: 6px; }
        .unified-card {
            background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px;
            display: flex; align-items: center; padding: 10px 15px; transition: 0.2s;
        }
        .unified-card.active { background: rgba(255,255,255,0.05); border-left: 4px solid var(--accent); }
        .u-index { width: 25px; font-family: 'Orbitron'; font-size: 13px; color: var(--text-tertiary); }
        .u-center { flex: 1; }
        
        /* PRECIO GRANDE Y CLARO */
        .u-title { 
            font-family: 'JetBrains Mono', monospace; 
            font-size: 20px; /* Tamaño solicitado */
            font-weight: 800; 
            color: var(--text-primary); 
            line-height: 1;
        }
        .u-sub { font-size: 9px; font-weight: 800; color: var(--text-tertiary); margin-top: 2px; }
        
        .u-right { text-align: right; }
        .u-val-primary { font-family: 'JetBrains Mono'; font-size: 14px; font-weight: 700; color: var(--accent); }
        .u-val-secondary { font-size: 11px; font-weight: 700; color: var(--text-secondary); }

        /* DASHBOARD FLOTANTE */
        .res-panel { 
            position: fixed; bottom: 85px; left: 15px; right: 15px; 
            background: var(--accent); color: #000; border-radius: 14px; 
            padding: 12px 18px; display: flex; justify-content: space-between; 
            z-index: 900; box-shadow: 0 8px 32px rgba(0,0,0,0.5);
        }
        .res-item span { display:block; font-size:9px; font-weight:800; text-transform:uppercase; opacity:0.7; }
        .res-item div { font-family:'JetBrains Mono'; font-size:15px; font-weight:800; }

        /* NAVBAR */
        nav { 
            position: fixed; bottom: 0; left: 0; right: 0; height: var(--tab-h);
            background: #181a20; border-top: 1px solid var(--border);
            display: flex; align-items: center; justify-content: space-around; padding-bottom: 10px;
        }
        .nav-item { flex:1; text-align:center; color: var(--text-secondary); font-size:10px; font-weight:700; }
        .nav-item.active { color: var(--accent); }
        .nav-item svg { display:block; margin:0 auto 4px; width:20px; height:20px; }

        .hidden { display: none; }
    </style>
</head>
<body>

<header>
    <div class="ticker-container"><div id="tickerScroll">CONECTANDO GATE.IO...</div></div>
    <div style="font-family:'Orbitron'; font-size:16px; font-weight:900; color:var(--accent);">C5X</div>
</header>

<main>
    <section id="view-operar">
        <div class="slots-grid" id="slotsGrid"></div>

        <div class="control-card">
            <div class="input-row">
                <div class="input-group">
                    <label>TOKEN (BTC3L / ETH5S)</label>
                    <div class="input-wrap"><input type="text" id="coinInput" placeholder="SUI3L" oninput="updateSlot()"></div>
                </div>
                <div class="input-group">
                    <label>PRECIO ACTUAL</label>
                    <div class="input-wrap"><input type="number" id="priceInput" step="any" oninput="updateSlot()"></div>
                </div>
            </div>

            <div class="strat-toggle">
                <button class="st-btn active" id="btnNormal" onclick="setStrat('normal')">ESTRATEGIA NORMAL</button>
                <button class="st-btn" id="btnAgg" onclick="setStrat('aggressive')">AGRESIVA (DCA66)</button>
            </div>

            <div class="input-row">
                <div class="input-group">
                    <label>CAPITAL BASE ($)</label>
                    <div class="input-wrap"><input type="number" id="capInput" oninput="updateSlot()"></div>
                </div>
                <div class="input-group">
                    <label>OBJETIVO ROI %</label>
                    <div class="input-wrap"><input type="number" id="roiInput" oninput="updateSlot()"></div>
                </div>
            </div>
            
            <div id="configLock" class="hidden">
                <div class="input-row" style="margin-top:10px; border-top:1px solid var(--border); padding-top:10px;">
                    <div class="input-group">
                        <label>INC. CAÍDA %</label>
                        <input type="number" id="incInput" value="7" style="width:100%; background:var(--bg-input); color:#fff; border:none; padding:8px; border-radius:5px;" oninput="updateSlot()">
                    </div>
                    <div class="input-group">
                        <label>CAÍDA FIJA %</label>
                        <input type="number" id="descInput" value="66" style="width:100%; background:var(--bg-input); color:#fff; border:none; padding:8px; border-radius:5px;" oninput="updateSlot()">
                    </div>
                </div>
            </div>
            <button onclick="unlock()" style="width:100%; background:transparent; border:none; color:var(--text-tertiary); font-size:9px; margin-top:5px;">[ CONFIGURACIÓN AVANZADA ]</button>
        </div>

        <div class="levels-grid" id="levelsGrid"></div>
    </section>

    <section id="view-log" class="hidden">
        <div class="control-card">
            <h3 style="color:var(--accent); font-family:'Orbitron'; font-size:14px; margin-bottom:15px;">BITÁCORA DE OPERACIONES</h3>
            <div id="logContent"></div>
        </div>
    </section>
</main>

<div class="res-panel" id="resPanel">
    <div class="res-item"><span>INVERSIÓN</span><div id="resInv">$0.00</div></div>
    <div class="res-item"><span>PROMEDIO (AVG)</span><div id="resAvg">0.0000</div></div>
    <div class="res-item"><span>VENTA (TARGET)</span><div id="resTarget">0.0000</div></div>
</div>

<nav>
    <div class="nav-item active" onclick="switchView('operar', this)">
        <svg viewBox="0 0 24 24" fill="currentColor"><path d="M21 16.5V7.5L12 2L3 7.5V16.5L12 22L21 16.5Z"/></svg>
        OPERAR
    </div>
    <div class="nav-item" onclick="switchView('log', this)">
        <svg viewBox="0 0 24 24" fill="currentColor"><path d="M14 2H6C4.9 2 4 2.9 4 4V20C4 21.1 4.9 22 6 22H18C19.1 22 20 21.1 20 20V8L14 2Z"/></svg>
        BITÁCORA
    </div>
</nav>

<script>
    let slots = JSON.parse(localStorage.getItem('c5x_v44_slots')) || Array(8).fill().map((_,i)=>({
        id:i, name:'', price:0, capital:10, roi:50, strat:'normal', buys:[0]
    }));
    let activeIdx = 0;
    let history = JSON.parse(localStorage.getItem('c5x_v44_history')) || [];
    let customMultipliers = [1, 1, 2, 4, 8, 16, 32, 64, 128, 256, 512, 1024];

    function save() { localStorage.setItem('c5x_v44_slots', JSON.stringify(slots)); }

    async function updateTicker() {
        try {
            const r = await fetch('https://api.gateio.ws/api/v4/spot/tickers');
            const data = await r.json();
            const list = ['BTC_USDT','ETH_USDT','SOL_USDT','AVAX_USDT','DOGE_USDT'];
            document.getElementById('tickerScroll').innerHTML = data.filter(t => list.includes(t.currency_pair))
                .map(t => `<span class="ticker-item">${t.currency_pair.split('_')[0]} $${parseFloat(t.last).toFixed(2)}</span>`).join('');
        } catch(e){}
    }
    setInterval(updateTicker, 15000); updateTicker();

    function renderSlots() {
        const grid = document.getElementById('slotsGrid');
        grid.innerHTML = slots.map((s, i) => {
            let cls = s.id === activeIdx ? 'active' : '';
            if(s.name.includes('3L') || s.name.includes('5L')) cls += ' is-long';
            if(s.name.includes('3S') || s.name.includes('5S')) cls += ' is-short';
            return `<div class="slot-btn ${cls}" onclick="selectSlot(${i})">
                <span>${s.name || 'SLOT '+(i+1)}</span>
                <div style="font-size:8px; color:var(--text-tertiary)">${s.strat.toUpperCase()}</div>
            </div>`;
        }).join('');
    }

    function selectSlot(idx) {
        activeIdx = idx;
        const s = slots[idx];
        document.getElementById('coinInput').value = s.name;
        document.getElementById('priceInput').value = s.price || '';
        document.getElementById('capInput').value = s.capital;
        document.getElementById('roiInput').value = s.roi;
        setStrat(s.strat, false);
        renderSlots();
        renderLevels();
    }

    function updateSlot() {
        const s = slots[activeIdx];
        s.name = document.getElementById('coinInput').value.toUpperCase();
        s.price = parseFloat(document.getElementById('priceInput').value) || 0;
        s.capital = parseFloat(document.getElementById('capInput').value) || 10;
        s.roi = parseFloat(document.getElementById('roiInput').value) || 50;
        save(); renderSlots(); renderLevels();
    }

    function setStrat(st, up=true) {
        slots[activeIdx].strat = st;
        document.getElementById('btnNormal').classList.toggle('active', st==='normal');
        document.getElementById('btnAgg').classList.toggle('active', st==='aggressive');
        if(up){ save(); renderSlots(); renderLevels(); }
    }

    function formatPrice(p) {
        if (p < 0.000001) return p.toFixed(10);
        if (p < 0.001) return p.toFixed(8);
        if (p < 1) return p.toFixed(6);
        return p.toFixed(4);
    }

    function renderLevels() {
        const grid = document.getElementById('levelsGrid');
        const s = slots[activeIdx];
        if(!s.price) { grid.innerHTML = ''; return; }

        const inc = parseFloat(document.getElementById('incInput').value) || 7;
        const fix = parseFloat(document.getElementById('descInput').value) || 66;
        
        let html = '', lastP = s.price, totalSpent = 0, totalQty = 0, currentDrop = 0;

        for(let i=0; i<12; i++) {
            let pLvl;
            if(i===0) { pLvl = s.price; }
            else {
                if(s.strat === 'normal') {
                    let step = (i === 1) ? 17 : inc;
                    currentDrop += step;
                } else {
                    currentDrop = fix;
                }
                pLvl = lastP * (1 - (currentDrop/100));
            }

            const mUSD = customMultipliers[i] * s.capital;
            const active = s.buys.includes(i);
            if(active) { totalSpent += mUSD; totalQty += (mUSD/pLvl); }

            // RENDER: Sin palabra Nivel, Precio Grande, Formato de Ceros arreglado
            html += `<div class="unified-card ${active?'active':''}" onclick="toggleLvl(${i})">
                <div class="u-index">${i+1}</div>
                <div class="u-center">
                    <div class="u-title">${formatPrice(pLvl)}</div>
                    <div class="u-sub">${i===0?'PUNTO DE ENTRADA':''}</div>
                </div>
                <div class="u-right">
                    <div class="u-val-primary">$${mUSD}</div>
                    <div class="u-val-secondary" style="color:${i>0?'var(--short)':'var(--text-tertiary)'}">${i===0?'- - -':'-'+currentDrop.toFixed(1)+'%'}</div>
                </div>
            </div>`;
            
            // Si es agresivo, la caída es sobre el precio anterior siempre
            if(s.strat === 'aggressive') lastP = pLvl; 
            else lastP = pLvl; // En normal también mantenemos la lógica de cascada solicitada
        }
        grid.innerHTML = html;

        const avg = totalQty > 0 ? totalSpent/totalQty : 0;
        const target = avg * (1 + (s.roi/100));

        document.getElementById('resInv').textContent = `$${totalSpent.toFixed(2)}`;
        document.getElementById('resAvg').textContent = formatPrice(avg);
        document.getElementById('resTarget').textContent = formatPrice(target);
    }

    function toggleLvl(i) {
        const s = slots[activeIdx];
        if(s.buys.includes(i)) s.buys = s.buys.filter(x => x!==i);
        else s.buys.push(i);
        save(); renderLevels();
    }

    function switchView(v, el) {
        document.getElementById('view-operar').classList.toggle('hidden', v!=='operar');
        document.getElementById('view-log').classList.toggle('hidden', v!=='log');
        document.getElementById('resPanel').classList.toggle('hidden', v!=='operar');
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        el.classList.add('active');
    }

    function unlock() { if(prompt("Pass:")==="2524") document.getElementById('configLock').classList.remove('hidden'); }

    renderSlots();
    selectSlot(0);
</script>
</body>
</html>