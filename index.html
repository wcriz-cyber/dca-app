<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DCA ETF ENGINE V17.39</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700;900&family=Roboto+Mono:wght@700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #0b0e11; --surface: #1e2329; --primary: #f0b90b;
            --success: #0ecb81; --danger: #f6465d; --text: #eaecef;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Roboto', sans-serif; }
        body { background: var(--bg); color: var(--text); padding-bottom: 50px; }

        /* SLOTS */
        .slot-bar { display: grid; grid-template-columns: repeat(5, 1fr); gap: 5px; padding: 10px; background: #000; }
        .slot-btn { background: var(--surface); border: 1px solid #333; color: #848e9c; padding: 8px 0; border-radius: 4px; font-weight: 700; font-size: 11px; cursor: pointer; }
        .slot-btn.active { border-color: var(--primary); color: var(--primary); }

        /* TIMEFRAMES */
        .tf-bar { display: flex; background: #161a1e; border-bottom: 1px solid #333; }
        .tf-btn { flex: 1; padding: 10px; border: none; background: transparent; color: #848e9c; font-size: 11px; font-weight: 700; }
        .tf-btn.active { color: var(--primary); border-bottom: 2px solid var(--primary); }

        /* CHART */
        #chart_container { width: 100%; height: 350px; background: #000; }

        /* DASHBOARD */
        .main-dash { padding: 20px; background: var(--surface); margin: 10px; border-radius: 8px; text-align: center; }
        .avg-price { font-family: 'Roboto Mono'; font-size: 32px; color: var(--primary); font-weight: 700; display: block; }
        
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px; }
        .stat-card { background: rgba(0,0,0,0.2); padding: 10px; border-radius: 5px; }
        .stat-card small { display: block; font-size: 10px; color: #848e9c; margin-bottom: 5px; }

        /* INPUTS */
        .inputs-row { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; padding: 10px; }
        .input-group { background: var(--surface); padding: 10px; border-radius: 5px; }
        .input-group label { display: block; font-size: 9px; color: var(--primary); margin-bottom: 5px; font-weight: 700; }
        .input-group input { background: transparent; border: none; color: #fff; width: 100%; font-size: 16px; font-weight: 700; outline: none; text-align: center; }

        /* LEVELS */
        .levels-list { padding: 10px; }
        .lvl-item { background: var(--surface); margin-bottom: 8px; padding: 15px; border-radius: 8px; display: flex; align-items: center; justify-content: space-between; border-left: 4px solid #333; }
        .lvl-item.active { border-left-color: var(--success); background: rgba(14, 203, 129, 0.05); }
        .lvl-info b { font-family: 'Roboto Mono'; font-size: 18px; }

        .btn-close { width: calc(100% - 20px); margin: 10px; padding: 18px; background: var(--danger); border: none; border-radius: 5px; color: #fff; font-weight: 700; font-size: 14px; }

        /* HISTORY TABLE */
        .history-section { margin: 20px 10px; background: var(--surface); border-radius: 8px; padding: 15px; }
        .history-table { width: 100%; border-collapse: collapse; font-size: 12px; }
        .history-table th { text-align: left; color: #848e9c; padding-bottom: 10px; }
        .history-table td { padding: 8px 0; border-top: 1px solid #333; }
    </style>
</head>
<body onload="init()">

    <div class="slot-bar" id="slotBar"></div>

    <div class="tf-bar">
        <button class="tf-btn" onclick="setTF('15', this)">15M</button>
        <button class="tf-btn" onclick="setTF('30', this)">30M</button>
        <button class="tf-btn active" onclick="setTF('60', this)">1H</button>
        <button class="tf-btn" onclick="setTF('240', this)">4H</button>
        <button class="tf-btn" onclick="setTF('D', this)">1D</button>
    </div>

    <div id="chart_container"></div>

    <div class="inputs-row">
        <div class="input-group"><label>MONEDA</label><input type="text" id="coinIn" onblur="updateSlot()"></div>
        <div class="input-group"><label>ENTRADA</label><input type="number" id="priceIn" oninput="calc()"></div>
        <div class="input-group"><label>CAPITAL</label><input type="number" id="capIn" oninput="calc()"></div>
    </div>

    <div class="main-dash">
        <small>AVERAGE PRICE</small>
        <span class="avg-price" id="resAvg">0.0000</span>
        <div class="stats-grid">
            <div class="stat-card"><small>INVERTIDO</small><b id="resInv">$0.00</b></div>
            <div class="stat-card"><small>TARGET (+100%)</small><b id="resTarget">0.0000</b></div>
        </div>
    </div>

    <div class="levels-list" id="levelsGrid"></div>

    <button class="btn-close" onclick="closePosition()">CERRAR OPERACIÓN Y REGISTRAR</button>

    <div class="history-section">
        <h4 style="margin-bottom:10px; color:var(--primary)">HISTORIAL DE CIERRES</h4>
        <table class="history-table">
            <thead><tr><th>Fecha</th><th>Activo</th><th>Inversión</th></tr></thead>
            <tbody id="historyBody"></tbody>
        </table>
    </div>

    <script src="https://s3.tradingview.com/tv.js"></script>
    <script>
        let currentSlot = 0;
        let timeframe = '60';
        let slots = JSON.parse(localStorage.getItem('dca_v17_slots')) || Array(5).fill(null).map((_,i)=>({
            name: i===0?'BTC3L':'', price:0, cap:10, buys:[]
        }));
        let history = JSON.parse(localStorage.getItem('dca_v17_history')) || [];

        function init() {
            renderSlots();
            renderHistory();
            loadChart();
            syncUI();
        }

        function renderSlots() {
            const bar = document.getElementById('slotBar');
            bar.innerHTML = slots.map((s, i) => `
                <button class="slot-btn ${currentSlot===i?'active':''}" onclick="changeSlot(${i})">
                    ${s.name || 'Slot '+(i+1)}
                </button>
            `).join('');
        }

        function changeSlot(i) {
            currentSlot = i;
            renderSlots();
            syncUI();
            loadChart();
        }

        function syncUI() {
            const s = slots[currentSlot];
            document.getElementById('coinIn').value = s.name;
            document.getElementById('priceIn').value = s.price || '';
            document.getElementById('capIn').value = s.cap || 10;
            calc();
        }

        function updateSlot() {
            slots[currentSlot].name = document.getElementById('coinIn').value.toUpperCase();
            save(); renderSlots(); loadChart();
        }

        function setTF(tf, btn) {
            timeframe = tf;
            document.querySelectorAll('.tf-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            loadChart();
        }

        function loadChart() {
            const coin = slots[currentSlot].name || 'BTCUSDT';
            new TradingView.widget({
                "autosize": true, "symbol": "GATEIO:" + (coin.includes('USDT')?coin:coin+'USDT'),
                "interval": timeframe, "theme": "dark", "container_id": "chart_container", "hide_top_toolbar": true
            });
        }

        function calc() {
            const s = slots[currentSlot];
            s.price = parseFloat(document.getElementById('priceIn').value) || 0;
            s.cap = parseFloat(document.getElementById('capIn').value) || 10;
            save();

            const grid = document.getElementById('levelsGrid');
            if(!s.price) { grid.innerHTML = ""; return; }

            let totalSpent = 0, totalTokens = 0, currentP = s.price;
            let html = '';

            const config = [1, 1, 1.5, 1.5, 2, 2, 2.5, 2.5, 3, 3, 3.5, 3.5, 4, 4, 5, 5];
            
            config.forEach((mult, i) => {
                if(i > 0) currentP *= 0.85; // Simulación de caída 15% para los niveles
                const active = s.buys.includes(i);
                if(active) {
                    totalSpent += (mult * s.cap);
                    totalTokens += (mult * s.cap / currentP);
                }
                html += `
                <div class="lvl-item ${active?'active':''}" onclick="toggleLvl(${i})">
                    <div class="lvl-info">
                        <small>NIVEL ${i+1} (${mult}x)</small><br>
                        <b>${currentP.toFixed(6)}</b>
                    </div>
                    <div style="font-weight:900; color:${active?'var(--success)':'#444'}">${active?'COMPRADO':'ESPERA'}</div>
                </div>`;
            });

            grid.innerHTML = html;
            const avg = totalTokens > 0 ? totalSpent / totalTokens : 0;
            document.getElementById('resAvg').innerText = avg.toFixed(6);
            document.getElementById('resInv').innerText = `$${totalSpent.toFixed(2)}`;
            document.getElementById('resTarget').innerText = (avg * 2).toFixed(6);
        }

        function toggleLvl(i) {
            const s = slots[currentSlot];
            if(s.buys.includes(i)) s.buys = s.buys.filter(x => x !== i);
            else s.buys.push(i);
            calc();
        }

        function closePosition() {
            const s = slots[currentSlot];
            if(!s.name || s.buys.length === 0) return;
            
            const record = {
                date: new Date().toLocaleDateString(),
                coin: s.name,
                total: document.getElementById('resInv').innerText
            };
            
            history.unshift(record);
            if(history.length > 10) history.pop();
            
            // Reset Slot
            s.buys = []; s.price = 0;
            save();
            localStorage.setItem('dca_v17_history', JSON.stringify(history));
            
            renderHistory();
            syncUI();
            alert("Operación cerrada y guardada en el historial.");
        }

        function renderHistory() {
            const body = document.getElementById('historyBody');
            body.innerHTML = history.map(h => `
                <tr><td>${h.date}</td><td>${h.coin}</td><td>${h.total}</td></tr>
            `).join('');
        }

        function save() { localStorage.setItem('dca_v17_slots', JSON.stringify(slots)); }
    </script>
</body>
</html>
