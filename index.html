<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>C5X - V44.5 OPTIMIZED</title>
    <meta name="theme-color" content="#0b0e11">
    
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@500;600;700;800&family=JetBrains+Mono:wght@500;700;800&family=Orbitron:wght@600;900&display=swap" rel="stylesheet">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <style>
        :root {
            --bg-main: #0b0e11;
            --bg-card: #181a20;
            --bg-input: #1e2329;
            --accent: #fcd535;
            --long: #0ecb81;
            --short: #f6465d;
            --text-primary: #eaecef;
            --text-secondary: #929aa5;
            --text-tertiary: #474d57;
            --border: rgba(255,255,255,0.05);
            --header-h: 60px;
            --tab-h: 65px;
        }

        * { margin:0; padding:0; box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
        body { 
            background: var(--bg-main); 
            color: var(--text-primary); 
            font-family: 'Rajdhani', sans-serif; 
            overflow-x: hidden; 
            height: 100vh; 
            display: flex; 
            flex-direction: column;
        }

        /* HEADER & TICKER */
        header { 
            height: var(--header-h); 
            background: rgba(11,14,17,0.95); 
            backdrop-filter: blur(10px); 
            border-bottom: 1px solid var(--border); 
            display: flex; 
            align-items: center; 
            padding: 0 15px; 
            position: sticky; 
            top: 0; 
            z-index: 100;
        }
        .ticker-container { flex:1; overflow:hidden; white-space:nowrap; margin-right:10px; }
        #tickerScroll { display:inline-block; animation: scrollTicker 30s linear infinite; }
        @keyframes scrollTicker { from { transform: translateX(100%); } to { transform: translateX(-100%); } }
        .ticker-item { display:inline-block; margin-right:20px; font-family:'JetBrains Mono'; font-size:12px; font-weight:700; }
        .up { color: var(--long); } .down { color: var(--short); }

        /* MAIN CONTENT */
        main { flex:1; overflow-y:auto; padding:15px 15px 100px; }

        /* SLOTS GRID */
        .slots-grid { display:grid; grid-template-columns: repeat(4, 1fr); gap:8px; margin-bottom:20px; }
        .slot-btn { 
            background: var(--bg-card); border: 1px solid var(--border); border-radius:10px; padding:12px 5px;
            text-align:center; transition:0.2s; position:relative; overflow:hidden;
        }
        .slot-btn.active { border-color: var(--accent); background: rgba(252,213,53,0.05); }
        .slot-btn .s-name { font-size:14px; font-weight:800; display:block; }
        .slot-btn .s-strat { font-size:9px; color:var(--text-secondary); text-transform:uppercase; margin-top:2px; }
        .slot-indicator { position:absolute; top:4px; right:4px; width:6px; height:6px; border-radius:50%; background:var(--text-tertiary); }
        .slot-indicator.on { background: var(--long); box-shadow: 0 0 5px var(--long); }

        /* CONTROL CARD */
        .control-card { background:var(--bg-card); border-radius:16px; padding:20px; margin-bottom:15px; border:1px solid var(--border); }
        .input-row { display:flex; gap:12px; margin-bottom:15px; }
        .input-group { flex:1; }
        .input-group label { display:block; font-size:11px; color:var(--text-secondary); margin-bottom:6px; font-weight:700; text-transform:uppercase; }
        .input-wrap { position:relative; background:var(--bg-input); border-radius:8px; border:1px solid var(--border); }
        .input-wrap input { 
            width:100%; background:transparent; border:none; padding:12px; color:var(--text-primary); 
            font-family:'JetBrains Mono'; font-weight:700; font-size:15px;
        }
        
        /* BOTONES ESTRATEGIA */
        .strat-toggle { display:flex; background:var(--bg-input); border-radius:10px; padding:4px; margin-bottom:15px; }
        .st-btn { flex:1; padding:10px; border:none; background:transparent; color:var(--text-secondary); font-weight:800; border-radius:8px; font-size:12px; transition:0.2s; }
        .st-btn.active { background:var(--bg-card); color:var(--accent); box-shadow: 0 2px 8px rgba(0,0,0,0.3); }

        /* UNIFIED LEVELS LIST */
        .levels-grid { display: flex; flex-direction: column; gap: 8px; }
        .unified-card {
            background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px;
            display: flex; align-items: center; padding: 12px 15px; transition: 0.2s;
        }
        .unified-card.active { border-left: 4px solid var(--long); background: rgba(14,203,129,0.05); }
        .u-index { width: 25px; font-family: 'Orbitron'; font-size: 14px; color: var(--text-tertiary); }
        .u-center { flex: 1; }
        
        /* PRECIO GRANDE COMO SOLICITADO */
        .u-title { 
            font-family: 'JetBrains Mono', monospace; 
            font-size: 20px; /* Tama침o grande */
            font-weight: 800; 
            color: var(--text-primary); 
            line-height: 1.1;
        }
        .u-sub { font-size: 10px; font-weight: 700; color: var(--text-tertiary); margin-top: 2px; }
        
        .u-right { text-align: right; }
        .u-val-primary { font-family: 'JetBrains Mono'; font-size: 14px; font-weight: 700; color: var(--accent); }
        .u-val-secondary { font-size: 11px; font-weight: 700; color: var(--text-secondary); }

        /* NAVBAR */
        nav { 
            position: fixed; bottom: 0; left: 0; right: 0; height: var(--tab-h);
            background: rgba(24,26,32,0.98); border-top: 1px solid var(--border);
            display: flex; align-items: center; justify-content: space-around; z-index: 1000;
            padding-bottom: env(safe-area-inset-bottom);
        }
        .nav-item { flex:1; text-align:center; color: var(--text-secondary); font-size:11px; font-weight:700; text-transform:uppercase; }
        .nav-item.active { color: var(--accent); }
        .nav-item svg { display:block; margin:0 auto 4px; width:22px; height:22px; }

        .res-panel { 
            position:sticky; bottom:calc(var(--tab-h) + 10px); background:var(--accent); 
            color:var(--bg-main); border-radius:12px; padding:15px; display:flex; 
            justify-content:space-between; align-items:center; font-weight:800;
            box-shadow: 0 4px 20px rgba(0,0,0,0.4); margin-top:15px;
        }
        .res-item span { display:block; font-size:10px; text-transform:uppercase; opacity:0.8; }
        .res-item div { font-family:'JetBrains Mono'; font-size:16px; }

        /* MODALES */
        .modal { 
            position:fixed; inset:0; background:rgba(0,0,0,0.9); z-index:2000; 
            display:none; align-items:center; justify-content:center; padding:20px; 
        }
        .modal-content { background:var(--bg-card); width:100%; max-width:400px; border-radius:20px; padding:25px; border:1px solid var(--border); }
        .modal-title { font-family:'Orbitron'; font-size:18px; margin-bottom:20px; text-align:center; color:var(--accent); }
        
        .btn-full { width:100%; padding:15px; border-radius:12px; border:none; font-weight:800; font-family:'Rajdhani'; font-size:16px; margin-top:10px; }
        .btn-accent { background:var(--accent); color:var(--bg-main); }
        .btn-ghost { background:transparent; color:var(--text-secondary); }

        .liquidate-card {
            background: rgba(246,70,93,0.1); border: 1px dashed var(--short);
            border-radius:12px; padding:15px; text-align:center; color:var(--short);
            font-weight:800; margin-top:10px; font-size:14px;
        }

        #view-log, #view-settings { display:none; }

    </style>
</head>
<body>

<header>
    <div class="ticker-container"><div id="tickerScroll">Cargando mercados...</div></div>
    <div style="font-family:'Orbitron'; font-size:18px; font-weight:900; color:var(--accent);">C5X</div>
</header>

<main>
    <section id="view-operar">
        <div class="slots-grid" id="slotsGrid"></div>

        <div class="control-card">
            <div class="input-row">
                <div class="input-group">
                    <label>Activo ETF</label>
                    <div class="input-wrap"><input type="text" id="coinInput" placeholder="BTC3L" oninput="updateSlot()"></div>
                </div>
                <div class="input-group">
                    <label>Precio Base</label>
                    <div class="input-wrap"><input type="number" id="priceInput" step="0.000001" placeholder="0.00" oninput="updateSlot()"></div>
                </div>
            </div>

            <div class="strat-toggle">
                <button class="st-btn active" id="btnNormal" onclick="setStrat('normal')">NORMAL</button>
                <button class="st-btn" id="btnAgg" onclick="setStrat('aggressive')">AGRESIVA</button>
            </div>

            <div class="input-row">
                <div class="input-group">
                    <label>Capital Nivel 1</label>
                    <div class="input-wrap"><input type="number" id="capInput" value="10" oninput="updateSlot()"></div>
                </div>
                <div class="input-group">
                    <label>ROI %</label>
                    <div class="input-wrap"><input type="number" id="roiInput" value="50" oninput="updateSlot()"></div>
                </div>
            </div>
            
            <div id="extraInputs" style="display:none; gap:12px; margin-top:10px;">
                <div class="input-group">
                    <label>Ca칤da Escalonada %</label>
                    <div class="input-wrap"><input type="number" id="incInput" value="7" oninput="updateSlot()"></div>
                </div>
                <div class="input-group">
                    <label>Ca칤da Fija (Agr) %</label>
                    <div class="input-wrap"><input type="number" id="descInput" value="66" oninput="updateSlot()"></div>
                </div>
            </div>
            <button class="btn-ghost" style="font-size:10px; width:100%;" onclick="toggleSettingsLock()">游 EDITAR ESTRATEGIA</button>
        </div>

        <div class="levels-grid" id="levelsGrid"></div>

        <div class="res-panel">
            <div class="res-item"><span>Inversi칩n</span><div id="resInv">$0.00</div></div>
            <div class="res-item"><span>AVG Buy</span><div id="resAvg">0.00</div></div>
            <div class="res-item"><span>Target</span><div id="resTarget">0.00</div></div>
        </div>
    </section>

    <section id="view-log">
        <div class="control-card">
            <h3 style="margin-bottom:15px; font-family:'Orbitron';">HISTORIAL DE CIERRES</h3>
            <div id="logContent"></div>
            <button class="btn-full btn-accent" onclick="exportToExcel()">EXPORTAR EXCEL</button>
        </div>
    </section>

    <section id="view-settings">
        <div class="control-card">
            <h3 style="margin-bottom:15px;">CONFIGURACI칍N GLOBAL</h3>
            <label style="font-size:11px;">Capital Total App</label>
            <div class="input-wrap" style="margin-bottom:15px;">
                <input type="number" id="globalCapInput" onchange="updateGlobalCap()">
            </div>
            <button class="btn-full btn-ghost" onclick="exportData()">RESPALDO GOOGLE DRIVE (JSON)</button>
        </div>
    </section>
</main>

<nav>
    <div class="nav-item active" onclick="switchView('operar', this)">
        <svg viewBox="0 0 24 24" fill="currentColor"><path d="M21 16.5C21 16.88 20.79 17.21 20.47 17.38L12.57 21.82C12.41 21.94 12.21 22 12 22C11.79 22 11.59 21.94 11.43 21.82L3.53 17.38C3.21 17.21 3 16.88 3 16.5V7.5C3 7.12 3.21 6.79 3.53 6.62L11.43 2.18C11.59 2.06 11.79 2 12 2C12.21 2 12.41 2.06 12.57 2.18L20.47 6.62C20.79 6.79 21 7.12 21 7.5V16.5Z"/></svg>
        Operar
    </div>
    <div class="nav-item" onclick="switchView('log', this)">
        <svg viewBox="0 0 24 24" fill="currentColor"><path d="M14 2H6C4.9 2 4 2.9 4 4V20C4 21.1 4.9 22 6 22H18C19.1 22 20 21.1 20 20V8L14 2M18 20H6V4H13V9H18V20Z"/></svg>
        Bit치cora
    </div>
    <div class="nav-item" onclick="switchView('settings', this)">
        <svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 15.5C13.93 15.5 15.5 13.93 15.5 12C15.5 10.07 13.93 8.5 12 8.5C10.07 8.5 8.5 10.07 8.5 12C8.5 13.93 10.07 15.5 12 15.5M19.43 12.98C19.47 12.66 19.5 12.34 19.5 12C19.5 11.66 19.47 11.34 19.43 11.02L21.54 9.37C21.73 9.22 21.78 8.95 21.66 8.73L19.66 5.27C19.54 5.05 19.27 4.97 19.05 5.05L16.56 6.05C16.04 5.65 15.48 5.32 14.87 5.07L14.49 2.42C14.46 2.18 14.25 2 14 2H10C9.75 2 9.54 2.18 9.51 2.42L9.13 5.07C8.52 5.32 7.96 5.66 7.44 6.05L4.95 5.05C4.73 4.97 4.46 5.05 4.34 5.27L2.34 8.73C2.21 8.95 2.27 9.22 2.46 9.37L4.57 11.02C4.53 11.34 4.5 11.66 4.5 12C4.5 12.34 4.53 12.66 4.57 12.98L2.46 14.63C2.27 14.78 2.22 15.05 2.34 15.27L4.34 18.73C4.46 18.95 4.73 19.03 4.95 18.95L7.44 17.95C7.96 18.35 8.52 18.68 9.13 18.93L9.51 21.58C9.54 21.82 9.75 22 10 22H14C14.25 22 14.46 21.82 14.49 21.58L14.87 18.93C15.48 18.67 16.04 18.34 16.56 17.95L19.05 18.95C19.27 19.03 19.54 18.95 19.66 18.73L21.66 15.27C21.78 15.05 21.73 14.78 21.54 14.63L19.43 12.98Z"/></svg>
        Ajustes
    </div>
</nav>

<div class="modal" id="modalLiquidate">
    <div class="modal-content">
        <div class="modal-title">CERRAR OPERACI칍N</div>
        <p style="text-align:center; color:var(--text-secondary); margin-bottom:20px;">쮻eseas guardar este cierre en la bit치cora?</p>
        <button class="btn-full btn-accent" onclick="confirmLiquidate(true)">S칈, GUARDAR Y LIMPIAR</button>
        <button class="btn-full btn-ghost" onclick="confirmLiquidate(false)">SOLO LIMPIAR SLOT</button>
        <button class="btn-full btn-ghost" onclick="closeModal()">CANCELAR</button>
    </div>
</div>

<script>
    // --- ESTADO INICIAL ---
    let slots = JSON.parse(localStorage.getItem('c5x_slots')) || Array(8).fill().map((_,i)=>({
        id: i, name: '', price: 0, capital: 10, roi: 50, strat: 'normal', buys: [0]
    }));
    let activeIdx = 0;
    let history = JSON.parse(localStorage.getItem('c5x_history')) || [];
    let customMultipliers = JSON.parse(localStorage.getItem('c5x_multipliers')) || [1, 1, 2, 4, 8, 16, 32, 64, 128, 256, 512, 1024];
    let globalCapital = localStorage.getItem('c5x_global_capital') || 5000;

    // --- TICKER LOGIC ---
    async function updateTicker() {
        try {
            const resp = await fetch('https://api.gateio.ws/api/v4/spot/tickers');
            const data = await resp.json();
            const relevant = ['BTC_USDT', 'ETH_USDT', 'AVAX_USDT', 'SOL_USDT', 'LTC_USDT'];
            const filtered = data.filter(t => relevant.includes(t.currency_pair));
            
            document.getElementById('tickerScroll').innerHTML = filtered.map(t => {
                const change = parseFloat(t.change_percentage);
                return `<span class="ticker-item">${t.currency_pair.replace('_','/')} <span class="${change>=0?'up':'down'}">${parseFloat(t.last).toFixed(2)} (${change>=0?'+':''}${change.toFixed(2)}%)</span></span>`;
            }).join('');
        } catch(e) { console.error("Ticker Error", e); }
    }
    setInterval(updateTicker, 10000); updateTicker();

    // --- RENDER SLOTS ---
    function renderSlots() {
        const grid = document.getElementById('slotsGrid');
        grid.innerHTML = slots.map((s, i) => `
            <div class="slot-btn ${i === activeIdx ? 'active' : ''}" onclick="selectSlot(${i})">
                <div class="slot-indicator ${s.buys.length > 0 && s.name ? 'on' : ''}"></div>
                <span class="s-name">${s.name || 'Slot '+(i+1)}</span>
                <span class="s-strat">${s.strat}</span>
            </div>
        `).join('');
    }

    function selectSlot(idx) {
        activeIdx = idx;
        const s = slots[idx];
        document.getElementById('coinInput').value = s.name;
        document.getElementById('priceInput').value = s.price || '';
        document.getElementById('capInput').value = s.capital;
        document.getElementById('roiInput').value = s.roi;
        setStrat(s.strat, false);
        renderSlots();
        renderLevels();
    }

    function updateSlot() {
        const s = slots[activeIdx];
        s.name = document.getElementById('coinInput').value.toUpperCase();
        s.price = parseFloat(document.getElementById('priceInput').value) || 0;
        s.capital = parseFloat(document.getElementById('capInput').value) || 10;
        s.roi = parseFloat(document.getElementById('roiInput').value) || 50;
        save();
        renderSlots();
        renderLevels();
    }

    function setStrat(type, update = true) {
        slots[activeIdx].strat = type;
        document.getElementById('btnNormal').classList.toggle('active', type === 'normal');
        document.getElementById('btnAgg').classList.toggle('active', type === 'aggressive');
        if(update) { save(); renderSlots(); renderLevels(); }
    }

    // --- L칍GICA DE NIVELES (V44.5 CORREGIDA) ---
    function renderLevels() { 
        const grid = document.getElementById('levelsGrid');
        const s = slots[activeIdx];
        const descPct = parseFloat(document.getElementById('descInput').value) || 66; 
        const incPct = parseFloat(document.getElementById('incInput').value) || 7; 
        
        if(!s.price || s.price <= 0) { 
            grid.innerHTML = '<div style="text-align:center; padding:20px; color:var(--text-secondary)">Ingresa activo y precio base</div>'; 
            return; 
        } 
        
        let totalSpent = 0, totalQty = 0, lastPrice = s.price, currentStepDrop = 0, html = ''; 
        const maxLevels = 12; 
        
        for(let i=0; i < maxLevels; i++){ 
            let pLevel; 
            
            // Estrategia de ca칤da (No modificada)
            if(i === 0) { 
                pLevel = s.price; 
                currentStepDrop = 0; 
            } else { 
                if(s.strat === "normal") { 
                    if(i === 1) currentStepDrop = 17; 
                    else currentStepDrop += incPct; 
                } else { 
                    currentStepDrop = descPct; 
                } 
                pLevel = lastPrice * (1 - (currentStepDrop / 100)); 
            } 

            const mUSD = (customMultipliers[i] || 1) * s.capital;
            const on = s.buys.includes(i); 
            if(on) { totalSpent += mUSD; totalQty += (mUSD/pLevel); } 

            // Formateo din치mico para evitar ceros
            let displayPrice;
            if (pLevel < 0.000001) displayPrice = pLevel.toFixed(10);
            else if (pLevel < 1) displayPrice = pLevel.toFixed(6);
            else displayPrice = pLevel.toFixed(4);

            // Renderizado: Se quit칩 la palabra "Nivel" y se aplic칩 clase u-title (20px)
            html += `<div class="unified-card ${on ? 'active' : ''}" onclick="toggleLvl(${i})">
                        <div class="u-index">${i+1}</div>
                        <div class="u-center">
                            <div class="u-title">${displayPrice}</div>
                            <div class="u-sub">${i===0 ? 'ENTRADA' : ''}</div>
                        </div>
                        <div class="u-right">
                            <div class="u-val-primary">$${mUSD.toFixed(1)}</div>
                            <div class="u-val-secondary" style="${i>0?'color:var(--short)':''}">${i===0 ? '---' : '-'+currentStepDrop.toFixed(1)+'%'}</div>
                        </div>
                    </div>`; 
            
            lastPrice = pLevel; 
        } 
        
        grid.innerHTML = html; 
        
        const avg = totalQty > 0 ? totalSpent/totalQty : 0; 
        const targetPrice = avg * (1 + (s.roi / 100)); 
        
        document.getElementById('resInv').textContent = `$${totalSpent.toFixed(2)}`; 
        document.getElementById('resAvg').textContent = avg < 1 ? avg.toFixed(6) : avg.toFixed(4); 
        document.getElementById('resTarget').textContent = targetPrice < 1 ? targetPrice.toFixed(6) : targetPrice.toFixed(4); 
    }

    function toggleLvl(idx) {
        const s = slots[activeIdx];
        if(s.buys.includes(idx)) s.buys = s.buys.filter(n => n !== idx);
        else s.buys.push(idx);
        save(); renderLevels(); renderSlots();
    }

    // --- LIQUIDACI칍N Y BIT츼CORA ---
    function openLiquidateConfirm() { document.getElementById('modalLiquidate').style.display = 'flex'; }
    function closeModal() { document.getElementById('modalLiquidate').style.display = 'none'; }

    function confirmLiquidate(saveInLog) {
        const s = slots[activeIdx];
        if(saveInLog) {
            const inv = parseFloat(document.getElementById('resInv').textContent.replace('$',''));
            const logEntry = {
                date: new Date().toLocaleString(),
                coin: s.name,
                investment: inv,
                profit: inv * (s.roi/100),
                strat: s.strat
            };
            history.unshift(logEntry);
            localStorage.setItem('c5x_history', JSON.stringify(history));
            renderLog();
        }
        // Limpiar slot
        s.name = ''; s.price = 0; s.buys = [0];
        document.getElementById('coinInput').value = '';
        document.getElementById('priceInput').value = '';
        save(); renderSlots(); renderLevels(); closeModal();
    }

    function renderLog() {
        const container = document.getElementById('logContent');
        if(history.length === 0) { container.innerHTML = '<p style="color:var(--text-tertiary)">No hay cierres registrados.</p>'; return; }
        container.innerHTML = history.map(h => `
            <div style="padding:10px; border-bottom:1px solid var(--border); font-size:13px;">
                <div style="display:flex; justify-content:space-between;">
                    <b style="color:var(--accent)">${h.coin}</b>
                    <span style="color:var(--long)">+$${h.profit.toFixed(2)}</span>
                </div>
                <div style="color:var(--text-secondary); font-size:10px;">${h.date} | Inv: $${h.investment.toFixed(2)}</div>
            </div>
        `).join('');
    }

    // --- UTILIDADES ---
    function save() { localStorage.setItem('c5x_slots', JSON.stringify(slots)); }

    function switchView(view, el) {
        ['view-operar', 'view-log', 'view-settings'].forEach(v => document.getElementById(v).style.display = 'none');
        document.getElementById('view-'+view).style.display = 'block';
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        el.classList.add('active');
        if(view === 'log') renderLog();
    }

    function toggleSettingsLock() {
        const pass = prompt("Clave de configuraci칩n:");
        if(pass === "2524") {
            document.getElementById('extraInputs').style.display = 'flex';
        } else {
            alert("Clave incorrecta");
        }
    }

    function exportToExcel() {
        const ws = XLSX.utils.json_to_sheet(history);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Cierres");
        XLSX.writeFile(wb, "Bitacora_C5X.xlsx");
    }

    // Inicializar
    renderSlots();
    selectSlot(0);
</script>
</body>
</html>