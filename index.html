<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>C5X DCA ENGINE V20.5</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@600;900&family=Roboto:wght@400;700&family=Roboto+Mono:wght@700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --bg: #050708; --surface: #12151a; --text: #f0f2f5; 
            --border: #2d3339; --header-bg: #12151a;
            --dir-color: #3498db; --long-green: #0ecb81; --short-red: #f6465d;
            --accent: #f3ba2f;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { 
            margin: 0; background: var(--bg); color: var(--text); 
            font-family: 'Roboto', sans-serif; overflow-x: hidden;
            padding-bottom: 80px;
        }
        header { 
            background: var(--header-bg); padding: 15px; text-align: center;
            border-bottom: 1px solid var(--border); position: sticky; top: 0; z-index: 100;
        }
        .logo { font-family: 'Orbitron', sans-serif; font-size: 1.2rem; color: var(--accent); letter-spacing: 2px; }
        
        .main-container { padding: 10px; max-width: 600px; margin: auto; }
        
        .card { 
            background: var(--surface); border-radius: 12px; padding: 15px; 
            margin-bottom: 15px; border: 1px solid var(--border);
        }

        .input-group { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        input { 
            background: #1e222d; border: 1px solid var(--border); color: white;
            padding: 12px; border-radius: 8px; font-size: 1rem; width: 100%;
        }

        .level-row {
            display: grid; grid-template-columns: 40px 1fr 80px 40px;
            align-items: center; padding: 10px; border-bottom: 1px solid #1e222d;
            font-family: 'Roboto Mono', monospace; font-size: 0.9rem;
        }
        .level-row.active { background: rgba(14, 203, 129, 0.1); border-left: 3px solid var(--long-green); }
        
        .btn { 
            border: none; border-radius: 8px; padding: 10px; font-weight: bold; 
            cursor: pointer; text-transform: uppercase; font-size: 0.8rem;
        }
        .btn-buy { background: var(--long-green); color: black; }
        .btn-clear { background: var(--short-red); color: white; width: 100%; margin-top: 10px; }
        .btn-history { background: var(--dir-color); color: white; margin-bottom: 10px; width: 100%; }

        .stat-box { display: flex; justify-content: space-between; margin-top: 10px; font-size: 0.85rem; color: #848e9c; }
        .stat-val { color: var(--text); font-weight: bold; }

        #history-table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 0.8rem; }
        #history-table th, #history-table td { padding: 8px; border-bottom: 1px solid var(--border); text-align: left; }
        .win { color: var(--long-green); }
    </style>
</head>
<body>

<header>
    <div class="logo">C5X DCA V20.5</div>
</header>

<div class="main-container">
    <div class="card">
        <div class="input-group">
            <div>
                <label style="font-size: 0.7rem;">MONEDA</label>
                <input type="text" id="coin" value="BTC3L" oninput="calculate()">
            </div>
            <div>
                <label style="font-size: 0.7rem;">PRECIO ENTRADA</label>
                <input type="number" id="entryPrice" value="1.00" step="0.0001" oninput="calculate()">
            </div>
        </div>
        <div class="input-group">
            <div>
                <label style="font-size: 0.7rem;">CAPITAL BASE $</label>
                <input type="number" id="baseCap" value="5.00" oninput="calculate()">
            </div>
            <div style="display: flex; align-items: flex-end;">
                <button class="btn btn-clear" onclick="resetSlots()">RESET</button>
            </div>
        </div>
    </div>

    <div id="levels-container" class="card" style="padding: 5px;">
        </div>

    <div class="card">
        <button class="btn btn-history" onclick="toggleHistory()">VER HISTORIAL CERRADOS</button>
        <div id="history-section" style="display: none;">
            <table id="history-table">
                <thead>
                    <tr>
                        <th>Fecha</th>
                        <th>Par</th>
                        <th>Invertido</th>
                        <th>Profit</th>
                    </tr>
                </thead>
                <tbody id="history-body"></tbody>
            </table>
            <button class="btn btn-clear" onclick="clearHistory()" style="font-size: 0.6rem;">BORRAR HISTORIAL</button>
        </div>
    </div>
</div>

<script>
    // ESTRATEGIA ACTUALIZADA: Base 10% + Incremento de 7% por nivel
    const strategy = [
        { d: 0.00, m: 1.0, g: 0.50 }, // Base
        { d: 0.10, m: 1.0, g: 0.50 }, // Nivel 1
        { d: 0.17, m: 1.5, g: 0.60 }, // Nivel 2 (+7%)
        { d: 0.24, m: 1.5, g: 0.70 }, // Nivel 3 (+7%)
        { d: 0.31, m: 2.0, g: 0.80 }, // Nivel 4 (+7%)
        { d: 0.38, m: 2.0, g: 1.00 }, // Nivel 5 (+7%)
        { d: 0.45, m: 4.0, g: 1.20 }, // Nivel 6 (+7%)
        { d: 0.52, m: 4.0, g: 1.50 }, // Nivel 7 (+7%)
        { d: 0.59, m: 8.0, g: 1.80 }, // Nivel 8 (+7%)
        { d: 0.66, m: 8.0, g: 2.00 }, // Nivel 9 (+7%)
        { d: 0.73, m: 16.0, g: 2.00 }, // Nivel 10 (+7%)
        { d: 0.80, m: 16.0, g: 2.00 }  // Nivel 11 (+7%)
    ];

    let activeBuys = JSON.parse(localStorage.getItem('c5x_buys')) || [0];
    let closedOps = JSON.parse(localStorage.getItem('c5x_history')) || [];

    function calculate() {
        const entry = parseFloat(document.getElementById('entryPrice').value) || 0;
        const base = parseFloat(document.getElementById('baseCap').value) || 0;
        const container = document.getElementById('levels-container');
        container.innerHTML = '';

        let totalInv = 0;
        let totalQty = 0;
        let lastPrice = entry;

        strategy.forEach((lvl, i) => {
            // Precio cae respecto al anterior
            const buyPrice = i === 0 ? entry : lastPrice * (1 - lvl.d);
            lastPrice = buyPrice;

            const cost = base * lvl.m;
            const qty = cost / buyPrice;
            const isActive = activeBuys.includes(i);

            if (isActive) {
                totalInv += cost;
                totalQty += qty;
            }

            const avg = totalQty > 0 ? totalInv / totalQty : 0;
            const target = avg * (1 + lvl.g);

            const row = document.createElement('div');
            row.className = `level-row ${isActive ? 'active' : ''}`;
            row.innerHTML = `
                <div style="color: #848e9c">L${i}</div>
                <div>
                    <div style="color: var(--accent)">$${buyPrice.toFixed(4)}</div>
                    <div style="font-size: 0.7rem; color: #5e6673">M: ${lvl.m}x | Cost: $${cost.toFixed(2)}</div>
                </div>
                <div style="text-align: right;">
                    <div class="win">T: $${target.toFixed(4)}</div>
                    <div style="font-size: 0.7rem; color: #5e6673">Avg: ${avg.toFixed(4)}</div>
                </div>
                <button class="btn-buy" style="border:none; border-radius:4px; margin-left:10px" onclick="toggleLvl(${i})">${isActive ? '✔' : '+'}</button>
            `;
            container.appendChild(row);
        });

        save();
        renderHistory();
    }

    function toggleLvl(i) {
        if (activeBuys.includes(i)) {
            // Si es el último nivel comprado, al quitarlo preguntamos si se cerró la operación
            if (i === Math.max(...activeBuys) && i > 0) {
                if (confirm("¿Cerrar operación y guardar en historial?")) {
                    saveToHistory();
                }
            }
            activeBuys = activeBuys.filter(x => x !== i);
        } else {
            activeBuys.push(i);
        }
        calculate();
    }

    function saveToHistory() {
        const coin = document.getElementById('coin').value;
        const base = parseFloat(document.getElementById('baseCap').value);
        let total = 0;
        activeBuys.forEach(idx => total += (base * strategy[idx].m));
        
        const op = {
            date: new Date().toLocaleDateString(),
            coin: coin,
            total: total.toFixed(2),
            profit: "SUCCESS"
        };
        closedOps.unshift(op);
        localStorage.setItem('c5x_history', JSON.stringify(closedOps));
    }

    function renderHistory() {
        const body = document.getElementById('history-body');
        body.innerHTML = closedOps.map(op => `
            <tr>
                <td>${op.date}</td>
                <td>${op.coin}</td>
                <td>$${op.total}</td>
                <td class="win">${op.profit}</td>
            </tr>
        `).join('');
    }

    function toggleHistory() {
        const sec = document.getElementById('history-section');
        sec.style.display = sec.style.display === 'none' ? 'block' : 'none';
    }

    function clearHistory() {
        if(confirm("¿Borrar todo el historial?")) {
            closedOps = [];
            localStorage.setItem('c5x_history', JSON.stringify(closedOps));
            renderHistory();
        }
    }

    function resetSlots() {
        activeBuys = [0];
        calculate();
    }

    function save() {
        localStorage.setItem('c5x_buys', JSON.stringify(activeBuys));
    }

    // Inicializar
    calculate();
</script>

</body>
</html>
