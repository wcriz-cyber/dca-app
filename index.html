<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>C5X ULTIMATE V19</title>
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon.png">
    <meta name="theme-color" content="#050708">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700;900&family=Roboto+Mono:wght@700&family=Inter:wght@400;700;900&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --bg: #050708; --card: #12151a; --border: #2d3339;
            --accent: #3498db; --green: #0ecb81; --red: #f6465d;
            --text: #f0f2f5; --text-dim: #848e9c;
            --dynamic: var(--accent); /* Cambia según L o S */
        }
        body.mode-long { --dynamic: var(--green); }
        body.mode-short { --dynamic: var(--red); }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
        body { background: var(--bg); color: var(--text); height: 100vh; display: flex; flex-direction: column; overflow: hidden; }

        header { padding: 10px 15px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; background: var(--card); }
        .logo { font-family: 'Orbitron', sans-serif; color: var(--dynamic); font-size: 18px; transition: 0.3s; }
        #btcPrice { font-family: 'Roboto Mono'; font-weight: 700; font-size: 14px; }

        .slots-bar { display: flex; overflow-x: auto; padding: 8px; gap: 6px; background: #0a0c0f; border-bottom: 1px solid var(--border); }
        .slot { padding: 6px 12px; border-radius: 4px; background: var(--card); border: 1px solid var(--border); font-size: 10px; font-weight: 900; color: var(--text-dim); cursor: pointer; white-space: nowrap; }
        .slot.active { border-color: var(--dynamic); color: var(--dynamic); background: rgba(255,255,255,0.05); }

        /* Gráfico */
        #chart-container { height: 200px; width: 100%; border-bottom: 1px solid var(--border); display: block; position: relative; }
        #chart-container.hidden { display: none; }
        .toggle-chart { position: absolute; bottom: 5px; right: 5px; z-index: 100; background: var(--card); border: 1px solid var(--border); color: white; padding: 4px 8px; font-size: 9px; border-radius: 4px; cursor: pointer; }

        main { flex: 1; overflow-y: auto; padding: 12px; display: flex; flex-direction: column; gap: 10px; }
        
        .card-inputs { background: var(--card); padding: 12px; border-radius: 10px; border: 1px solid var(--border); display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
        .input-box label { display: block; font-size: 9px; color: var(--text-dim); text-transform: uppercase; margin-bottom: 3px; font-weight: 700; }
        .input-box input { width: 100%; background: #000; border: 1px solid var(--border); color: #fff; padding: 8px; border-radius: 5px; font-family: 'Roboto Mono'; font-size: 14px; outline: none; }
        .input-box input:focus { border-color: var(--dynamic); }

        /* Niveles */
        .levels-grid { display: flex; flex-direction: column; gap: 4px; }
        .level-card { 
            background: var(--card); padding: 10px 12px; border-radius: 6px; 
            display: flex; justify-content: space-between; align-items: center;
            border-left: 4px solid var(--border); transition: 0.2s;
        }
        .level-card.active { border-left-color: var(--dynamic); background: #1a1e26; }
        .lvl-p { font-family: 'Roboto Mono'; font-size: 14px; font-weight: 700; }
        .lvl-cap { font-size: 11px; color: var(--text-dim); }
        .check { width: 24px; height: 24px; border-radius: 50%; border: 2px solid var(--border); display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 12px; }
        .check.on { background: var(--dynamic); border-color: var(--dynamic); color: #000; font-weight: 900; }

        /* Footer */
        .summary { background: var(--card); padding: 15px; border-top: 2px solid var(--dynamic); display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .sum-val { font-family: 'Roboto Mono'; font-size: 18px; font-weight: 900; display: block; }
        .sum-label { font-size: 10px; color: var(--text-dim); }

        .actions { padding: 10px; display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; background: #0a0c0f; }
        .btn { padding: 10px; border-radius: 6px; border: none; font-weight: 900; font-size: 10px; cursor: pointer; text-transform: uppercase; color: white; }
        .btn-reset { background: #34495e; }
        .btn-close { background: var(--red); }
        .btn-save { background: var(--green); }

        /* Historial */
        .hist-title { font-size: 11px; font-weight: 900; margin-top: 15px; color: var(--dynamic); }
        .hist-item { background: #1a1e26; padding: 8px; border-radius: 4px; font-size: 11px; margin-top: 5px; border-left: 2px solid var(--text-dim); }

        #toast { position: fixed; bottom: 80px; left: 50%; transform: translateX(-50%); background: var(--dynamic); color: #000; padding: 6px 15px; border-radius: 20px; font-size: 11px; font-weight: 900; opacity: 0; transition: 0.3s; z-index: 1000; }
    </style>
</head>
<body class="mode-long">

    <header>
        <div class="logo">C5X ULTIMATE</div>
        <div id="btcPrice">BTC $--.---</div>
    </header>

    <div class="slots-bar" id="slotsBar"></div>

    <div id="chart-container">
        <button class="toggle-chart" onclick="toggleChart()">Ocultar Gráfico</button>
        <div id="tv_chart" style="height: 100%;"></div>
    </div>

    <main>
        <div class="card-inputs">
            <div class="input-box">
                <label>Activo</label>
                <input type="text" id="coinName" placeholder="BTC3L" oninput="updateUI()">
            </div>
            <div class="input-box">
                <label>Precio Base</label>
                <input type="number" id="basePrice" inputmode="decimal" placeholder="0.0000" oninput="calc()">
            </div>
            <div class="input-box">
                <label>Capital ($)</label>
                <input type="number" id="baseCap" inputmode="decimal" placeholder="10.00" oninput="calc()">
            </div>
            <div class="input-box">
                <label>% Caída</label>
                <input type="number" id="dropPct" inputmode="decimal" placeholder="5.0" oninput="calc()">
            </div>
        </div>

        <div class="levels-grid" id="levels"></div>

        <div class="hist-title">REGISTRO DE CIERRES</div>
        <div id="historyList"></div>
    </main>

    <div class="summary">
        <div>
            <span class="sum-label">INVERSIÓN TOTAL</span>
            <span class="sum-val" id="totalInv">$0.00</span>
        </div>
        <div style="text-align: right;">
            <span class="sum-label">PRECIO PROMEDIO</span>
            <span class="sum-val" id="avgPrice" style="color: var(--dynamic)">$0.00</span>
        </div>
    </div>

    <div class="actions">
        <button class="btn btn-reset" onclick="resetSlot()">Reset</button>
        <button class="btn btn-close" onclick="closeOp()">Cerrar</button>
        <button class="btn btn-save" style="background: var(--dynamic)" onclick="exportJSON()">Backup</button>
    </div>

    <div id="toast">Copiado</div>

    <script src="https://s3.tradingview.com/tv.js"></script>
    <script>
        let slots = JSON.parse(localStorage.getItem('c5x_v19_slots')) || Array.from({length:10}, () => ({
            name: 'BTC3L', basePrice: '', baseCap: '10', dropPct: '5', buys: []
        }));
        let history = JSON.parse(localStorage.getItem('c5x_v19_history')) || [];
        let activeIdx = 0;

        function init() {
            renderSlots();
            loadSlot(0);
            renderHistory();
            connectTicker();
        }

        function loadSlot(idx) {
            activeIdx = idx;
            const s = slots[idx];
            document.getElementById('coinName').value = s.name;
            document.getElementById('basePrice').value = s.basePrice;
            document.getElementById('baseCap').value = s.baseCap;
            document.getElementById('dropPct').value = s.dropPct;
            updateUI();
        }

        function updateUI() {
            const coin = document.getElementById('coinName').value.toUpperCase();
            slots[activeIdx].name = coin;
            
            // Cambio de color según L o S
            document.body.className = '';
            if(coin.endsWith('L')) document.body.classList.add('mode-long');
            else if(coin.endsWith('S')) document.body.classList.add('mode-short');
            
            renderSlots();
            loadChart(coin);
            calc();
        }

        function calc() {
            const s = slots[activeIdx];
            s.basePrice = document.getElementById('basePrice').value;
            s.baseCap = document.getElementById('baseCap').value;
            s.dropPct = document.getElementById('dropPct').value;

            const bp = parseFloat(s.basePrice) || 0;
            const bc = parseFloat(s.baseCap) || 0;
            const dp = parseFloat(s.dropPct) || 0;

            const container = document.getElementById('levels');
            container.innerHTML = '';
            let tInv = 0, tTokens = 0;

            for(let i=0; i<12; i++) {
                const p = i === 0 ? bp : bp * (1 - (dp * i / 100));
                const c = bc * Math.pow(1.5, i); // Factor de escala para 12 niveles
                const isOn = s.buys.includes(i);

                if(isOn && bp > 0) { tInv += c; tTokens += (c/p); }

                if(bp > 0) {
                    const div = document.createElement('div');
                    div.className = `level-card ${isOn ? 'active' : ''}`;
                    div.innerHTML = `
                        <div>
                            <span style="font-size:8px; color:var(--text-dim)">NIVEL ${i}</span>
                            <div class="lvl-p" onclick="copy('${p.toFixed(5)}')">${p.toFixed(5)}</div>
                        </div>
                        <div class="lvl-cap">$${c.toFixed(2)}</div>
                        <div class="check ${isOn ? 'on' : ''}" onclick="toggleLvl(${i})">${isOn ? '✓' : ''}</div>
                    `;
                    container.appendChild(div);
                }
            }
            document.getElementById('totalInv').textContent = `$${tInv.toFixed(2)}`;
            document.getElementById('avgPrice').textContent = `$${(tTokens > 0 ? tInv/tTokens : 0).toFixed(5)}`;
            save();
        }

        function toggleLvl(i) {
            const b = slots[activeIdx].buys;
            slots[activeIdx].buys = b.includes(i) ? b.filter(x => x !== i) : [...b, i];
            calc();
        }

        function loadChart(coin) {
            const sym = `GATEIO:${coin.replace('3L','').replace('3S','')}USDT`;
            new TradingView.widget({
                "autosize": true, "symbol": sym, "interval": "15", "theme": "dark",
                "style": "1", "container_id": "tv_chart", "hide_top_toolbar": true, "backgroundColor": "#050708"
            });
        }

        function toggleChart() {
            const c = document.getElementById('chart-container');
            c.classList.toggle('hidden');
            event.target.textContent = c.classList.contains('hidden') ? 'Mostrar Gráfico' : 'Ocultar Gráfico';
        }

        function renderSlots() {
            const bar = document.getElementById('slotsBar');
            bar.innerHTML = slots.map((s, i) => `<div class="slot ${i === activeIdx ? 'active' : ''}" onclick="loadSlot(${i})">${s.name || 'S'+(i+1)}</div>`).join('');
        }

        function closeOp() {
            if(!confirm('¿Cerrar operación y guardar en historial?')) return;
            const s = slots[activeIdx];
            history.unshift({
                coin: s.name, 
                date: new Date().toLocaleDateString(), 
                total: document.getElementById('totalInv').textContent,
                avg: document.getElementById('avgPrice').textContent
            });
            if(history.length > 10) history.pop();
            localStorage.setItem('c5x_v19_history', JSON.stringify(history));
            resetSlot();
            renderHistory();
        }

        function renderHistory() {
            document.getElementById('historyList').innerHTML = history.map(h => `
                <div class="hist-item"><strong>${h.coin}</strong> | ${h.date} | Inv: ${h.total} | AVG: ${h.avg}</div>
            `).join('');
        }

        function resetSlot() {
            slots[activeIdx] = { name: 'BTC3L', basePrice: '', baseCap: '10', dropPct: '5', buys: [] };
            loadSlot(activeIdx);
        }

        function save() { localStorage.setItem('c5x_v19_slots', JSON.stringify(slots)); }

        function copy(v) {
            navigator.clipboard.writeText(v);
            const t = document.getElementById('toast');
            t.style.opacity = 1; setTimeout(() => t.style.opacity = 0, 1500);
        }

        function connectTicker() {
            const ws = new WebSocket('wss://stream.binance.com:9443/ws/btcusdt@ticker');
            ws.onmessage = (e) => {
                const data = JSON.parse(e.data);
                document.getElementById('btcPrice').textContent = `BTC $${parseFloat(data.c).toLocaleString()}`;
            };
        }

        function exportJSON() {
            const data = JSON.stringify({slots, history});
            const blob = new Blob([data], {type: 'application/json'});
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = 'C5X_V19_Backup.json';
            a.click();
        }

        window.onload = init;
    </script>
</body>
</html>
